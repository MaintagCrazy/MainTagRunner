<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Mogul Runner</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#080c14;--surface:rgba(16,20,30,.85);--surface-solid:#10141e;
  --card:rgba(22,28,40,.9);--card-hover:rgba(30,38,55,.95);
  --border:rgba(255,255,255,.08);--border-light:rgba(255,255,255,.12);
  --gold:#f0c040;--gold-soft:rgba(240,192,64,.15);--gold-glow:rgba(240,192,64,.3);
  --green:#34d399;--green-soft:rgba(52,211,153,.12);
  --red:#f87171;--purple:#a78bfa;--purple-soft:rgba(167,139,250,.12);
  --blue:#60a5fa;
  --text:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;
  --nav-h:72px;--hud-h:56px;--safe-b:env(safe-area-inset-bottom,0px);
  --radius:16px;--radius-sm:10px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;touch-action:manipulation}

/* ─── Full-screen canvas ─── */
#game-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}

/* ─── HUD (top stats overlay) ─── */
#hud{position:fixed;top:0;left:0;right:0;z-index:20;padding:env(safe-area-inset-top,8px) 16px 0;pointer-events:none}
#hud-inner{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:var(--radius);border:1px solid var(--border);pointer-events:auto}
.hud-stat{display:flex;flex-direction:column;align-items:center;min-width:0;flex:1}
.hud-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);line-height:1}
.hud-val{font-size:16px;font-weight:800;font-variant-numeric:tabular-nums;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hud-val.cash{color:var(--gold)}
.hud-val.income{color:var(--green)}
.hud-val.clicks{color:var(--text-secondary)}
#hud-mult{background:var(--gold);color:#000;font-size:11px;font-weight:800;padding:3px 8px;border-radius:20px;white-space:nowrap}
#prestige-chip{display:none;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;font-size:11px;font-weight:700;padding:5px 12px;border-radius:20px;cursor:pointer;pointer-events:auto;border:none;white-space:nowrap;transition:transform .15s}
#prestige-chip:active{transform:scale(.93)}

/* ─── Click overlay ─── */
#click-zone{position:fixed;top:0;left:0;right:0;bottom:calc(var(--nav-h) + var(--safe-b));z-index:5;cursor:pointer}
.float-text{position:absolute;pointer-events:none;font-weight:800;font-variant-numeric:tabular-nums;animation:floatUp .7s ease-out forwards;z-index:10;text-shadow:0 2px 8px rgba(0,0,0,.6)}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-50px) scale(1.2)}}
.golden-briefcase{position:absolute;width:56px;height:56px;cursor:pointer;pointer-events:all;animation:goldenPulse 1.2s ease-in-out infinite;z-index:15;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,rgba(240,192,64,.3),transparent 70%);border-radius:50%}
.golden-briefcase svg{width:36px;height:36px;filter:drop-shadow(0 0 12px rgba(240,192,64,.8))}
@keyframes goldenPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* ─── Bottom Navigation ─── */
#nav{position:fixed;bottom:0;left:0;right:0;z-index:50;background:var(--surface);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--border);padding-bottom:var(--safe-b);display:flex;height:calc(var(--nav-h) + var(--safe-b))}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:none;background:none;color:var(--text-muted);cursor:pointer;padding:8px 4px;transition:color .2s}
.nav-btn svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:transform .2s}
.nav-btn span{font-size:10px;font-weight:600;letter-spacing:.3px}
.nav-btn.active{color:var(--gold)}
.nav-btn.active svg{transform:scale(1.1)}
.nav-btn:active svg{transform:scale(.85)}

/* ─── Panels (slide up from bottom) ─── */
.panel{position:fixed;left:0;right:0;bottom:0;z-index:40;background:var(--surface-solid);border-radius:var(--radius) var(--radius) 0 0;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,.24,1);max-height:75vh;display:flex;flex-direction:column;overflow:hidden;border-top:1px solid var(--border-light);overscroll-behavior:contain}
.panel.open{transform:translateY(0)}
.panel-handle{width:36px;height:4px;background:rgba(255,255,255,.2);border-radius:2px;margin:10px auto 6px;flex-shrink:0}
.panel-header{padding:0 18px 10px;flex-shrink:0}
.panel-title{font-size:20px;font-weight:800;letter-spacing:-.3px}
.panel-subtitle{font-size:12px;color:var(--text-muted);margin-top:2px}

/* ─── Tab bar inside panels ─── */
.tab-bar{display:flex;gap:4px;margin-top:10px;background:rgba(255,255,255,.04);border-radius:var(--radius-sm);padding:3px}
.tab-btn{flex:1;padding:7px 4px;text-align:center;font-size:12px;font-weight:600;color:var(--text-muted);border:none;background:none;border-radius:8px;cursor:pointer;transition:.2s}
.tab-btn.active{background:rgba(255,255,255,.1);color:var(--text)}

/* ─── Bulk bar ─── */
.bulk-bar{display:flex;gap:4px;padding:8px 18px;flex-shrink:0}
.bulk-btn{flex:1;padding:6px;text-align:center;font-size:11px;font-weight:700;color:var(--text-muted);background:rgba(255,255,255,.04);border:1px solid transparent;border-radius:8px;cursor:pointer;transition:.15s}
.bulk-btn.active{color:var(--gold);border-color:var(--gold);background:var(--gold-soft)}

/* ─── Shop items ─── */
.panel-scroll{flex:1;overflow-y:auto;padding:4px 14px 90px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.panel-scroll::-webkit-scrollbar{display:none}
.shop-item{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:6px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none}
.shop-item:active{transform:scale(.97);background:var(--card-hover)}
.shop-item.cant-afford{opacity:.55;cursor:default}
.shop-item.cant-afford:active{transform:none;background:var(--card)}
.shop-item.owned{border-color:var(--green);opacity:.65;cursor:default}
.shop-item.locked{border-color:var(--border);opacity:.25;cursor:default}
.item-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.item-icon svg{width:24px;height:24px;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.item-icon.vehicle{background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#60a5fa}
.item-icon.vehicle svg{stroke:#60a5fa}
.item-icon.property{background:linear-gradient(135deg,#1a3a2a,#059669);color:#34d399}
.item-icon.property svg{stroke:#34d399}
.item-icon.license{background:linear-gradient(135deg,#3a2a1a,#d97706);color:#fbbf24}
.item-icon.license svg{stroke:#fbbf24}
.item-icon.cosmetic{background:linear-gradient(135deg,#3a1a3a,#9333ea);color:#c084fc}
.item-icon.cosmetic svg{stroke:#c084fc}
.item-info{flex:1;min-width:0}
.item-name{font-size:14px;font-weight:700;line-height:1.2}
.item-desc{font-size:11px;color:var(--text-muted);margin-top:2px}
.item-right{text-align:right;flex-shrink:0}
.item-cost{font-size:14px;font-weight:800;color:var(--gold)}
.item-owned{font-size:10px;color:var(--text-muted);margin-top:2px}
.item-status{font-size:11px;font-weight:600;padding:4px 10px;border-radius:6px}
.item-status.owned-s{color:var(--green);background:var(--green-soft)}
.item-status.locked-s{color:var(--red)}

/* ─── Power-up cards ─── */
.boost-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px 14px 90px}
.boost-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;cursor:pointer;transition:.15s;position:relative;overflow:hidden}
.boost-card:active{transform:scale(.96)}
.boost-card.active-boost{border-color:var(--green);background:rgba(52,211,153,.08)}
.boost-card.cooldown{opacity:.35;cursor:default}
.boost-card.cant-afford{opacity:.55;cursor:default}
.boost-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.boost-icon svg{width:22px;height:22px}
.boost-name{font-size:13px;font-weight:700}
.boost-desc{font-size:10px;color:var(--text-muted);margin-top:2px}
.boost-cost{font-size:12px;font-weight:700;color:var(--gold);margin-top:6px}
.boost-timer{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,.05)}
.boost-timer-fill{height:100%;background:var(--green);transition:width .5s linear}

/* ─── Achievement cards ─── */
.ach-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:12px 4px 6px}
.ach-card{display:flex;align-items:center;gap:12px;padding:10px 14px;margin-bottom:4px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm)}
.ach-card.earned{border-color:rgba(167,139,250,.3)}
.ach-card.locked-ach{opacity:.35}
.ach-icon{width:40px;height:40px;border-radius:10px;background:var(--purple-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ach-icon svg{width:22px;height:22px;stroke:var(--purple);fill:none;stroke-width:1.8}
.ach-info{flex:1;min-width:0}
.ach-name{font-size:13px;font-weight:700}
.ach-desc{font-size:11px;color:var(--text-muted);margin-top:1px}

/* ─── Stats panel ─── */
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.stat-row-label{font-size:13px;color:var(--text-secondary)}
.stat-row-value{font-size:14px;font-weight:700}

/* ─── Prestige modal ─── */
#prestige-modal{position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(8px)}
#prestige-modal.show{display:flex}
.prestige-box{background:var(--surface-solid);border:1px solid rgba(167,139,250,.3);border-radius:var(--radius);padding:28px;max-width:320px;width:90%;text-align:center}
.prestige-box h2{font-size:22px;background:linear-gradient(135deg,#7c3aed,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.prestige-box p{font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.5}
.prestige-gain{font-size:32px;font-weight:900;color:var(--purple);margin:12px 0}
.prestige-btns{display:flex;gap:8px;margin-top:16px}
.prestige-btns button{flex:1;padding:12px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:700;cursor:pointer}
.btn-prestige{background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff}
.btn-cancel{background:rgba(255,255,255,.06);color:var(--text-secondary)}

/* ─── Milestone banner ─── */
#milestone-banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.8);z-index:60;pointer-events:none;display:none;text-align:center;padding:24px 36px;background:var(--surface);backdrop-filter:blur(16px);border:1px solid var(--gold-glow);border-radius:var(--radius);opacity:0;transition:all .3s}
#milestone-banner.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1)}
#milestone-banner h2{font-size:18px;color:var(--gold);font-weight:800}
#milestone-banner p{font-size:12px;color:var(--text-muted);margin-top:4px}

/* ─── Notifications ─── */
#notifications{position:fixed;top:calc(env(safe-area-inset-top,8px) + 64px);left:16px;right:16px;z-index:70;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.notification{background:var(--surface);backdrop-filter:blur(16px);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:10px 16px;font-size:12px;font-weight:600;animation:notifIn .3s ease-out,notifOut .4s ease-in 2.5s forwards;pointer-events:none}
.notification.ach-notif{border-color:rgba(167,139,250,.3);background:linear-gradient(135deg,rgba(30,20,50,.95),rgba(20,15,40,.95));padding:14px 18px;font-size:13px;animation:achToastIn .4s cubic-bezier(.32,.72,.24,1),achToastOut .5s ease-in 3s forwards}
.ach-notif-inner{display:flex;align-items:center;gap:10px}
.ach-notif-icon{width:32px;height:32px;border-radius:8px;background:var(--purple-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ach-notif-icon svg{width:18px;height:18px;stroke:var(--purple);fill:none;stroke-width:1.8}
.ach-notif-text{font-size:10px;color:var(--text-muted);margin-top:1px}
.ach-notif-name{font-size:13px;font-weight:700;color:var(--purple)}
@keyframes notifIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes notifOut{to{opacity:0;transform:translateY(-10px)}}
@keyframes achToastIn{from{transform:translateY(-30px) scale(.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
@keyframes achToastOut{to{opacity:0;transform:translateY(-20px) scale(.95)}}

/* ─── Mogul rank title ─── */
#mogul-rank{position:fixed;top:calc(env(safe-area-inset-top,8px) + 60px);left:50%;transform:translateX(-50%);z-index:15;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--gold);opacity:.5;pointer-events:none;text-shadow:0 1px 4px rgba(0,0,0,.5)}

/* ─── Settings panel ─── */
#settings-btn{position:fixed;top:env(safe-area-inset-top,8px);right:12px;z-index:25;width:36px;height:36px;border-radius:50%;background:var(--surface);backdrop-filter:blur(16px);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-muted);margin-top:8px}
#settings-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--border)}
.setting-label{font-size:13px;font-weight:600}
.setting-desc{font-size:11px;color:var(--text-muted);margin-top:2px}
.toggle{width:48px;height:28px;background:rgba(255,255,255,.1);border-radius:14px;position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:3px;left:3px;transition:.2s}
.toggle.on::after{left:23px}
.btn-danger{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.2);padding:10px 20px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;margin:12px 14px}
.btn-danger:active{transform:scale(.97)}

/* ─── Onboarding ─── */
#onboarding{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
#onboarding.show{display:flex}
.onboard-card{background:var(--surface-solid);border:1px solid var(--border-light);border-radius:var(--radius);padding:28px;max-width:300px;width:90%;text-align:center}
.onboard-card h2{font-size:20px;font-weight:800;color:var(--gold);margin-bottom:8px}
.onboard-card p{font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:16px}
.onboard-step{font-size:10px;color:var(--text-muted);margin-bottom:8px}
.btn-primary{background:var(--gold);color:#000;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-size:14px;font-weight:700;cursor:pointer;width:100%}
.btn-primary:active{transform:scale(.97)}

/* ─── Manager badge ─── */
.mgr-badge{display:inline-block;background:var(--green-soft);color:var(--green);font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle}

/* ─── Welcome back modal ─── */
#welcome-modal{position:fixed;inset:0;z-index:110;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(8px)}
#welcome-modal.show{display:flex}
.welcome-box{background:var(--surface-solid);border:1px solid var(--gold-glow);border-radius:var(--radius);padding:28px;max-width:300px;width:90%;text-align:center}
.welcome-box h2{font-size:20px;color:var(--gold);font-weight:800;margin-bottom:4px}
.welcome-box .wb-time{font-size:12px;color:var(--text-muted);margin-bottom:16px}
.welcome-box .wb-earnings{font-size:28px;font-weight:900;color:var(--green);margin:12px 0}

/* ─── Milestone bonus badge ─── */
.milestone-badge{display:inline-block;background:var(--gold-soft);color:var(--gold);font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:4px}

/* ─── Prestige shop ─── */
.pshop-item{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:6px;background:var(--card);border:1px solid rgba(167,139,250,.15);border-radius:var(--radius-sm);cursor:pointer;transition:.15s}
.pshop-item:active{transform:scale(.97)}
.pshop-item.bought{opacity:.5;border-color:var(--green);cursor:default}
.pshop-item.cant-buy{opacity:.4;cursor:default}
.pshop-cost{font-size:13px;font-weight:700;color:var(--purple)}
.inf-level{font-size:10px;color:var(--text-muted);margin-top:1px}
.pshop-section{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:14px 4px 6px}

/* ─── Daily login modal ─── */
#daily-modal{position:fixed;inset:0;z-index:115;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(8px)}
#daily-modal.show{display:flex}
.daily-box{background:var(--surface-solid);border:1px solid var(--gold-glow);border-radius:var(--radius);padding:24px;max-width:320px;width:90%;text-align:center}
.daily-box h2{font-size:18px;color:var(--gold);font-weight:800;margin-bottom:4px}
.daily-box .daily-sub{font-size:12px;color:var(--text-muted);margin-bottom:14px}
.daily-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:16px}
.daily-cell{padding:8px 2px;border-radius:8px;text-align:center;border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--text-muted)}
.daily-cell.claimed{background:var(--green-soft);border-color:rgba(52,211,153,.3);color:var(--green)}
.daily-cell.today{background:var(--gold-soft);border-color:var(--gold);color:var(--gold);animation:dailyPulse 1.5s ease-in-out infinite}
.daily-cell .day-num{font-size:9px;display:block;margin-bottom:2px}
.daily-cell .day-icon{font-size:16px;display:block}
.daily-reward-text{font-size:14px;font-weight:700;color:var(--gold);margin:8px 0}
@keyframes dailyPulse{0%,100%{box-shadow:0 0 0 0 rgba(240,192,64,.3)}50%{box-shadow:0 0 0 6px rgba(240,192,64,0)}}

/* ─── First prestige celebration ─── */
#prestige-flash{position:fixed;inset:0;z-index:200;pointer-events:none;background:radial-gradient(circle,rgba(240,192,64,.6),rgba(167,139,250,.3),transparent);opacity:0;transition:opacity .15s}
#prestige-flash.show{opacity:1}
.celebration-text{position:fixed;top:35%;left:50%;transform:translate(-50%,-50%);z-index:201;pointer-events:none;text-align:center;opacity:0;transition:opacity .3s .2s}
.celebration-text.show{opacity:1}
.celebration-text h1{font-size:32px;font-weight:900;background:linear-gradient(135deg,#f0c040,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;animation:celebScale .6s ease-out}
.celebration-text p{font-size:14px;color:var(--text-secondary);margin-top:8px}
@keyframes celebScale{0%{transform:scale(0);opacity:0}60%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

/* ─── Splash screen ─── */
#splash{position:fixed;inset:0;z-index:300;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s;pointer-events:auto}
#splash.hide{opacity:0;pointer-events:none}
#splash h1{font-size:36px;font-weight:900;background:linear-gradient(135deg,#f0c040,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;animation:splashTitle .8s ease-out}
#splash p{font-size:13px;color:var(--text-muted);animation:splashFade .6s ease-out .3s both}
#splash .splash-tap{font-size:12px;color:var(--text-muted);margin-top:32px;animation:splashPulse 1.5s ease-in-out .8s infinite}
.splash-mogul{width:60px;height:60px;margin-bottom:20px;opacity:.7}
@keyframes splashTitle{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes splashFade{from{opacity:0}to{opacity:1}}
@keyframes splashPulse{0%,100%{opacity:.4}50%{opacity:.8}}

/* ─── Buy animation ─── */
.shop-item.just-bought{animation:buyFlash .25s ease-out}
.shop-item.just-bought .item-owned{animation:ownedPop .3s ease-out}
@keyframes buyFlash{0%{border-color:var(--green);background:rgba(52,211,153,.12)}100%{border-color:var(--border);background:var(--card)}}
@keyframes ownedPop{0%{transform:scale(1.3)}100%{transform:scale(1)}}

/* ─── Zoom buttons ─── */
#zoom-controls{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 14px);left:14px;z-index:30;display:flex;flex-direction:column;gap:6px}
.zoom-btn{width:40px;height:40px;border-radius:50%;background:var(--surface);backdrop-filter:blur(16px);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);font-size:20px;font-weight:700;transition:transform .15s;-webkit-user-select:none;user-select:none}
.zoom-btn:active{transform:scale(.9);background:var(--card-hover)}

/* ─── Upgrade popup ─── */
#upgrade-popup{position:fixed;z-index:35;background:var(--surface-solid);border:1px solid var(--gold-glow);border-radius:var(--radius-sm);padding:14px 16px;min-width:200px;display:none;box-shadow:0 8px 32px rgba(0,0,0,.5);pointer-events:auto}
#upgrade-popup.show{display:block}
#upgrade-popup .up-name{font-size:14px;font-weight:700;color:var(--gold);margin-bottom:2px}
#upgrade-popup .up-level{font-size:11px;color:var(--text-muted)}
#upgrade-popup .up-income{font-size:12px;color:var(--green);margin-top:4px}
#upgrade-popup .up-cost{font-size:13px;font-weight:700;color:var(--gold);margin-top:6px}
#upgrade-popup .up-btn{width:100%;padding:8px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;transition:.15s}
#upgrade-popup .up-btn.can-buy{background:var(--gold);color:#000}
#upgrade-popup .up-btn.cant-buy{background:rgba(255,255,255,.06);color:var(--text-muted);cursor:default}
#upgrade-popup .up-btn:active{transform:scale(.97)}
#upgrade-popup .up-close{position:absolute;top:6px;right:10px;font-size:16px;color:var(--text-muted);cursor:pointer;background:none;border:none;padding:4px}
/* Configurator styles */
.config-tabs{display:flex;gap:4px;padding:0 4px 8px;overflow-x:auto;scrollbar-width:none}
.config-tabs::-webkit-scrollbar{display:none}
.config-tab{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(255,255,255,.06);color:var(--text-muted);border:none;cursor:pointer;white-space:nowrap;transition:.15s}
.config-tab.active{background:var(--gold);color:#000}
.config-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 4px 12px}
.config-card{background:var(--surface-solid);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:.15s;position:relative}
.config-card:active{transform:scale(.96)}
.config-card.owned{border-color:var(--gold-glow)}
.config-card.equipped{border-color:var(--gold);box-shadow:0 0 12px rgba(240,192,64,.25)}
.config-card .cc-icon{width:48px;height:48px;margin:0 auto 6px;border-radius:10px;background:linear-gradient(135deg,#1a1a3a,#2a2a5a)}
.config-card .cc-name{font-size:11px;font-weight:600;color:var(--text)}
.config-card .cc-cost{font-size:10px;color:var(--gold);margin-top:2px}
.config-card .cc-owned{font-size:9px;color:var(--green);font-weight:700;margin-top:2px}
.config-card .cc-equipped-badge{position:absolute;top:4px;right:4px;width:18px;height:18px;border-radius:50%;background:var(--gold);color:#000;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center}
.config-preview{background:linear-gradient(135deg,#0a0a1e,#1a1a3a);border-radius:12px;margin:0 4px 12px;padding:12px;text-align:center}
.config-preview canvas{border-radius:8px;margin:0 auto;display:block}
.config-preview-label{font-size:10px;color:var(--text-muted);margin-top:6px;text-transform:uppercase;letter-spacing:1px}
.config-sort{display:flex;gap:6px;justify-content:flex-end;padding:0 4px 6px}
.config-sort select{background:var(--surface-solid);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:4px 8px;font-size:10px}

/* ─── Responsive ─── */
@media(min-width:768px){
  #hud{padding-top:12px}
  #hud-inner{max-width:500px;margin:0 auto}
  .panel{max-width:420px;left:50%;right:auto;transform:translate(-50%,100%);border-radius:var(--radius)}
  .panel.open{transform:translate(-50%,0)}
  .boost-grid{grid-template-columns:1fr 1fr 1fr}
  #notifications{max-width:360px;left:50%;right:auto;transform:translateX(-50%)}
}
/* Event banner */
#event-banner{position:fixed;top:calc(env(safe-area-inset-top,8px) + 60px);left:50%;transform:translateX(-50%);z-index:55;padding:8px 18px;border-radius:20px;font-size:12px;font-weight:700;text-align:center;pointer-events:none;white-space:nowrap;transition:opacity .3s}
#event-banner .event-timer{font-size:10px;opacity:.7;margin-left:6px}
/* Spin wheel button */
#spin-btn{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 14px);right:14px;z-index:30;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#a855f7);border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(124,58,237,.4);transition:transform .15s}
#spin-btn:active{transform:scale(.9)}
#spin-btn.ready{animation:spinBtnPulse 1.5s ease-in-out infinite;border-color:var(--gold)}
#spin-btn svg{width:24px;height:24px;stroke:#fff;fill:none;stroke-width:1.8}
#spin-timer{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 66px);right:14px;z-index:30;font-size:9px;font-weight:700;color:var(--text-muted);text-align:center;pointer-events:none;width:48px}
@keyframes spinBtnPulse{0%,100%{box-shadow:0 4px 12px rgba(240,192,64,.3)}50%{box-shadow:0 4px 20px rgba(240,192,64,.6)}}

/* ─── Click Stamina Bar ─── */
#stamina-bar{position:fixed;top:calc(env(safe-area-inset-top,8px) + 52px);left:16px;right:16px;z-index:19;height:3px;background:rgba(255,255,255,.06);border-radius:2px;pointer-events:none;overflow:hidden}
#stamina-fill{height:100%;width:100%;border-radius:2px;transition:width .15s,background .3s}

/* ─── XP Bar ─── */
#xp-bar-wrap{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b));left:0;right:0;z-index:45;height:18px;background:rgba(16,20,30,.95);border-top:1px solid rgba(167,139,250,.15);display:flex;align-items:center;padding:0 12px;gap:8px}
#xp-level{font-size:9px;font-weight:800;color:var(--purple);white-space:nowrap;min-width:32px}
#xp-track{flex:1;height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
#xp-fill{height:100%;background:linear-gradient(90deg,#7c3aed,#a78bfa);border-radius:3px;transition:width .3s ease-out;width:0%}
#xp-text{font-size:8px;color:var(--text-muted);white-space:nowrap;min-width:50px;text-align:right}

/* ─── Perk Points Badge ─── */
#perk-badge{position:fixed;top:env(safe-area-inset-top,8px);right:52px;z-index:25;background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;font-size:10px;font-weight:800;padding:4px 10px;border-radius:20px;display:none;cursor:pointer;margin-top:8px;border:none}
#perk-badge.has-points{display:block;animation:perkPulse 1.5s ease-in-out infinite}
@keyframes perkPulse{0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,.4)}50%{box-shadow:0 0 0 6px rgba(167,139,250,0)}}

/* ─── Perk Tree UI ─── */
.perk-branch-header{font-size:12px;font-weight:800;letter-spacing:.5px;padding:14px 14px 6px;display:flex;align-items:center;gap:8px}
.perk-branch-header .branch-dot{width:10px;height:10px;border-radius:50%}
.perk-branch-header .branch-label{text-transform:uppercase;letter-spacing:1px}
.perk-card{display:flex;align-items:center;gap:10px;padding:10px 14px;margin:0 8px 6px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:.15s}
.perk-card:active{transform:scale(.97)}
.perk-card.unlocked{border-color:rgba(167,139,250,.4);background:rgba(167,139,250,.08)}
.perk-card.maxed{border-color:rgba(251,191,36,.3);background:rgba(251,191,36,.06)}
.perk-card.locked{opacity:.35;cursor:default}
.perk-card.locked:active{transform:none}
.perk-pip{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;font-weight:900}
.perk-info{flex:1;min-width:0}
.perk-name{font-size:13px;font-weight:700}
.perk-desc{font-size:10px;color:var(--text-muted);margin-top:1px}
.perk-right{text-align:right;flex-shrink:0}
.perk-lvl{font-size:11px;font-weight:700;color:var(--purple)}
.perk-req{font-size:9px;color:var(--text-muted)}
.perk-tier-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:8px 22px 2px}

/* ─── Level up celebration ─── */
@keyframes levelUpFlash{0%{opacity:1;transform:translate(-50%,-50%) scale(.8)}50%{transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}}
.level-up-text{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);z-index:65;pointer-events:none;font-size:28px;font-weight:900;background:linear-gradient(135deg,#7c3aed,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:levelUpFlash 1.2s ease-out forwards}

/* Adjust nav position for XP bar */
#nav{bottom:0}
#xp-bar-wrap~#nav{bottom:18px}
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash">
  <div class="splash-mogul">
    <svg viewBox="0 0 60 60" fill="none"><ellipse cx="30" cy="28" rx="8" ry="8" fill="#f0d0a8"/><rect x="22" y="35" width="16" height="14" rx="2" fill="#1a1a3a"/><rect x="28" y="32" width="4" height="6" fill="#e8e8f0"/><path d="M30 36l-2 4h4z" fill="#c41e3a"/><ellipse cx="30" cy="15" rx="10" ry="4" fill="#1a1a2e"/><rect x="23" y="4" width="14" height="12" rx="2" fill="#1a1a35"/><rect x="23" y="13" width="14" height="2.5" fill="#f0c040"/></svg>
  </div>
  <h1>Mogul Runner</h1>
  <p>Build your empire, one tap at a time</p>
  <div class="splash-tap">Tap anywhere to start</div>
</div>

<canvas id="game-canvas"></canvas>

<!-- HUD -->
<div id="hud">
  <div id="hud-inner">
    <div class="hud-stat">
      <span class="hud-label">Cash</span>
      <span class="hud-val cash" id="s-cash">$0</span>
    </div>
    <div class="hud-stat">
      <span class="hud-label">Per Click</span>
      <span class="hud-val" id="s-click">$1</span>
    </div>
    <div class="hud-stat">
      <span class="hud-label">Income</span>
      <span class="hud-val income" id="s-income">$0/s</span>
    </div>
    <span id="hud-mult">1.0x</span>
    <button id="prestige-chip" onclick="showPrestigeModal()"></button>
  </div>
</div>

<!-- Click Stamina Bar -->
<div id="stamina-bar"><div id="stamina-fill" style="width:100%;background:linear-gradient(90deg,#22c55e,#22c55e)"></div></div>

<!-- Mogul Rank -->
<div id="mogul-rank"></div>

<!-- Perk Points Badge -->
<button id="perk-badge" onclick="switchView('stats');currentStatsTab='perks';renderStats();document.querySelectorAll('#stats-tabs .tab-btn').forEach(t=>{t.classList.toggle('active',t.dataset.stab==='perks')})"></button>

<!-- Settings button -->
<div id="settings-btn" onclick="switchView(currentView==='settings'?'game':'settings')">
  <svg viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z" stroke-linecap="round"/><circle cx="12" cy="12" r="3"/></svg>
</div>

<!-- Click zone overlay -->
<div id="click-zone"></div>

<!-- Milestone banner -->
<div id="milestone-banner"><h2 id="ms-title"></h2><p id="ms-desc"></p></div>

<!-- Spin Wheel Button -->
<div id="spin-btn" onclick="if(canSpin()){wheelState.active=true;wheelState.phase='idle';startSpin();}else{notify('Spin recharging: '+getSpinCooldownText());}">
  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 3v9l6 3"/></svg>
</div>
<div id="spin-timer"></div>

<!-- Zoom Controls -->
<div id="zoom-controls">
  <div class="zoom-btn" onclick="zoomIn()">+</div>
  <div class="zoom-btn" onclick="zoomOut()">&minus;</div>
</div>

<!-- Upgrade Popup -->
<div id="upgrade-popup">
  <button class="up-close" onclick="hideUpgradePopup()">&times;</button>
  <div class="up-name" id="up-name"></div>
  <div class="up-level" id="up-level"></div>
  <div class="up-income" id="up-income"></div>
  <div class="up-cost" id="up-cost"></div>
  <button class="up-btn" id="up-btn" onclick="doUpgradeBuilding()">Upgrade</button>
</div>

<!-- XP Bar -->
<div id="xp-bar-wrap">
  <span id="xp-level">Lv.1</span>
  <div id="xp-track"><div id="xp-fill"></div></div>
  <span id="xp-text">0 / 100</span>
</div>

<!-- Bottom Navigation -->
<nav id="nav">
  <button class="nav-btn active" data-view="game">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4m-3.5-6.5L17 7m-10 10l-1.5 1.5M20.5 17.5L19 17M5 7L3.5 5.5"/></svg>
    <span>Play</span>
  </button>
  <button class="nav-btn" data-view="shop">
    <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4zM3 6h18"/><path d="M16 10a4 4 0 01-8 0"/></svg>
    <span>Shop</span>
  </button>
  <button class="nav-btn" data-view="boosts">
    <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none"/></svg>
    <span>Boosts</span>
  </button>
  <button class="nav-btn" data-view="stats">
    <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01z" fill="none"/></svg>
    <span>Stats</span>
  </button>
</nav>

<!-- Shop Panel -->
<div id="shop-panel" class="panel">
  <div class="panel-handle"></div>
  <div class="panel-header">
    <div class="panel-title">Shop</div>
    <div class="tab-bar" id="shop-tabs">
      <button class="tab-btn active" data-tab="vehicles">Vehicles</button>
      <button class="tab-btn" data-tab="properties">Properties</button>
      <button class="tab-btn" data-tab="land">Land</button>
      <button class="tab-btn" data-tab="licenses">Licenses</button>
      <button class="tab-btn" data-tab="managers">Managers</button>
      <button class="tab-btn" data-tab="cosmetics">Cosmetics</button>
      <button class="tab-btn" data-tab="avatar">Avatar</button>
    </div>
  </div>
  <div class="bulk-bar" id="bulk-bar">
    <div class="bulk-btn active" data-qty="1">x1</div>
    <div class="bulk-btn" data-qty="10">x10</div>
    <div class="bulk-btn" data-qty="100">x100</div>
    <div class="bulk-btn" data-qty="max">Max</div>
  </div>
  <div class="panel-scroll" id="shop-items"></div>
</div>

<!-- Boosts Panel -->
<div id="boosts-panel" class="panel">
  <div class="panel-handle"></div>
  <div class="panel-header">
    <div class="panel-title">Power-Ups</div>
    <div class="panel-subtitle">Temporary boosts to accelerate your empire</div>
  </div>
  <div class="boost-grid" id="boost-items"></div>
</div>

<!-- Stats Panel -->
<div id="stats-panel" class="panel">
  <div class="panel-handle"></div>
  <div class="panel-header">
    <div class="panel-title">Stats & Trophies</div>
    <div class="tab-bar" id="stats-tabs">
      <button class="tab-btn active" data-stab="achievements">Trophies</button>
      <button class="tab-btn" data-stab="perks">Perks</button>
      <button class="tab-btn" data-stab="prestige-shop">Prestige</button>
      <button class="tab-btn" data-stab="statistics">Statistics</button>
    </div>
  </div>
  <div class="panel-scroll" id="stats-content"></div>
</div>

<!-- Prestige Modal -->
<div id="prestige-modal">
  <div class="prestige-box">
    <h2>PRESTIGE</h2>
    <p>Reset your progress for permanent prestige points. Each point gives +10% to all earnings forever.</p>
    <div class="prestige-gain" id="prestige-gain-display">+0</div>
    <div style="font-size:12px;color:var(--text-muted)" id="prestige-detail"></div>
    <div class="prestige-btns">
      <button class="btn-cancel" onclick="hidePrestigeModal()">Cancel</button>
      <button class="btn-prestige" onclick="doPrestige()">Prestige</button>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div id="settings-panel" class="panel">
  <div class="panel-handle"></div>
  <div class="panel-header">
    <div class="panel-title">Settings</div>
  </div>
  <div class="panel-scroll" id="settings-content">
    <div class="setting-row">
      <div><div class="setting-label">Sound Effects</div><div class="setting-desc">Click, purchase, and achievement sounds</div></div>
      <div class="toggle on" id="toggle-sound" onclick="toggleSetting('sound')"></div>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Haptic Feedback</div><div class="setting-desc">Vibration on click (mobile only)</div></div>
      <div class="toggle on" id="toggle-haptic" onclick="toggleSetting('haptic')"></div>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Notifications</div><div class="setting-desc">Toast notifications for events</div></div>
      <div class="toggle on" id="toggle-notifs" onclick="toggleSetting('notifs')"></div>
    </div>
    <div class="setting-row" style="flex-direction:column;align-items:stretch;gap:8px">
      <div class="setting-label">Save Data</div>
      <div style="display:flex;gap:8px">
        <button class="btn-danger" style="flex:1;background:var(--gold-soft);color:var(--gold);border-color:rgba(240,192,64,.2)" onclick="exportSave()">Export</button>
        <button class="btn-danger" style="flex:1;background:var(--gold-soft);color:var(--gold);border-color:rgba(240,192,64,.2)" onclick="importSave()">Import</button>
      </div>
    </div>
    <button class="btn-danger" onclick="resetSave()">Reset All Progress</button>
  </div>
</div>

<!-- Daily Login Modal -->
<div id="daily-modal">
  <div class="daily-box">
    <h2>Daily Bonus!</h2>
    <div class="daily-sub" id="daily-streak">Day 1 Streak</div>
    <div class="daily-grid" id="daily-grid"></div>
    <div class="daily-reward-text" id="daily-reward-text"></div>
    <button class="btn-primary" onclick="claimDailyReward()">Claim!</button>
  </div>
</div>

<!-- First Prestige Celebration -->
<div id="prestige-flash"></div>
<div class="celebration-text" id="celebration-text">
  <h1>FIRST PRESTIGE!</h1>
  <p>Your mogul has earned a monocle!</p>
</div>

<!-- Welcome Back Modal -->
<div id="welcome-modal">
  <div class="welcome-box">
    <h2>Welcome Back!</h2>
    <div class="wb-time" id="wb-time"></div>
    <div style="font-size:12px;color:var(--text-muted)">Your empire earned</div>
    <div class="wb-earnings" id="wb-earnings"></div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:16px">while you were away</div>
    <button class="btn-primary" onclick="document.getElementById('welcome-modal').classList.remove('show')">Collect</button>
  </div>
</div>

<!-- Onboarding -->
<div id="onboarding">
  <div class="onboard-card">
    <div class="onboard-step" id="ob-step">1 / 3</div>
    <h2 id="ob-title">Welcome, Mogul!</h2>
    <p id="ob-text">Tap anywhere on the city to earn cash. The faster you tap, the faster your Monopoly man runs!</p>
    <button class="btn-primary" onclick="nextOnboarding()">Got it</button>
  </div>
</div>

<!-- Event Banner -->
<div id="event-banner"></div>

<div id="notifications"></div>

<script>
// ═══════════════════════════════════════════════════════════════
// SVG ICON LIBRARY (inline paths for crisp rendering)
// ═══════════════════════════════════════════════════════════════
const ICONS = {
  // Vehicles
  skateboard: '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="10" width="18" height="3" rx="1.5" stroke="currentColor" stroke-width="1.8"/><circle cx="7" cy="16" r="2" stroke="currentColor" stroke-width="1.8"/><circle cx="17" cy="16" r="2" stroke="currentColor" stroke-width="1.8"/></svg>',
  bicycle: '<svg viewBox="0 0 24 24" fill="none"><circle cx="6" cy="16" r="3.5" stroke="currentColor" stroke-width="1.5"/><circle cx="18" cy="16" r="3.5" stroke="currentColor" stroke-width="1.5"/><path d="M6 16l4-9h4l2 5h2M10 7h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  scooter: '<svg viewBox="0 0 24 24" fill="none"><circle cx="6" cy="17" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="18" cy="17" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M9 17h6M15 17V8h3M15 11h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  car: '<svg viewBox="0 0 24 24" fill="none"><path d="M5 17h14V12l-2-5H7l-2 5v5z" stroke="currentColor" stroke-width="1.5"/><circle cx="7.5" cy="17" r="1.5" stroke="currentColor" stroke-width="1.5"/><circle cx="16.5" cy="17" r="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.5"/></svg>',
  sportsCar: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 15h18v2H3zM5 15l2-5h10l2 5" stroke="currentColor" stroke-width="1.5"/><circle cx="7" cy="17" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="17" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M9 10l1-3h4l1 3" stroke="currentColor" stroke-width="1.5"/></svg>',
  luxury: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="11" width="20" height="6" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 11l2-4h10l2 4" stroke="currentColor" stroke-width="1.5"/><circle cx="6" cy="17" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="18" cy="17" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
  limo: '<svg viewBox="0 0 24 24" fill="none"><rect x="1" y="11" width="22" height="5" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M4 11l2-4h12l2 4M10 11V7" stroke="currentColor" stroke-width="1.5"/><circle cx="5" cy="16" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="19" cy="16" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
  helicopter: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="10" cy="14" rx="6" ry="4" stroke="currentColor" stroke-width="1.5"/><path d="M16 14h4l2 2M10 10V7M4 7h12M10 18v2h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  yacht: '<svg viewBox="0 0 24 24" fill="none"><path d="M4 18l2-10h12l2 10" stroke="currentColor" stroke-width="1.5"/><path d="M2 18h20M6 8V5h3M12 8V3l5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  privateJet: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 3l-2 7H4l-1 2h8l-1 9h2l3-9h6l1-2h-7l2-7h-2z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>',
  // Properties
  parking: '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M10 16V8h3a3 3 0 010 6h-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>',
  garage: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 21V9l9-6 9 6v12" stroke="currentColor" stroke-width="1.5"/><rect x="7" y="13" width="10" height="8" stroke="currentColor" stroke-width="1.5"/><path d="M7 16h10" stroke="currentColor" stroke-width="1.5"/></svg>',
  apartment: '<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M9 7h2m-2 4h2m-2 4h2m2-8h2m-2 4h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  office: '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="2" width="16" height="20" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M9 6h6M9 10h6M9 14h6M4 18h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  mall: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="7" width="20" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M2 12h20M8 7V4h8v3" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="15" width="6" height="6" stroke="currentColor" stroke-width="1.5"/></svg>',
  hotel: '<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M5 8h14M9 3v5M15 3v5" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="16" width="4" height="5" stroke="currentColor" stroke-width="1.5"/></svg>',
  skyscraper: '<svg viewBox="0 0 24 24" fill="none"><rect x="7" y="2" width="10" height="20" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M10 6h4m-4 4h4m-4 4h4M7 22H3v-8l4-2m10 10h4v-8l-4-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  cityBlock: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="10" width="8" height="12" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="4" width="6" height="18" stroke="currentColor" stroke-width="1.5"/><rect x="16" y="8" width="6" height="14" stroke="currentColor" stroke-width="1.5"/><path d="M4 14h4m-4 4h4m4-10h2m-2 4h2m6-2h2m-2 4h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  resort: '<svg viewBox="0 0 24 24" fill="none"><path d="M2 22h20M6 22V8l6-5 6 5v14" stroke="currentColor" stroke-width="1.5"/><path d="M10 22v-5h4v5M3 22v-6l3-2m15 8v-6l-3-2" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="11" r="2" stroke="currentColor" stroke-width="1.5"/></svg>',
  spacePort: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l3 8h-6l3-8zM9 10v10M15 10v10M6 20h12M12 10v10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="4" r="1" fill="currentColor"/></svg>',
  floatingCity: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="18" rx="8" ry="2" stroke="currentColor" stroke-width="1.5"/><rect x="8" y="8" width="8" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="5" y="12" width="4" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="15" y="11" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>',
  moonBase: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="18" rx="9" ry="3" stroke="currentColor" stroke-width="1.5"/><path d="M8 18v-5a4 4 0 018 0v5" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="10" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M6 15l-2-3M18 15l2-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  foodcart: '<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="10" width="14" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="8" cy="18" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="18" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M12 10V6M8 6h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  restaurant: '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="8" width="16" height="13" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M4 8l8-5 8 5" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="15" width="4" height="6" stroke="currentColor" stroke-width="1.5"/><path d="M8 12h2m4 0h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  laundromat: '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="13" r="1.5" stroke="currentColor" stroke-width="1"/><path d="M7 7h2m4 0h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  casino: '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="8" width="18" height="13" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M3 8l9-5 9 5" stroke="currentColor" stroke-width="1.5"/><path d="M12 13l2-3-2 1-2-1z" fill="currentColor"/><circle cx="9" cy="16" r="1.5" stroke="currentColor" stroke-width="1.2"/><circle cx="15" cy="16" r="1.5" stroke="currentColor" stroke-width="1.2"/></svg>',
  stadium: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="16" rx="9" ry="4" stroke="currentColor" stroke-width="1.5"/><path d="M3 12v4M21 12v4M3 12c0-3 4-6 9-6s9 3 9 6" stroke="currentColor" stroke-width="1.5"/><ellipse cx="12" cy="16" rx="5" ry="2" stroke="currentColor" stroke-width="1" fill="none"/></svg>',
  airport: '<svg viewBox="0 0 24 24" fill="none"><rect x="6" y="8" width="12" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="16" y="5" width="3" height="13" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="17.5" cy="6.5" r="1.5" stroke="currentColor" stroke-width="1"/><path d="M3 20h18M9 12h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  orbitalhotel: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="12" rx="9" ry="3" stroke="currentColor" stroke-width="1.5" transform="rotate(30 12 12)"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>',
  marscolony: '<svg viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="19" rx="9" ry="3" stroke="currentColor" stroke-width="1.5"/><path d="M7 19v-4a3 3 0 016 0v4" stroke="currentColor" stroke-width="1.5"/><path d="M14 19v-3a2 2 0 014 0v3" stroke="currentColor" stroke-width="1.5"/><path d="M10 14V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><rect x="9" y="9" width="2" height="2" fill="currentColor"/></svg>',
  // Licenses
  license: '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M7 9h4m-4 3h10m-10 3h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  permit: '<svg viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="1.5"/><path d="M14 2v6h6M8 13h8m-8 4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  contract: '<svg viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="1.5"/><path d="M14 2v6h6M8 13h8m-8 4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M9 18l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
  grant: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 21h18M5 21V7l7-4 7 4v14" stroke="currentColor" stroke-width="1.5"/><path d="M9 10h6m-6 4h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><rect x="10" y="16" width="4" height="5" stroke="currentColor" stroke-width="1.5"/></svg>',
  // Boosts
  coffee: '<svg viewBox="0 0 24 24" fill="none"><path d="M17 8h1a4 4 0 010 8h-1M3 8h14v9a4 4 0 01-4 4H7a4 4 0 01-4-4V8z" stroke="currentColor" stroke-width="1.5"/><path d="M6 1v3m4-3v3m4-3v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  energy: '<svg viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>',
  goldenTouch: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>',
  propBoom: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 17l6-6 4 4 8-8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 7h4v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>',
  taxRefund: '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/><path d="M12 7v5l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  // Misc
  briefcase: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="7" width="20" height="13" rx="2" stroke="#f0c040" stroke-width="1.8"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2M12 12v2" stroke="#f0c040" stroke-width="1.8" stroke-linecap="round"/></svg>',
  trophy: '<svg viewBox="0 0 24 24" fill="none"><path d="M8 21h8m-4-4v4M6 4h12v4a6 6 0 01-12 0V4zM6 8H4a2 2 0 010-4h2m12 4h2a2 2 0 000-4h-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
  lock: '<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="11" width="14" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 11V7a4 4 0 018 0v4" stroke="currentColor" stroke-width="1.5"/></svg>',
  check: '<svg viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
  star: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>',
};

const VEHICLE_ICONS = ['skateboard','bicycle','scooter','car','sportsCar','luxury','limo','helicopter','yacht','privateJet'];
const PROPERTY_ICONS = ['parking','foodcart','garage','apartment','restaurant','laundromat','office','casino','mall','hotel','stadium','skyscraper','cityBlock','airport','resort','spacePort','orbitalhotel','floatingCity','moonBase','marscolony'];
const LICENSE_ICONS = ['license','permit','license','permit','contract','grant','license','permit','contract'];
const BOOST_ICONS = ['coffee','energy','goldenTouch','propBoom','taxRefund'];
const BOOST_COLORS = ['#92400e','#1d4ed8','#854d0e','#065f46','#7c2d12'];

// ═══════════════════════════════════════════════════════════════
// GAME CONFIG
// ═══════════════════════════════════════════════════════════════
const VEHICLES = [
  {name:"Skateboard",baseCost:50,clickBonus:1,scaling:1.15},
  {name:"Bicycle",baseCost:300,clickBonus:5,scaling:1.15},
  {name:"Scooter",baseCost:1500,clickBonus:25,scaling:1.15},
  {name:"Used Car",baseCost:8000,clickBonus:120,scaling:1.15},
  {name:"Sports Car",baseCost:50000,clickBonus:600,scaling:1.14},
  {name:"Luxury Sedan",baseCost:300000,clickBonus:3200,scaling:1.13},
  {name:"Limousine",baseCost:2000000,clickBonus:20000,scaling:1.12},
  {name:"Helicopter",baseCost:15000000,clickBonus:150000,scaling:1.11},
  {name:"Yacht",baseCost:50000000000,clickBonus:100000000,scaling:1.10},
  {name:"Private Jet",baseCost:500000000000,clickBonus:1000000000,scaling:1.09},
];
const PROPERTIES = [
  // Tier 0-2 — Street Level (+50% cost, +0.01 scaling)
  {name:"Parking Lot",baseCost:150,income:1,scaling:1.16,type:'parking'},
  {name:"Food Cart",baseCost:600,income:3,scaling:1.16,type:'foodcart'},
  {name:"Garage",baseCost:2250,income:8,scaling:1.15,type:'garage'},
  // Tier 3-5 — Neighborhood (+60% cost, +0.01 scaling)
  {name:"Apartment",baseCost:9600,income:25,scaling:1.15,type:'apartment'},
  {name:"Restaurant",baseCost:40000,income:80,scaling:1.14,type:'restaurant'},
  {name:"Laundromat",baseCost:160000,income:250,scaling:1.14,type:'laundromat'},
  // Tier 6-8 — Downtown (+70% cost, +0.01 scaling)
  {name:"Office",baseCost:850000,income:1000,scaling:1.14,type:'office'},
  {name:"Casino",baseCost:3.4e6,income:3500,scaling:1.13,type:'casino'},
  {name:"Mall",baseCost:17e6,income:12000,scaling:1.13,type:'mall'},
  // Tier 9-11 — Upscale (+75% cost, +0.01 scaling)
  {name:"Hotel",baseCost:87.5e6,income:45000,scaling:1.13,type:'hotel'},
  {name:"Stadium",baseCost:437.5e6,income:180000,scaling:1.12,type:'stadium'},
  {name:"Skyscraper",baseCost:1.75e9,income:700000,scaling:1.12,type:'skyscraper'},
  // Tier 12-14 — Mega (+80% cost, +0.01 scaling)
  {name:"City Block",baseCost:9e9,income:2.8e6,scaling:1.12,type:'cityblock'},
  {name:"Airport",baseCost:45e9,income:12e6,scaling:1.11,type:'airport'},
  {name:"Resort",baseCost:216e9,income:50e6,scaling:1.11,type:'resort'},
  // Tier 15-17 — Future (+85% cost, +0.01 scaling)
  {name:"Space Port",baseCost:1110e9,income:220e6,scaling:1.11,type:'spaceport'},
  {name:"Orbital Hotel",baseCost:5.55e12,income:1e9,scaling:1.10,type:'orbitalhotel'},
  {name:"Floating City",baseCost:27.75e12,income:5e9,scaling:1.10,type:'floatingcity'},
  // Tier 18-19 — Cosmic (+90% cost, +0.01 scaling)
  {name:"Moon Base",baseCost:152e12,income:25e9,scaling:1.09,type:'moonbase'},
  {name:"Mars Colony",baseCost:950e12,income:150e9,scaling:1.09,type:'marscolony'},
];
const LICENSES = [
  {name:"Business License",cost:1000,multiplier:1.5},
  {name:"Broker Permit",cost:10000,multiplier:2},
  {name:"Real Estate License",cost:100000,multiplier:3},
  {name:"Developer Permit",cost:1000000,multiplier:5},
  {name:"City Contract",cost:10000000,multiplier:8},
  {name:"Federal Grant",cost:100000000,multiplier:15},
  {name:"Diamond License",cost:5000000000,multiplier:12},
  {name:"Platinum License",cost:100000000000,multiplier:18},
  {name:"Quantum License",cost:10000000000000,multiplier:30},
];
const POWERUPS = [
  {name:"Coffee Rush",baseCost:100,costScale:1.5,clickMult:2,passiveMult:1,duration:30,cooldown:60,desc:"2x click power for 30s"},
  {name:"Energy Surge",baseCost:1000,costScale:1.5,clickMult:3,passiveMult:1,duration:30,cooldown:90,desc:"3x click power for 30s"},
  {name:"Golden Touch",baseCost:10000,costScale:1.5,clickMult:5,passiveMult:1,duration:20,cooldown:120,desc:"5x click power for 20s"},
  {name:"Property Boom",baseCost:50000,costScale:1.5,clickMult:1,passiveMult:3,duration:30,cooldown:180,desc:"3x passive income for 30s"},
  {name:"Tax Refund",baseCost:5000,costScale:2,clickMult:1,passiveMult:1,duration:0,cooldown:180,desc:"Instant 60s of income",instant:true},
];
const MILESTONES = [
  {name:"Empty Lot",desc:"Your journey begins",color:"#0a0e17"},
  {name:"Neighborhood",desc:"A small community forms",color:"#0a120e"},
  {name:"Suburb",desc:"The suburbs are growing",color:"#0e1012"},
  {name:"Downtown",desc:"Welcome to downtown!",color:"#120e14"},
  {name:"Business District",desc:"Money flows here",color:"#14120a"},
  {name:"Waterfront",desc:"Premium real estate",color:"#0a1212"},
  {name:"Industrial Zone",desc:"Factories and warehouses",color:"#120e0a"},
  {name:"Airport District",desc:"International hub",color:"#0e0e14"},
  {name:"Resort Paradise",desc:"Luxury living",color:"#0a1414"},
  {name:"Space Age",desc:"Beyond the horizon",color:"#0e0a14"},
];
const ACHIEVEMENTS = [
  {id:"click10",name:"First Steps",desc:"Click 10 times",check:s=>s.totalClicks>=10,reward:"clickBonus",amount:0.5},
  {id:"click100",name:"Getting Busy",desc:"Click 100 times",check:s=>s.totalClicks>=100,reward:"clickBonus",amount:1},
  {id:"click1k",name:"Click Machine",desc:"Click 1,000 times",check:s=>s.totalClicks>=1000,reward:"clickBonus",amount:3},
  {id:"click10k",name:"Finger Marathon",desc:"Click 10,000 times",check:s=>s.totalClicks>=10000,reward:"clickBonus",amount:10},
  {id:"cash1k",name:"First Thousand",desc:"Earn $1,000 total",check:s=>s.totalCash>=1000,reward:"incomeBonus",amount:1},
  {id:"cash100k",name:"Six Figures",desc:"Earn $100,000 total",check:s=>s.totalCash>=100000,reward:"incomeBonus",amount:10},
  {id:"cash1m",name:"Millionaire",desc:"Earn $1,000,000 total",check:s=>s.totalCash>=1000000,reward:"incomeBonus",amount:50},
  {id:"cash1b",name:"Billionaire",desc:"Earn $1B total",check:s=>s.totalCash>=1e9,reward:"incomeBonus",amount:500},
  {id:"prop5",name:"Landlord",desc:"Own 5 properties",check:s=>s.properties.reduce((a,b)=>a+b,0)>=5,reward:"incomeBonus",amount:5},
  {id:"prop25",name:"Real Estate Baron",desc:"Own 25 properties",check:s=>s.properties.reduce((a,b)=>a+b,0)>=25,reward:"incomeBonus",amount:25},
  {id:"veh5",name:"Car Collector",desc:"Own 5 vehicles",check:s=>s.vehicles.reduce((a,b)=>a+b,0)>=5,reward:"clickBonus",amount:5},
  {id:"lic3",name:"Licensed Pro",desc:"Own 3 licenses",check:s=>s.licenses.filter(Boolean).length>=3,reward:"multiplierBonus",amount:0.5},
  {id:"prestige1",name:"New Beginnings",desc:"Prestige once",check:s=>s.prestigeCount>=1,reward:"prestigeBonus",amount:0.1},
  {id:"prestige5",name:"Serial Mogul",desc:"Prestige 5 times",check:s=>s.prestigeCount>=5,reward:"prestigeBonus",amount:0.25},
  {id:"golden5",name:"Lucky Find",desc:"Catch 5 golden briefcases",check:s=>s.goldenCaught>=5,reward:"clickBonus",amount:5},
  {id:"cash1t",name:"Trillionaire",desc:"Earn $1T total",check:s=>s.totalCash>=1e12,reward:"incomeBonus",amount:5000},
  {id:"prop100",name:"Real Estate Empire",desc:"Own 100 properties",check:s=>s.properties.reduce((a,b)=>a+b,0)>=100,reward:"incomeBonus",amount:100},
  {id:"veh50",name:"Fleet Commander",desc:"Own 50 vehicles",check:s=>s.vehicles.reduce((a,b)=>a+b,0)>=50,reward:"clickBonus",amount:50},
  {id:"tax10",name:"Tax Dodger",desc:"Outclick the tax inspector 10 times",check:s=>(s.taxOutclicks||0)>=10,reward:"clickBonus",amount:25},
  {id:"event5",name:"Eventful",desc:"Experience 5 random events",check:s=>(s.eventsExperienced||0)>=5,reward:"incomeBonus",amount:50},
];

// MANAGERS: auto-clickers that generate clicks/sec per property type
const MANAGERS = [
  {name:"Valet",desc:"Auto-clicks 0.6/sec",cost:7500,autoClicksPerSec:0.6},
  {name:"Property Agent",desc:"Auto-clicks 1.8/sec",cost:75000,autoClicksPerSec:1.8},
  {name:"Business Partner",desc:"Auto-clicks 4.8/sec",cost:750000,autoClicksPerSec:4.8},
  {name:"Investment Banker",desc:"Auto-clicks 12/sec",cost:7500000,autoClicksPerSec:12},
  {name:"Hedge Fund Manager",desc:"Auto-clicks 30/sec",cost:75000000,autoClicksPerSec:30},
  {name:"Board of Directors",desc:"Auto-clicks 90/sec",cost:750000000,autoClicksPerSec:90},
  {name:"Sovereign Fund",desc:"Auto-clicks 240/sec",cost:7500000000,autoClicksPerSec:240},
  {name:"AI Empire",desc:"Auto-clicks 600/sec",cost:750000000000,autoClicksPerSec:600},
];
const MANAGER_ICONS = ['license','permit','contract','grant','permit','grant','license','contract'];

// PRESTIGE SHOP: spend prestige points on permanent perks
const PRESTIGE_PERKS = [
  {id:"startCash",name:"Head Start",desc:"Start each run with $500",cost:2,effect:"startCash",value:500},
  {id:"startSkateboard",name:"Free Skateboard",desc:"Start with 1 Skateboard",cost:3,effect:"startVehicle",value:0},
  {id:"clickBoost",name:"Golden Fingers",desc:"+5 base click value permanently",cost:5,effect:"clickBoost",value:5},
  {id:"incomeBoost",name:"Passive Mastery",desc:"+50% prestige multiplier bonus",cost:8,effect:"prestigeMult",value:0.5},
  {id:"offlineRate",name:"Night Shift",desc:"Offline earnings at 75% instead of 50%",cost:10,effect:"offlineRate",value:0.75},
  {id:"autoClicker",name:"Robot Finger",desc:"Start with Valet manager each run",cost:15,effect:"startManager",value:0},
  {id:"megaMult",name:"Tycoon Aura",desc:"+100% prestige multiplier bonus",cost:25,effect:"prestigeMult",value:1.0},
  {id:"startCar",name:"Luxury Start",desc:"Start with 1 Used Car",cost:30,effect:"startVehicle",value:3},
];

// INFINITE PRESTIGE SINKS: infinitely leveling perks, cost scales each level
const INFINITE_PERKS = [
  {id:"infEarnings",name:"Empire Growth",desc:"+2% all earnings per level",baseCost:3,costMult:1.5,bonusPer:0.02},
  {id:"infClick",name:"Iron Fist",desc:"+3 base click value per level",baseCost:2,costMult:1.4,bonusPer:3},
  {id:"infOffline",name:"Dream Worker",desc:"+1% offline rate per level",baseCost:4,costMult:1.6,bonusPer:0.01},
];
function getInfPerkCost(idx,level){ return Math.ceil(INFINITE_PERKS[idx].baseCost*Math.pow(INFINITE_PERKS[idx].costMult,level)); }

// ═══════════════════════════════════════════════════════════════
// XP PERKS CONFIG
// ═══════════════════════════════════════════════════════════════
const XP_PERKS = [
  // CLICK BRANCH (Red)
  {id:'powerTapping',name:'Power Tapping',desc:'+20%/lvl click value',branch:'click',tier:1,maxLvl:5,effect:'clickBonus',perLvl:0.20,prereq:null,color:'#ef4444'},
  {id:'marathonClicker',name:'Marathon Clicker',desc:'-5%/lvl click decay rate',branch:'click',tier:2,maxLvl:3,effect:'clickDecayReduction',perLvl:0.05,prereq:'powerTapping',color:'#ef4444'},
  {id:'criticalStrike',name:'Critical Strike',desc:'5%/lvl chance for 3x click',branch:'click',tier:2,maxLvl:5,effect:'critChance',perLvl:0.05,prereq:'powerTapping',color:'#ef4444'},
  {id:'splashDamage',name:'Splash Damage',desc:'Crits spawn 10%/lvl bonus income',branch:'click',tier:3,maxLvl:3,effect:'critSplash',perLvl:0.10,prereq:'criticalStrike',color:'#ef4444'},
  {id:'midasTouch',name:'Midas Touch',desc:'Every 10th click = 10x + 5s burst',branch:'click',tier:4,maxLvl:1,effect:'midasTouch',perLvl:1,prereq:'splashDamage',color:'#ef4444'},
  // PASSIVE BRANCH (Green)
  {id:'revenueOpt',name:'Revenue Optimization',desc:'+15%/lvl passive income',branch:'passive',tier:1,maxLvl:5,effect:'incomeBonus',perLvl:0.15,prereq:null,color:'#22c55e'},
  {id:'bulkBuyer',name:'Bulk Buyer',desc:'5%/lvl discount on 10+ purchases',branch:'passive',tier:2,maxLvl:3,effect:'bulkDiscount',perLvl:0.05,prereq:'revenueOpt',color:'#22c55e'},
  {id:'milestoneMaster',name:'Milestone Master',desc:'+25%/lvl milestone bonus',branch:'passive',tier:2,maxLvl:4,effect:'milestoneBonus',perLvl:0.25,prereq:'revenueOpt',color:'#22c55e'},
  {id:'smartBuildings',name:'Smart Buildings',desc:'Auto-upgrade to lvl 2 at 10+ owned',branch:'passive',tier:3,maxLvl:3,effect:'smartBuildings',perLvl:1,prereq:'bulkBuyer',color:'#22c55e'},
  {id:'empireSynergy',name:'Empire Synergy',desc:'Each type boosts ALL +5% (max +100%)',branch:'passive',tier:4,maxLvl:1,effect:'empireSynergy',perLvl:0.05,prereq:'smartBuildings',color:'#22c55e'},
  // STRATEGY BRANCH (Blue)
  {id:'luckyTycoon',name:'Lucky Tycoon',desc:'Briefcases 10%/lvl faster',branch:'strategy',tier:1,maxLvl:5,effect:'goldenSpeed',perLvl:0.10,prereq:null,color:'#60a5fa'},
  {id:'taxOptimizer',name:'Tax Optimizer',desc:'Tax drains 10%/lvl less',branch:'strategy',tier:2,maxLvl:3,effect:'taxReduction',perLvl:0.10,prereq:'luckyTycoon',color:'#60a5fa'},
  {id:'eventCatalyst',name:'Event Catalyst',desc:'Events 15%/lvl more likely + 20%/lvl longer',branch:'strategy',tier:2,maxLvl:4,effect:'eventBoost',perLvl:0.15,prereq:'luckyTycoon',color:'#60a5fa'},
  {id:'prestigePower',name:'Prestige Power',desc:'+10%/lvl prestige point gain',branch:'strategy',tier:3,maxLvl:5,effect:'prestigeGain',perLvl:0.10,prereq:'taxOptimizer',color:'#60a5fa'},
  {id:'timeWarp',name:'Time Warp',desc:'1x/day: 30s of 5x income + 10x XP',branch:'strategy',tier:4,maxLvl:1,effect:'timeWarp',perLvl:1,prereq:'prestigePower',color:'#60a5fa'},
  // SPECIAL/HYBRID (Purple)
  {id:'doubleDip',name:'Double Dip',desc:'Clicks grant 2%/lvl passive as XP',branch:'special',tier:2,maxLvl:3,effect:'clickXPBonus',perLvl:0.02,prereq:null,color:'#a78bfa'},
  {id:'momentumBuilder',name:'Momentum Builder',desc:'+2%/lvl all income 10s on buy (stacks)',branch:'special',tier:3,maxLvl:5,effect:'momentumBonus',perLvl:0.02,prereq:null,color:'#a78bfa'},
  {id:'phoenixRebirth',name:'Phoenix Rebirth',desc:'On prestige: retain 10% cash + vehicles',branch:'special',tier:3,maxLvl:1,effect:'phoenixRebirth',perLvl:1,prereq:null,color:'#a78bfa'},
  {id:'idleMagnate',name:'Idle Magnate',desc:'+15%/lvl offline income',branch:'special',tier:3,maxLvl:3,effect:'offlineBonus',perLvl:0.15,prereq:null,color:'#a78bfa'},
  {id:'fastLearner',name:'Fast Learner',desc:'+10%/lvl all XP gain',branch:'special',tier:2,maxLvl:5,effect:'xpBonus',perLvl:0.10,prereq:null,color:'#a78bfa'},
];
const PERK_TIER_LEVEL_REQ = {1:1, 2:10, 3:25, 4:40};

// ═══════════════════════════════════════════════════════════════
// LAND PURCHASE CONFIG — starts with 1 cell, buy up to 49 (7x7)
// Prices escalate exponentially — land is EXPENSIVE
// ═══════════════════════════════════════════════════════════════
function getLandCost(currentCells){
  // Expensive! Base 2000, scaling x1.9 per cell, quadratic boost
  // Plot 2: ~4K, Plot 5: ~50K, Plot 10: ~1.5M, Plot 20: ~500M, Plot 49: insane
  const base=2000;
  return Math.floor(base*Math.pow(1.9,currentCells)*Math.pow(Math.max(1,currentCells),1.4));
}
const MAX_LAND_CELLS=49; // 7x7 grid max
function getLandGridSize(cells){
  // Convert total cells to square grid size (ceil of sqrt)
  return Math.ceil(Math.sqrt(cells));
}

// ═══════════════════════════════════════════════════════════════
// COSMETICS CONFIG
// ═══════════════════════════════════════════════════════════════
const BUILDING_DECOR=[
  // tier = index into PROPERTIES array (20 properties)
  {id:"garden",name:"Garden Plots",tier:0,cost:500,desc:"Greenery around parking spots"},
  {id:"umbrella",name:"Umbrella Stand",tier:1,cost:2000,desc:"Colorful canopy on food cart"},
  {id:"neon",name:"Neon Sign",tier:2,cost:5000,desc:"Glowing outlines on garages"},
  {id:"roofGarden",name:"Rooftop Garden",tier:3,cost:25000,desc:"Green roof on apartments"},
  {id:"chandelier",name:"Chandelier",tier:4,cost:80000,desc:"Fancy lighting at restaurant"},
  {id:"spinCycle",name:"Spin Cycle Sign",tier:5,cost:200000,desc:"Animated sign on laundromat"},
  {id:"helipad",name:"Helipad",tier:6,cost:500000,desc:"Landing pad on offices"},
  {id:"slotSign",name:"Neon Jackpot",tier:7,cost:1500000,desc:"Flashing jackpot sign at casino"},
  {id:"fountain",name:"Fountain",tier:8,cost:5000000,desc:"Water feature at malls"},
  {id:"pool",name:"Pool",tier:9,cost:15000000,desc:"Rooftop pool on hotels"},
  {id:"jumbotron",name:"Jumbotron",tier:10,cost:50000000,desc:"Giant screen at stadium"},
  {id:"antenna",name:"Antenna Array",tier:11,cost:150000000,desc:"Transmitters on skyscrapers"},
  {id:"goldTrim",name:"Gold Trim",tier:12,cost:500000000,desc:"Gold border on city blocks"},
  {id:"controlTower",name:"Control Tower",tier:13,cost:2000000000,desc:"Radar tower at airport"},
  {id:"palmTrees",name:"Palm Trees",tier:14,cost:8000000000,desc:"Tropical trees at resort"},
  {id:"launchPad",name:"Launch Pad",tier:15,cost:30000000000,desc:"Rocket pad at space port"},
  {id:"solarPanels",name:"Solar Panels",tier:16,cost:100000000000,desc:"Power array on orbital hotel"},
  {id:"cloudRing",name:"Cloud Ring",tier:17,cost:500000000000,desc:"Cloud effect on floating city"},
  {id:"moonFlag",name:"Moon Flag",tier:18,cost:2000000000000,desc:"Flag on moon base"},
  {id:"terraformer",name:"Terraformer",tier:19,cost:10000000000000,desc:"Atmosphere generator on Mars"},
];
const CHAR_OUTFITS=[
  {id:"goldCase",name:"Gold Briefcase",cost:10000,desc:"Briefcase turns gold"},
  {id:"crown",name:"Crown",cost:100000,desc:"Replace top hat with crown"},
  {id:"whiteSuit",name:"White Suit",cost:500000,desc:"Jacket becomes white"},
  {id:"cape",name:"Cape",cost:5000000,desc:"Animated cape behind body"},
  {id:"monocleSparkle",name:"Diamond Monocle",cost:25000000,desc:"Monocle sparkles"},
  {id:"aura",name:"Rainbow Aura",cost:100000000,desc:"Glowing aura behind mogul"},
];
// Expanded cosmetic catalog for Configurator
const AVATAR_HATS=[
  {id:"crown",name:"Crown",cost:100000,desc:"Royal gold crown",icon:"crown"},
  {id:"topHat",name:"Top Hat",cost:0,desc:"Classic Monopoly top hat (default)",icon:"tophat"},
  {id:"fedora",name:"Fedora",cost:50000,desc:"Stylish brown fedora",icon:"hat"},
  {id:"baseballCap",name:"Baseball Cap",cost:25000,desc:"Casual backwards cap",icon:"cap"},
  {id:"cowboyHat",name:"Cowboy Hat",cost:200000,desc:"Wild west rancher hat",icon:"cowboy"},
  {id:"wizardHat",name:"Wizard Hat",cost:5000000,desc:"Mystical starry wizard hat",icon:"wizard"},
];
const AVATAR_SUITS=[
  {id:"classic",name:"Classic Black",cost:0,desc:"Standard mogul suit (default)",icon:"suit"},
  {id:"whiteSuit",name:"White Suit",cost:500000,desc:"Elegant white jacket",icon:"suit"},
  {id:"goldSuit",name:"Gold Suit",cost:10000000,desc:"Solid gold threads",icon:"suit"},
  {id:"redVelvet",name:"Red Velvet",cost:2500000,desc:"Luxurious red velvet jacket",icon:"suit"},
  {id:"tuxedo",name:"Tuxedo",cost:1000000,desc:"Black tie with tails",icon:"suit"},
];
const AVATAR_ACCESSORIES=[
  {id:"monocleSparkle",name:"Diamond Monocle",cost:25000000,desc:"Sparkling diamond monocle",icon:"monocle"},
  {id:"goldCase",name:"Gold Briefcase",cost:10000,desc:"Golden briefcase",icon:"briefcase"},
  {id:"cape",name:"Cape",cost:5000000,desc:"Billowing red cape",icon:"cape"},
  {id:"aura",name:"Rainbow Aura",cost:100000000,desc:"Glowing rainbow aura",icon:"star"},
  {id:"cigar",name:"Cigar",cost:750000,desc:"Victory cigar with smoke",icon:"cigar"},
  {id:"rose",name:"Boutonniere Rose",cost:150000,desc:"Red rose on lapel",icon:"rose"},
  {id:"watch",name:"Gold Watch",cost:2000000,desc:"Gleaming gold wristwatch",icon:"watch"},
];
const VEHICLE_SKINS=[
  {id:"default",name:"Default",cost:0,desc:"Standard paint job"},
  {id:"gold",name:"Gold",cost:500000,desc:"Luxurious gold finish"},
  {id:"racingStripes",name:"Racing Stripes",cost:250000,desc:"Speed stripes"},
  {id:"matteBlack",name:"Matte Black",cost:750000,desc:"Sleek matte black"},
];
const CITY_DECOR=[
  {id:"streetLamps",name:"Street Lamps",cost:5000,desc:"Lights at intersections"},
  {id:"parkTrees",name:"Park Trees",cost:50000,desc:"Trees in empty cells"},
  {id:"trafficLights",name:"Traffic Lights",cost:250000,desc:"Cycling red/green lights"},
  {id:"cityFountain",name:"City Fountain",cost:2500000,desc:"Animated fountain in center"},
];

// DAILY LOGIN REWARDS: 7-day rotating calendar
const DAILY_REWARDS = [
  {day:1,type:"cash",desc:"Cash Bonus",icon:"briefcase",mult:100},
  {day:2,type:"boost",desc:"Free Coffee Rush",icon:"coffee"},
  {day:3,type:"cash",desc:"Cash Bonus",icon:"briefcase",mult:500},
  {day:4,type:"boost",desc:"Free Energy Surge",icon:"energy"},
  {day:5,type:"cash",desc:"Cash Bonus",icon:"briefcase",mult:2000},
  {day:6,type:"boost",desc:"Free Golden Touch",icon:"goldenTouch"},
  {day:7,type:"prestige",desc:"Prestige Point!",icon:"star"},
];
const RANDOM_EVENTS = [
  {name:"Market Boom",desc:"+50% income for 30s",duration:30,effect:"incomeBoost",value:1.5,color:"#34d399"},
  {name:"Stock Crash",desc:"-30% income for 20s",duration:20,effect:"incomePenalty",value:0.7,color:"#f87171"},
  {name:"Lucky Find",desc:"Instant cash bonus!",duration:0,effect:"instantCash",value:30,color:"#f0c040"},
  {name:"Tax Holiday",desc:"No tax inspector for 60s",duration:60,effect:"taxHoliday",value:1,color:"#a78bfa"},
  {name:"Property Surge",desc:"Next purchase 50% off!",duration:0,effect:"discount",value:0.5,color:"#60a5fa"},
  {name:"Golden Hour",desc:"3x briefcase spawns for 60s",duration:60,effect:"goldenHour",value:3,color:"#fbbf24"},
];

// MILESTONE BONUSES: at 25/50/100/200 owned, output doubles
const MILESTONE_THRESHOLDS = [25,50,100,200];
function getMilestoneBonus(owned){
  let mult=1;
  for(const t of MILESTONE_THRESHOLDS){if(owned>=t)mult*=2;}
  return mult;
}

// ═══════════════════════════════════════════════════════════════
// SOUND SYSTEM (Web Audio API - no external files)
// ═══════════════════════════════════════════════════════════════
let audioCtx = null;
function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function playSound(type){
  if(!settings.sound) return;
  try{
    initAudio();
    const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
    osc.connect(gain);gain.connect(audioCtx.destination);
    const now=audioCtx.currentTime;
    if(type==='click'){
      osc.frequency.setValueAtTime(800,now);osc.frequency.exponentialRampToValueAtTime(400,now+.06);
      gain.gain.setValueAtTime(.08,now);gain.gain.exponentialRampToValueAtTime(.001,now+.08);
      osc.start(now);osc.stop(now+.08);
    }else if(type==='buy'){
      osc.frequency.setValueAtTime(400,now);osc.frequency.exponentialRampToValueAtTime(800,now+.1);
      gain.gain.setValueAtTime(.1,now);gain.gain.exponentialRampToValueAtTime(.001,now+.15);
      osc.start(now);osc.stop(now+.15);
    }else if(type==='achieve'){
      osc.frequency.setValueAtTime(523,now);osc.frequency.setValueAtTime(659,now+.1);osc.frequency.setValueAtTime(784,now+.2);
      gain.gain.setValueAtTime(.1,now);gain.gain.exponentialRampToValueAtTime(.001,now+.4);
      osc.start(now);osc.stop(now+.4);
    }else if(type==='prestige'){
      osc.type='triangle';
      osc.frequency.setValueAtTime(300,now);osc.frequency.exponentialRampToValueAtTime(1200,now+.3);
      gain.gain.setValueAtTime(.12,now);gain.gain.exponentialRampToValueAtTime(.001,now+.5);
      osc.start(now);osc.stop(now+.5);
    }else if(type==='fanfare'){
      osc.type='triangle';
      osc.frequency.setValueAtTime(523,now);osc.frequency.setValueAtTime(659,now+.15);osc.frequency.setValueAtTime(784,now+.3);osc.frequency.setValueAtTime(1047,now+.45);
      gain.gain.setValueAtTime(.15,now);gain.gain.setValueAtTime(.15,now+.5);gain.gain.exponentialRampToValueAtTime(.001,now+.8);
      osc.start(now);osc.stop(now+.8);
    }else if(type==='daily'){
      osc.frequency.setValueAtTime(600,now);osc.frequency.setValueAtTime(800,now+.1);osc.frequency.setValueAtTime(1000,now+.2);
      gain.gain.setValueAtTime(.1,now);gain.gain.exponentialRampToValueAtTime(.001,now+.35);
      osc.start(now);osc.stop(now+.35);
    }
  }catch(e){}
}

// ═══════════════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════════════
const settings = { sound:true, haptic:true, notifs:true };
function toggleSetting(key){
  settings[key]=!settings[key];
  const el=document.getElementById('toggle-'+key);
  if(el)el.classList.toggle('on',settings[key]);
  try{localStorage.setItem('mogul_settings',JSON.stringify(settings));}catch(e){}
}
function loadSettings(){
  try{
    const raw=localStorage.getItem('mogul_settings');
    if(raw){const s=JSON.parse(raw);Object.assign(settings,s);}
    ['sound','haptic','notifs'].forEach(k=>{
      const el=document.getElementById('toggle-'+k);
      if(el)el.classList.toggle('on',settings[k]);
    });
  }catch(e){}
}

// ═══════════════════════════════════════════════════════════════
// GAME STATE
// ═══════════════════════════════════════════════════════════════
const state = {
  version:14,
  cash:0, totalCash:0, totalClicks:0, baseClickValue:1,
  multiplier:1, clickMultBonus:1, passiveMultBonus:1,
  vehicles: VEHICLES.map(()=>0),
  properties: PROPERTIES.map(()=>0),
  licenses: LICENSES.map(()=>false),
  managers: MANAGERS.map(()=>false),
  powerups: POWERUPS.map(()=>({active:false,cooldownUntil:0,activeUntil:0,uses:0})),
  currentMilestone:0, clicksThisSecond:0,
  goldenActive:false, goldenCaught:0,
  prestigePoints:0, prestigeCount:0, prestigeMultiplier:1,
  achievements:{},
  achievementClickBonus:0, achievementIncomeBonus:0, achievementMultiplierBonus:0,
  mogul:{x:0,y:0,targetIdx:0,speed:1,facingRight:true,walkFrame:0},
  cosmetics:{buildingDecor:{},characterOutfit:{},cityDecor:{}},
  prestigePerks:{}, // Bought prestige shop perks
  infinitePerkLevels: INFINITE_PERKS.map(()=>0),
  lastDailyLogin:0, dailyStreak:0, dailyClaimedToday:false,
  taxInspector:{active:false,x:0,y:0,targetX:0,targetY:0,speed:40,drainTimer:0,approaching:false,draining:false,tapped:false},
  taxOutclicks:0,
  randomEvent:{active:false,name:'',effect:'',value:0,endsAt:0,color:''},
  eventsExperienced:0,
  nextDiscount:false,
  // Camera for zoom/pan
  camera:{x:0,y:0,zoom:1.0,targetZoom:1.0},
  // Income particles ($)
  incomeParticles:[],
  // Land system: start with 1 cell, buy more
  landCells:1,
  // City grid: 2D array of placed buildings per cell
  cityGrid:null, // initialized in initCityGrid()
  nextBuildingId:1,
  // Spin wheel
  wheelLastSpin:0,
  // Click decay system
  clickDecayFactor:1.0,
  lastClickTime:0,
  midasCounter:0, // for Midas Touch perk
  // XP system
  xp:0, totalXP:0, xpLevel:1, perkPoints:0,
  unlockedPerks:{}, // {perkId: currentLevel}
  // Momentum stacks (from perk)
  momentumStacks:[],
  // Time Warp cooldown
  timeWarpLastUse:0,
  // Manager NPC visual states (not saved — rebuilt)
  managerNPCs:null,
};

let currentShopTab = "vehicles";
let currentStatsTab = "achievements";
let currentView = "game";
let bulkQty = 1;
let canvas, ctx, clickZone;
let canvasW, canvasH;
let particles = [];
let floatTexts = []; // Canvas-rendered float text
let goldenTimer = null;
let lastFrame = 0;
let autoClickAccum = 0; // Fractional auto-clicks
let onboardingStep = 0;

// Building cache (offscreen canvas)
let buildingCache = null;
let buildingCacheDirty = true;
let buildingCacheGS = 0;
function invalidateBuildingCache(){ buildingCacheDirty=true; }
// Check if any building has an active scaffolding animation
function hasActiveScaffolding(){
  const gs=getGridSize();
  if(!state.cityGrid)return false;
  const now=Date.now();
  for(let r=0;r<gs;r++)for(let c2=0;c2<gs;c2++){
    if(!state.cityGrid[r]||!state.cityGrid[r][c2])continue;
    for(const b of state.cityGrid[r][c2]){if(b.builtAt&&now-b.builtAt<1500)return true;}
  }
  return false;
}

// Vehicle sprite state (not saved — rebuilt from state.vehicles)
let vehicleSprites = [];
let lastVehicleSyncGS = 0;

// ═══════════════════════════════════════════════════════════════
// UTILITY
// ═══════════════════════════════════════════════════════════════
function fmt(n) {
  if (n < 0) return "-" + fmt(-n);
  if (n < 1000) return "$" + Math.floor(n);
  if (n < 1e6) return "$" + (n/1e3).toFixed(1) + "K";
  if (n < 1e9) return "$" + (n/1e6).toFixed(2) + "M";
  if (n < 1e12) return "$" + (n/1e9).toFixed(2) + "B";
  if (n < 1e15) return "$" + (n/1e12).toFixed(2) + "T";
  return "$" + (n/1e15).toFixed(2) + "Q";
}
function fmtNum(n) {
  if (n < 1000) return Math.floor(n).toLocaleString();
  if (n < 1e6) return (n/1e3).toFixed(1) + "K";
  if (n < 1e9) return (n/1e6).toFixed(1) + "M";
  if (n < 1e12) return (n/1e9).toFixed(1) + "B";
  if (n < 1e15) return (n/1e12).toFixed(1) + "T";
  return (n/1e15).toFixed(1) + "Q";
}
function getCost(base,owned,scaling){ return Math.floor(base*Math.pow(scaling,owned)); }
function getBulkCost(base,owned,scaling,qty){ let t=0;for(let i=0;i<qty;i++)t+=getCost(base,owned+i,scaling);return t; }
function getMaxBuyable(base,owned,scaling,budget){ let c=0,s=0;while(true){const n=getCost(base,owned+c,scaling);if(s+n>budget)break;s+=n;c++;if(c>999)break;}return c; }
function getEffectiveMultiplier(){ return state.multiplier*state.prestigeMultiplier*(1+state.achievementMultiplierBonus); }
function getClickValue(){
  let v=state.baseClickValue+state.achievementClickBonus;
  if(state.prestigePerks.clickBoost)v+=PRESTIGE_PERKS.find(p=>p.id==='clickBoost').value;
  v+=state.infinitePerkLevels[1]*INFINITE_PERKS[1].bonusPer; // Iron Fist
  for(let i=0;i<VEHICLES.length;i++)v+=VEHICLES[i].clickBonus*state.vehicles[i]*getMilestoneBonus(state.vehicles[i]);
  return v*getEffectiveMultiplier()*state.clickMultBonus*(1+getPerkEffect('clickBonus'));
}
function getIncome(){
  let v=state.achievementIncomeBonus;
  // Per-building income with level multiplier
  const gs=getGridSize();
  if(state.cityGrid){
    for(let r=0;r<gs;r++){
      if(!state.cityGrid[r])continue;
      for(let c=0;c<gs;c++){
        if(!state.cityGrid[r][c])continue;
        for(const bld of state.cityGrid[r][c]){
          const prop=PROPERTIES[bld.tier];
          if(!prop)continue;
          const levelMult=1+0.25*((bld.level||1)-1);
          v+=prop.income*levelMult*getMilestoneBonus(state.properties[bld.tier]);
        }
      }
    }
  }else{
    // Fallback: old property-count-based
    for(let i=0;i<PROPERTIES.length;i++)v+=PROPERTIES[i].income*state.properties[i]*getMilestoneBonus(state.properties[i]);
  }
  const infBonus=1+state.infinitePerkLevels[0]*INFINITE_PERKS[0].bonusPer; // Empire Growth
  const perkIncome=1+getPerkEffect('incomeBonus');
  const synergy=1+getSynergyBonus();
  const momentum=1+getMomentumBonus();
  return v*getEffectiveMultiplier()*state.passiveMultBonus*infBonus*perkIncome*synergy*momentum;
}
function recalcMultiplier(){ let m=1;for(let i=0;i<LICENSES.length;i++){if(state.licenses[i])m=Math.max(m,LICENSES[i].multiplier);}state.multiplier=m; }
function getPowerupCost(idx){ return Math.floor(POWERUPS[idx].baseCost*Math.pow(POWERUPS[idx].costScale,state.powerups[idx].uses)); }
function getPrestigeGain(){ if(state.totalCash<1e6)return 0;return Math.floor(Math.sqrt(state.totalCash/1e6)); }
function getActualBulkQty(base,owned,scaling){ if(bulkQty===-1)return getMaxBuyable(base,owned,scaling,state.cash);return bulkQty; }
function formatTime(sec){
  if(sec<60)return sec+"s";
  if(sec<3600)return Math.floor(sec/60)+"m";
  return Math.floor(sec/3600)+"h "+Math.floor((sec%3600)/60)+"m";
}
function getAutoClicksPerSec(){ let t=0;for(let i=0;i<MANAGERS.length;i++)if(state.managers[i])t+=MANAGERS[i].autoClicksPerSec;return t; }
function haptic(ms){ if(settings.haptic&&navigator.vibrate)try{navigator.vibrate(ms||10);}catch(e){} }

// ═══════════════════════════════════════════════════════════════
// XP SYSTEM
// ═══════════════════════════════════════════════════════════════
function getXPForNextLevel(){ return Math.floor(100*Math.pow(state.xpLevel,1.5)); }
function getPerkEffect(effectName){
  let total=0;
  for(const perk of XP_PERKS){
    const lvl=state.unlockedPerks[perk.id]||0;
    if(lvl>0&&perk.effect===effectName)total+=perk.perLvl*lvl;
  }
  return total;
}
function addXP(amount){
  const fastLearnerBonus=1+getPerkEffect('xpBonus');
  const actual=Math.floor(amount*fastLearnerBonus);
  state.xp+=actual;state.totalXP+=actual;
  while(state.xp>=getXPForNextLevel()){
    state.xp-=getXPForNextLevel();
    state.xpLevel++;
    state.perkPoints++;
    onLevelUp();
  }
  updateXPBar();
}
function onLevelUp(){
  playSound('fanfare');haptic(40);
  // Float text
  floatTexts.push({x:state.mogul.x,y:state.mogul.y-30,text:'LEVEL '+state.xpLevel+'!',color:'#a78bfa',size:22,life:1.5});
  // Particles
  for(let i=0;i<20;i++){
    particles.push({x:state.mogul.x,y:state.mogul.y-10,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10-4,life:.6+Math.random()*.6,color:Math.random()>.5?'#a78bfa':'#7c3aed',size:2+Math.random()*2.5});
  }
  // HTML flash
  const el=document.createElement('div');
  el.className='level-up-text';el.textContent='LEVEL '+state.xpLevel+'!';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
  notify('Level '+state.xpLevel+'! +1 Perk Point');
  updatePerkBadge();
}
function updateXPBar(){
  const needed=getXPForNextLevel();
  const pct=Math.min(100,(state.xp/needed)*100);
  const fill=document.getElementById('xp-fill');
  const lvlEl=document.getElementById('xp-level');
  const txtEl=document.getElementById('xp-text');
  if(fill)fill.style.width=pct+'%';
  if(lvlEl)lvlEl.textContent='Lv.'+state.xpLevel;
  if(txtEl)txtEl.textContent=fmtNum(state.xp)+' / '+fmtNum(needed);
}
function updatePerkBadge(){
  const badge=document.getElementById('perk-badge');
  if(!badge)return;
  if(state.perkPoints>0){
    badge.classList.add('has-points');
    badge.textContent=state.perkPoints+' Perk'+(state.perkPoints>1?'s':'');
    badge.style.display='block';
  }else{
    badge.classList.remove('has-points');
    badge.style.display='none';
  }
}
function canUnlockPerk(id){
  const perk=XP_PERKS.find(p=>p.id===id);
  if(!perk)return false;
  const curLvl=state.unlockedPerks[id]||0;
  if(curLvl>=perk.maxLvl)return false;
  if(state.perkPoints<1)return false;
  if(state.xpLevel<PERK_TIER_LEVEL_REQ[perk.tier])return false;
  if(perk.prereq){
    const prereqPerk=XP_PERKS.find(p=>p.id===perk.prereq);
    if(!prereqPerk)return false;
    const prereqLvl=state.unlockedPerks[perk.prereq]||0;
    if(prereqLvl<1)return false;
  }
  return true;
}
function unlockPerk(id){
  if(!canUnlockPerk(id))return;
  state.perkPoints--;
  state.unlockedPerks[id]=(state.unlockedPerks[id]||0)+1;
  playSound('achieve');haptic(20);
  const perk=XP_PERKS.find(p=>p.id===id);
  notify('Perk: '+perk.name+' Lv.'+(state.unlockedPerks[id]));
  updatePerkBadge();updateHUD();saveGame();
  if(currentStatsTab==='perks')renderStats();
}
// Momentum stacks for Momentum Builder perk
function addMomentumStack(){
  const lvl=state.unlockedPerks['momentumBuilder']||0;
  if(lvl<1)return;
  const bonus=0.02*lvl;
  state.momentumStacks.push({bonus,expiresAt:Date.now()+10000});
}
function getMomentumBonus(){
  const now=Date.now();
  state.momentumStacks=state.momentumStacks.filter(s=>s.expiresAt>now);
  let total=0;
  for(const s of state.momentumStacks)total+=s.bonus;
  return Math.min(total,1.0); // Cap at 100%
}
// Empire Synergy: each unique property type owned boosts all by 5%
function getSynergyBonus(){
  if((state.unlockedPerks['empireSynergy']||0)<1)return 0;
  let types=0;
  for(let i=0;i<PROPERTIES.length;i++){if(state.properties[i]>0)types++;}
  return Math.min(types*0.05,1.0); // max 100%
}
// Update stamina bar UI
function updateStaminaBar(){
  const fill=document.getElementById('stamina-fill');
  if(!fill)return;
  const pct=Math.round(state.clickDecayFactor*100);
  fill.style.width=pct+'%';
  if(pct>70)fill.style.background='linear-gradient(90deg,#22c55e,#22c55e)';
  else if(pct>40)fill.style.background='linear-gradient(90deg,#eab308,#f59e0b)';
  else fill.style.background='linear-gradient(90deg,#ef4444,#f87171)';
}

// ═══════════════════════════════════════════════════════════════
// CAMERA SYSTEM
// ═══════════════════════════════════════════════════════════════
const MIN_ZOOM=0.2, MAX_ZOOM=3.5, ZOOM_STEP=0.15;
function applyCamera(c){
  c.save();
  c.translate(canvasW/2,canvasH/2);
  c.scale(state.camera.zoom,state.camera.zoom);
  c.translate(-canvasW/2-state.camera.x,-canvasH/2-state.camera.y);
}
function resetCamera(c){ c.restore(); }
function screenToWorld(sx,sy){
  const z=state.camera.zoom;
  return {
    x:(sx-canvasW/2)/z+canvasW/2+state.camera.x,
    y:(sy-canvasH/2)/z+canvasH/2+state.camera.y
  };
}
function worldToScreen(wx,wy){
  const z=state.camera.zoom;
  return {
    x:(wx-canvasW/2-state.camera.x)*z+canvasW/2,
    y:(wy-canvasH/2-state.camera.y)*z+canvasH/2
  };
}
function zoomIn(){
  state.camera.targetZoom=Math.min(MAX_ZOOM,state.camera.targetZoom+ZOOM_STEP);
}
function zoomOut(){
  state.camera.targetZoom=Math.max(MIN_ZOOM,state.camera.targetZoom-ZOOM_STEP);
}
function zoomAtPoint(delta,sx,sy){
  const oldZ=state.camera.targetZoom;
  const newZ=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,oldZ+delta));
  if(newZ===oldZ)return;
  // Zoom toward cursor position
  const wx=(sx-canvasW/2)/oldZ+canvasW/2+state.camera.x;
  const wy=(sy-canvasH/2)/oldZ+canvasH/2+state.camera.y;
  state.camera.targetZoom=newZ;
  state.camera.x=wx-canvasW/2-(sx-canvasW/2)/newZ;
  state.camera.y=wy-canvasH/2-(sy-canvasH/2)/newZ;
}
function updateCamera(){
  // Smooth zoom lerp
  const z=state.camera.zoom,tz=state.camera.targetZoom;
  if(Math.abs(z-tz)>0.001){
    state.camera.zoom+=(tz-z)*0.15;
  }else{
    state.camera.zoom=tz;
  }
}
// Upgrade popup state
let upgradeTarget=null;
function showUpgradePopup(bld,cellR,cellC,slotIdx){
  upgradeTarget={bld,cellR,cellC,slotIdx};
  const prop=PROPERTIES[bld.tier];
  const levelIncome=prop.income*(1+0.25*(bld.level-1));
  const nextLevelIncome=bld.level<5?prop.income*(1+0.25*bld.level):levelIncome;
  const upgCost=bld.level<5?Math.floor(prop.baseCost*0.8*Math.pow(bld.level,2.5)):0;
  document.getElementById('up-name').textContent=prop.name;
  document.getElementById('up-level').textContent='Level '+bld.level+'/5'+(bld.level>=5?' (MAX)':'');
  document.getElementById('up-income').textContent='Income: '+fmt(levelIncome)+'/s'+(bld.level<5?' → '+fmt(nextLevelIncome)+'/s':'');
  document.getElementById('up-cost').textContent=bld.level<5?'Upgrade: '+fmt(upgCost):'';
  const btn=document.getElementById('up-btn');
  if(bld.level>=5){
    btn.textContent='MAX LEVEL';btn.className='up-btn cant-buy';
  }else if(state.cash>=upgCost){
    btn.textContent='Upgrade ('+fmt(upgCost)+')';btn.className='up-btn can-buy';
  }else{
    btn.textContent='Need '+fmt(upgCost);btn.className='up-btn cant-buy';
  }
  // Position popup near building
  const gs=getGridSize(),pad=getGridPad(),cellW=(canvasW-pad*2)/gs;
  const worldX=pad+cellC*cellW+cellW/2,worldY=pad+cellR*cellW+cellW/2;
  const screen=worldToScreen(worldX,worldY);
  const popup=document.getElementById('upgrade-popup');
  popup.style.left=Math.min(canvasW-220,Math.max(10,screen.x-100))+'px';
  popup.style.top=Math.min(canvasH-180,Math.max(10,screen.y-140))+'px';
  popup.classList.add('show');
}
function hideUpgradePopup(){
  document.getElementById('upgrade-popup').classList.remove('show');
  upgradeTarget=null;
}
function doUpgradeBuilding(){
  if(!upgradeTarget)return;
  const bld=upgradeTarget.bld;
  if(bld.level>=5)return;
  const prop=PROPERTIES[bld.tier];
  const cost=Math.floor(prop.baseCost*0.8*Math.pow(bld.level,2.5));
  if(state.cash<cost)return;
  state.cash-=cost;
  bld.level++;
  playSound('buy');haptic(15);
  addXP(Math.floor(cost/30));
  invalidateBuildingCache();
  updateHUD();
  showUpgradePopup(bld,upgradeTarget.cellR,upgradeTarget.cellC,upgradeTarget.slotIdx);
}

// ═══════════════════════════════════════════════════════════════
// INCOME $ PARTICLES
// ═══════════════════════════════════════════════════════════════
const MAX_INCOME_PARTICLES=30;
function spawnIncomeParticles(){
  if(!state.cityGrid||state.incomeParticles.length>=MAX_INCOME_PARTICLES)return;
  const gs=state.cityGrid.length;
  const cW=canvasW/gs,cH=(canvasH*.55)/gs;
  const startY=canvasH*0.12;
  for(let r=0;r<gs&&state.incomeParticles.length<MAX_INCOME_PARTICLES;r++){
    for(let c=0;c<gs&&state.incomeParticles.length<MAX_INCOME_PARTICLES;c++){
      const cell=state.cityGrid[r][c];
      if(!cell||cell.length===0)continue;
      // One particle per cell (not per building — keeps it manageable)
      const cx=c*cW+cW/2, cy=startY+r*cH+cH/2;
      const lvMax=Math.max(...cell.map(b=>b.level||1));
      const scale=0.8+lvMax*0.1;
      state.incomeParticles.push({
        x:cx+(Math.random()-0.5)*cW*0.4,
        y:cy,
        vx:(Math.random()-0.5)*0.5,
        vy:-0.8-Math.random()*0.4,
        opacity:1.0,
        life:0,
        maxLife:55+Math.random()*15,
        scale:scale,
        text:lvMax>=4?'$$$':lvMax>=2?'$$':'$',
        color:lvMax>=5?'#fbbf24':lvMax>=3?'#34d399':'#22c55e'
      });
    }
  }
}
function updateIncomeParticles(dt){
  for(let i=state.incomeParticles.length-1;i>=0;i--){
    const p=state.incomeParticles[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.life+=1;
    p.opacity=1-(p.life/p.maxLife);
    if(p.opacity<=0||p.life>=p.maxLife){
      state.incomeParticles.splice(i,1);
    }
  }
}
function drawIncomeParticles(c){
  if(state.incomeParticles.length===0)return;
  c.save();
  c.textAlign='center';c.textBaseline='middle';
  for(const p of state.incomeParticles){
    c.globalAlpha=p.opacity*0.85;
    const fs=Math.round(p.scale*13);
    c.font='bold '+fs+'px sans-serif';
    // Shadow
    c.fillStyle='rgba(0,0,0,0.4)';
    c.fillText(p.text,p.x+1,p.y+1);
    // Main text
    c.fillStyle=p.color;
    c.fillText(p.text,p.x,p.y);
  }
  c.globalAlpha=1;
  c.restore();
}

// Mogul rank titles based on cumulative prestige points
const MOGUL_RANKS = [
  {pts:0,title:"Street Vendor"},{pts:3,title:"Entrepreneur"},{pts:10,title:"Business Owner"},
  {pts:25,title:"Tycoon"},{pts:50,title:"Mogul"},{pts:100,title:"Empire Builder"},
  {pts:200,title:"Titan"},{pts:500,title:"Legend"},
];
function getMogulRank(){
  let rank=MOGUL_RANKS[0];
  for(let i=MOGUL_RANKS.length-1;i>=0;i--){if(state.prestigePoints>=MOGUL_RANKS[i].pts){rank=MOGUL_RANKS[i];break;}}
  return rank;
}
let _lastRankTitle="";
function updateRankDisplay(){
  const el=document.getElementById("mogul-rank");
  if(!el)return;
  const rank=getMogulRank();
  if(state.prestigeCount>0){
    el.textContent=rank.title;el.style.display="block";
    // Legend rank celebration (500+ prestige points)
    if(rank.title==="Legend"&&_lastRankTitle!=="Legend"&&_lastRankTitle!==""){
      celebrateLegendRank();
    }
    _lastRankTitle=rank.title;
  }
  else{el.style.display="none";}
}
function celebrateLegendRank(){
  playSound('fanfare');haptic(100);
  const flash=document.getElementById("prestige-flash");
  flash.classList.add("show");
  const celeb=document.getElementById("celebration-text");
  celeb.querySelector("h1").textContent="LEGEND!";
  celeb.querySelector("p").textContent="The ultimate mogul. You are unstoppable.";
  celeb.classList.add("show");
  for(let i=0;i<100;i++){
    particles.push({x:canvasW/2+(Math.random()-.5)*canvasW*.6,y:canvasH/2+(Math.random()-.5)*canvasH*.4,vx:(Math.random()-.5)*15,vy:(Math.random()-.5)*15-5,life:.8+Math.random()*1.2,color:["#f0c040","#ff6b6b","#a78bfa","#34d399","#60a5fa"][Math.floor(Math.random()*5)],size:2+Math.random()*4});
  }
  setTimeout(()=>{
    flash.classList.remove("show");celeb.classList.remove("show");
    celeb.querySelector("h1").textContent="FIRST PRESTIGE!";
    celeb.querySelector("p").textContent="Your mogul has earned a monocle!";
    notify("You've achieved LEGEND status!");
  },4000);
}

function notify(text,cls){
  if(!settings.notifs)return;
  const el=document.createElement("div");
  el.className="notification"+(cls?" "+cls:"");
  el.textContent=text;
  document.getElementById("notifications").appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
function notifyAchievement(name,desc){
  if(!settings.notifs)return;
  const el=document.createElement("div");
  el.className="notification ach-notif";
  el.innerHTML=`<div class="ach-notif-inner"><div class="ach-notif-icon">${ICONS.trophy}</div><div><div class="ach-notif-name">${name}</div><div class="ach-notif-text">${desc}</div></div></div>`;
  document.getElementById("notifications").appendChild(el);
  setTimeout(()=>el.remove(),3500);
}

// ═══════════════════════════════════════════════════════════════
// CANVAS RENDERING
// ═══════════════════════════════════════════════════════════════
function resizeCanvas(){
  canvasW=window.innerWidth; canvasH=window.innerHeight;
  canvas.width=canvasW; canvas.height=canvasH;
  invalidateBuildingCache();
}
function getGridSize(){
  // Grid size determined by purchased land cells
  return getLandGridSize(state.landCells||1);
}
function getMilestone(){
  const gs=getGridSize();
  const idx=Math.min(gs-2,MILESTONES.length-1);
  return MILESTONES[Math.max(0,idx)];
}
function getWaypoints(gs){
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW,pts=[];
  for(let i=0;i<gs;i++)pts.push({x:pad+i*cellW,y:pad});
  for(let i=0;i<gs;i++)pts.push({x:pad+(gs-1)*cellW,y:pad+i*cellH});
  for(let i=gs-1;i>=0;i--)pts.push({x:pad+i*cellW,y:pad+(gs-1)*cellH});
  for(let i=gs-1;i>0;i--)pts.push({x:pad,y:pad+i*cellH});
  return pts;
}
// ╔══════════════════════════════════════════════╗
// ║      SECTION: CITY GRID DATA LAYER           ║
// ╚══════════════════════════════════════════════╝
// Grid padding - responsive to screen width
function getGridPad(){return Math.max(15,Math.min(40,canvasW*0.04));}
// Square cell size based on width (grid is always a square block)
function getGridCellSize(gs){const pad=getGridPad();return(canvasW-pad*2)/gs;}
// Fixed micro-grid: always use dense layout, buildings stay small tokens
function getMicroLayout(cellW,cellH,count){
  // 3x3 grid max — 9 buildings per cell cap
  return{cols:3,rows:3,slots:9};
}
const MICRO_SLOTS=9; // max capacity per cell
function initCityGrid(size){
  if(!size)size=getLandGridSize(state.landCells||1);
  state.cityGrid=[];
  for(let r=0;r<size;r++){state.cityGrid[r]=[];for(let c=0;c<size;c++)state.cityGrid[r][c]=[];}
}
function expandCityGrid(oldSize,newSize){
  if(!state.cityGrid)initCityGrid(newSize);
  for(let r=0;r<oldSize;r++){for(let c=oldSize;c<newSize;c++){if(!state.cityGrid[r])state.cityGrid[r]=[];state.cityGrid[r][c]=[];}}
  for(let r=oldSize;r<newSize;r++){state.cityGrid[r]=[];for(let c=0;c<newSize;c++)state.cityGrid[r][c]=[];}
}
function placeBuilding(propIdx){
  const gs=getGridSize();
  if(!state.cityGrid||state.cityGrid.length<gs)initCityGrid(gs);
  let minCount=Infinity,targetR=0,targetC=0;
  for(let r=0;r<gs;r++){for(let c=0;c<gs;c++){
    if(!state.cityGrid[r]||!state.cityGrid[r][c]){if(!state.cityGrid[r])state.cityGrid[r]=[];state.cityGrid[r][c]=[];}
    const cnt=state.cityGrid[r][c].length;
    if(cnt<minCount){minCount=cnt;targetR=r;targetC=c;}
  }}
  // 9-per-cell cap — only use cells within owned land count
  const totalOwnedCells=state.landCells||1;
  let usableCells=0;
  for(let r=0;r<gs;r++)for(let c2=0;c2<gs;c2++){if(usableCells<totalOwnedCells&&state.cityGrid[r]&&state.cityGrid[r][c2])usableCells++;}
  if(minCount>=9){
    // All owned cells full — need to buy more land
    if(usableCells>=totalOwnedCells){notify("All land is full! Buy more land to expand.");return;}
    // Find any cell with fewer than 9
    for(let r=0;r<state.cityGrid.length;r++){
      for(let c2=0;c2<(state.cityGrid[r]||[]).length;c2++){
        if(state.cityGrid[r][c2].length<9){targetR=r;targetC=c2;minCount=state.cityGrid[r][c2].length;break;}
      }
      if(minCount<9)break;
    }
    if(minCount>=9){notify("City Full! Buy more land.");return;}
  }
  state.cityGrid[targetR][targetC].push({
    id:state.nextBuildingId++,
    type:PROPERTIES[propIdx].type,
    tier:propIdx,
    level:1,
    builtAt:Date.now()
  });
  invalidateBuildingCache();
}
function rebuildCityGrid(){
  const gs=getGridSize();
  initCityGrid(gs);
  for(let p=0;p<PROPERTIES.length;p++){
    for(let k=0;k<state.properties[p];k++) placeBuilding(p);
  }
  // Clear builtAt on rebuild so scaffolding doesn't freeze in cache
  for(let r=0;r<gs;r++)for(let c2=0;c2<gs;c2++){
    if(state.cityGrid[r]&&state.cityGrid[r][c2])state.cityGrid[r][c2].forEach(b=>{b.builtAt=0;});
  }
}
function getCellGroundColor(buildings){
  if(buildings.length===0)return'#161e28';
  const maxTier=Math.max(...buildings.map(b=>b.tier));
  if(maxTier<=2)return'#1a3420';if(maxTier<=5)return'#252540';
  if(maxTier<=8)return'#1e2e3e';if(maxTier<=11)return'#2a1e44';
  return'#351a50';
}
// ── Cell ground decoration: noise texture, sidewalks, lot markings, trees ──
function drawCellGround(c,cx,cy,cw,ch,buildingCount,row,col){
  // Seeded hash for stable per-cell randomness
  const hash=(row*97+col*53+7);
  function seededRand(i){return(((hash*1103515245+i*12345+1)>>>16)&0x7fff)/0x7fff;}
  // 1. Ground noise texture — random dots breaking flat color
  const dotCount=Math.max(4,Math.floor(cw*ch*0.003));
  for(let i=0;i<dotCount;i++){
    const gx=cx+2+(seededRand(i*3)*(cw-4))|0;
    const gy=cy+2+(seededRand(i*3+1)*(ch-4))|0;
    const brightness=seededRand(i*3+2);
    if(buildingCount===0){
      c.fillStyle=brightness>0.5?'rgba(30,70,35,0.2)':'rgba(20,50,25,0.15)';
    }else{
      c.fillStyle=brightness>0.5?'rgba(60,70,60,0.15)':'rgba(40,55,45,0.12)';
    }
    c.fillRect(gx,gy,1,1);
  }
  if(buildingCount===0){
    // Empty cell: grass tufts and subtle "undeveloped" feel
    c.fillStyle='rgba(34,90,40,0.18)';
    for(let i=0;i<5;i++){
      const gx=cx+6+((hash*13+i*47)%Math.max(1,Math.floor(cw-12)));
      const gy=cy+6+((hash*7+i*31)%Math.max(1,Math.floor(ch-12)));
      c.fillRect(gx,gy,1,3);c.fillRect(gx+2,gy+1,1,2);
    }
    // Larger grass patches
    if(cw>60){
      for(let i=0;i<2;i++){
        const px=cx+15+((hash*19+i*67)%Math.max(1,Math.floor(cw-30)));
        const py=cy+15+((hash*23+i*43)%Math.max(1,Math.floor(ch-30)));
        c.fillStyle='rgba(30,100,38,0.12)';
        c.beginPath();c.arc(px,py,Math.max(3,cw*.04),0,Math.PI*2);c.fill();
      }
    }
    return;
  }
  // 2. Inner sidewalk border for occupied cells
  const inset=3;
  c.fillStyle='rgba(100,105,95,0.18)';
  c.fillRect(cx+inset,cy+inset,cw-inset*2,1);
  c.fillRect(cx+inset,cy+ch-inset-1,cw-inset*2,1);
  c.fillRect(cx+inset,cy+inset,1,ch-inset*2);
  c.fillRect(cx+cw-inset-1,cy+inset,1,ch-inset*2);
  // 3. Lot markings for sparse cells (faint grid = "zoned for development")
  if(buildingCount>=1&&buildingCount<=5&&cw>60){
    c.strokeStyle='rgba(255,255,255,0.04)';c.lineWidth=1;c.setLineDash([3,5]);
    const step=cw/3;
    for(let i=1;i<3;i++){
      c.beginPath();c.moveTo(cx+i*step,cy+inset+2);c.lineTo(cx+i*step,cy+ch-inset-2);c.stroke();
      c.beginPath();c.moveTo(cx+inset+2,cy+i*step);c.lineTo(cx+cw-inset-2,cy+i*step);c.stroke();
    }
    c.setLineDash([]);
  }
  // 4. Trees in empty corners (more trees when fewer buildings)
  const maxTrees=Math.max(0,Math.min(3,4-Math.floor(buildingCount/2)));
  if(cw>50&&maxTrees>0){
    const treePositions=[[cw-12,ch-12],[10,ch-14],[cw-14,ch*.5]];
    for(let i=0;i<maxTrees;i++){
      const tx=cx+treePositions[i][0],ty=cy+treePositions[i][1];
      if((hash+i)%4<3){ // skip some trees for variety
        const sz=Math.max(3,Math.min(5,cw*.03));
        c.fillStyle='rgba(75,50,20,0.3)';c.fillRect(Math.round(tx),Math.round(ty+sz),Math.max(1,sz*.4),Math.round(sz*1.2));
        c.fillStyle='rgba(35,130,48,0.35)';c.beginPath();c.arc(tx+sz*.2,ty+sz*.3,sz,0,Math.PI*2);c.fill();
      }
    }
  }
}
function getMicroSlotPos(cellX,cellY,cellW,cellH,idx,count){
  const layout=getMicroLayout(cellW,cellH,count);
  const pad=2,slotW=(cellW-pad*2)/layout.cols,slotH=(cellH-pad*2)/layout.rows;
  const col=idx%layout.cols,row=Math.floor(idx/layout.cols);
  return{x:cellX+pad+col*slotW+slotW/2,y:cellY+pad+row*slotH+slotH/2,w:slotW,h:slotH};
}

// ╔══════════════════════════════════════════════╗
// ║      SECTION: MICRO BUILDING SPRITES         ║
// ╚══════════════════════════════════════════════╝
const MAX_SPRITE_PX=56; // Larger sprites for 2.5D depth
function drawMicroBuilding(c,type,x,y,w,h,bld){
  const s=Math.min(Math.min(w,h)*0.9, MAX_SPRITE_PX);
  if(bld&&bld.builtAt&&Date.now()-bld.builtAt<1500){drawScaffolding(c,x,y,s,bld);return;}
  c.save();
  // Warm glow behind each sprite
  c.shadowColor='rgba(255,255,200,0.4)';c.shadowBlur=Math.max(2,s*0.2);
  switch(type){
    case'parking':drawMicroParking(c,x,y,s);break;case'foodcart':drawMicroFoodCart(c,x,y,s);break;
    case'garage':drawMicroGarage(c,x,y,s);break;case'apartment':drawMicroApartment(c,x,y,s);break;
    case'restaurant':drawMicroRestaurant(c,x,y,s);break;case'laundromat':drawMicroLaundromat(c,x,y,s);break;
    case'office':drawMicroOffice(c,x,y,s);break;case'casino':drawMicroCasino(c,x,y,s);break;
    case'mall':drawMicroMall(c,x,y,s);break;case'hotel':drawMicroHotel(c,x,y,s);break;
    case'stadium':drawMicroStadium(c,x,y,s);break;case'skyscraper':drawMicroSkyscraper(c,x,y,s);break;
    case'cityblock':drawMicroCityBlock(c,x,y,s);break;case'airport':drawMicroAirport(c,x,y,s);break;
    case'resort':drawMicroResort(c,x,y,s);break;case'spaceport':drawMicroSpacePort(c,x,y,s);break;
    case'orbitalhotel':drawMicroOrbitalHotel(c,x,y,s);break;case'floatingcity':drawMicroFloatingCity(c,x,y,s);break;
    case'moonbase':drawMicroMoonBase(c,x,y,s);break;case'marscolony':drawMicroMarsColony(c,x,y,s);break;
  }
  c.restore();
}
function drawScaffolding(c,x,y,s,bld){
  const elapsed=Date.now()-bld.builtAt,progress=Math.min(elapsed/1500,1);
  if(progress<0.5){
    const a=progress*2;c.globalAlpha=a;c.strokeStyle='#f59e0b';c.lineWidth=1;
    c.beginPath();c.moveTo(x-s*.3,y+s*.4);c.lineTo(x-s*.3,y-s*.4);c.moveTo(x+s*.3,y+s*.4);c.lineTo(x+s*.3,y-s*.4);
    c.moveTo(x-s*.3,y);c.lineTo(x+s*.3,y);c.moveTo(x-s*.3,y-s*.2);c.lineTo(x+s*.3,y-s*.2);c.stroke();
    c.globalAlpha=1;
  }else{
    const bp=(progress-0.5)*2;c.globalAlpha=1-bp;c.strokeStyle='#f59e0b';c.lineWidth=1;
    c.beginPath();c.moveTo(x-s*.3,y+s*.4);c.lineTo(x-s*.3,y-s*.4);c.moveTo(x+s*.3,y+s*.4);c.lineTo(x+s*.3,y-s*.4);c.stroke();
    c.globalAlpha=bp;
    drawMicroBuilding(c,bld.type,x,y,s/0.9,s/0.9,null);
    c.globalAlpha=1;
  }
}
// ── 2.5D building helpers ──
function _outline(c,x,y,w,h,fill,stroke){
  const rx=Math.round(x),ry=Math.round(y),rw=Math.round(w),rh=Math.round(h);
  c.fillStyle=stroke||'#222';c.fillRect(rx-1,ry-1,rw+2,rh+2);
  c.fillStyle=fill;c.fillRect(rx,ry,rw,rh);
}
function _3dBox(c,x,y,w,h,depth,frontColor,sideColor,topColor){
  const d=Math.round(depth);
  // Drop shadow
  c.fillStyle='rgba(0,0,0,0.25)';
  c.beginPath();c.ellipse(x+w/2+d/2,y+h+2,w*0.55,d*0.6,0,0,Math.PI*2);c.fill();
  // Side face (right)
  c.fillStyle=sideColor;
  c.beginPath();c.moveTo(x+w,y);c.lineTo(x+w+d,y-d);c.lineTo(x+w+d,y+h-d);c.lineTo(x+w,y+h);c.closePath();c.fill();
  // Top face
  c.fillStyle=topColor;
  c.beginPath();c.moveTo(x,y);c.lineTo(x+d,y-d);c.lineTo(x+w+d,y-d);c.lineTo(x+w,y);c.closePath();c.fill();
  // Front face with gradient
  const grad=c.createLinearGradient(x,y,x,y+h);
  grad.addColorStop(0,_lighten(frontColor,15));
  grad.addColorStop(1,frontColor);
  c.fillStyle=grad;
  c.fillRect(x,y,w,h);
  // Top edge highlight
  c.fillStyle='rgba(255,255,255,0.12)';
  c.fillRect(x,y,w,Math.max(1,h*0.06));
}
function _lighten(hex,pct){
  let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  r=Math.min(255,r+pct);g=Math.min(255,g+pct);b=Math.min(255,b+pct);
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
}
function _darken(hex,pct){
  let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  r=Math.max(0,r-pct);g=Math.max(0,g-pct);b=Math.max(0,b-pct);
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
}
// ── Premium sprite helpers ──
function _windowGrid(c,x,y,cols,rows,cellW,cellH,litPct){
  for(let r=0;r<rows;r++)for(let cl=0;cl<cols;cl++){
    const wx=x+cl*cellW,wy=y+r*cellH;
    const lit=Math.random()<(litPct||0.6);
    if(lit){
      c.fillStyle=Math.random()>0.3?'rgba(253,230,138,.85)':'rgba(255,200,100,.7)';
    }else{
      c.fillStyle='rgba(51,65,85,.7)';
    }
    c.fillRect(Math.round(wx),Math.round(wy),Math.round(cellW-1),Math.round(cellH-1));
    // Subtle curtain shadow
    if(!lit){c.fillStyle='rgba(0,0,0,.15)';c.fillRect(Math.round(wx),Math.round(wy),Math.round(cellW*.4),Math.round(cellH-1));}
  }
}
function _brickTexture(c,x,y,w,h,color){
  c.fillStyle=color;c.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.round(h));
  const mortar=_darken(color,25);
  c.fillStyle=mortar;
  const rowH=Math.max(3,h/5);
  for(let r=0;r<5;r++){
    c.fillRect(Math.round(x),Math.round(y+r*rowH),Math.round(w),1);
    const offset=r%2===0?0:w/4;
    for(let col=0;col<3;col++){
      c.fillRect(Math.round(x+offset+col*w/2),Math.round(y+r*rowH),1,Math.round(rowH));
    }
  }
}
function _glassReflection(c,x,y,w,h){
  const g=c.createLinearGradient(x,y,x+w,y);
  g.addColorStop(0,'rgba(255,255,255,0)');g.addColorStop(0.3,'rgba(255,255,255,.15)');
  g.addColorStop(0.5,'rgba(255,255,255,.08)');g.addColorStop(1,'rgba(255,255,255,0)');
  c.fillStyle=g;c.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.round(h));
  // Diagonal streak
  c.save();c.globalAlpha=0.06;c.fillStyle='#fff';
  c.beginPath();c.moveTo(x+w*.2,y);c.lineTo(x+w*.35,y);c.lineTo(x+w*.6,y+h);c.lineTo(x+w*.45,y+h);c.closePath();c.fill();
  c.restore();
}
function _roofPitched(c,x,y,w,h,color){
  // Main roof
  c.fillStyle=color;
  c.beginPath();c.moveTo(x,y+h);c.lineTo(x+w/2,y);c.lineTo(x+w,y+h);c.closePath();c.fill();
  // Side shading
  c.fillStyle=_darken(color,30);
  c.beginPath();c.moveTo(x+w/2,y);c.lineTo(x+w,y+h);c.lineTo(x+w/2,y+h*.6);c.closePath();c.fill();
  // Highlight
  c.fillStyle='rgba(255,255,255,.1)';
  c.beginPath();c.moveTo(x+w*.15,y+h*.8);c.lineTo(x+w/2,y+h*.08);c.lineTo(x+w*.35,y+h*.6);c.closePath();c.fill();
}
function _specularHighlight(c,x,y,w,h){
  c.save();c.globalAlpha=0.15;c.fillStyle='#fff';
  c.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.max(1,Math.round(h)));
  c.restore();
}
function drawMicroParking(c,x,y,s){
  const w=s*.88,h=s*.5,d=s*.12;
  // Asphalt gradient slab
  const asphaltGrad=c.createLinearGradient(x-w/2,y-h/2,x-w/2,y+h/2);
  asphaltGrad.addColorStop(0,'#4a4e55');asphaltGrad.addColorStop(1,'#2a2d33');
  _3dBox(c,x-w/2,y-h/2,w,h,d,'#3a3e45','#2a2d33','#4a4e55');
  c.fillStyle=asphaltGrad;c.fillRect(Math.round(x-w/2),Math.round(y-h/2),Math.round(w),Math.round(h));
  // Worn parking lines
  c.fillStyle='rgba(255,255,255,0.35)';
  const spaces=Math.max(2,Math.min(4,Math.floor(s/10)));
  const spW=w/spaces;
  for(let i=0;i<=spaces;i++){
    c.fillRect(Math.round(x-w/2+i*spW),Math.round(y-h/2+2),1,Math.round(h-4));
    // Dashed center lines
    if(i<spaces){for(let d2=0;d2<3;d2++)c.fillRect(Math.round(x-w/2+i*spW+spW/2-.5),Math.round(y-h/2+4+d2*h*.3),1,Math.round(h*.15));}
  }
  // Curb edge
  c.fillStyle='rgba(200,200,200,.4)';c.fillRect(Math.round(x-w/2),Math.round(y+h/2-2),Math.round(w),2);
  // 3D diverse cars with chrome highlights
  const carColors=['#ef4444','#3b82f6','#fbbf24','#22c55e'];
  const carW=[.55,.5,.6,.45];
  for(let i=0;i<Math.min(spaces,4);i++){
    const cx2=x-w/2+i*spW+spW/2,cy=y-h*.1;
    c.fillStyle='rgba(0,0,0,0.2)';c.beginPath();c.ellipse(cx2,cy+s*.07,s*.065,s*.02,0,0,Math.PI*2);c.fill();
    const cw=spW*(carW[i%4]),ch=s*.12;
    // Car body gradient
    const carGrad=c.createLinearGradient(cx2-cw/2,cy-ch/2,cx2-cw/2,cy+ch/2);
    carGrad.addColorStop(0,_lighten(carColors[i%4],20));carGrad.addColorStop(1,_darken(carColors[i%4],30));
    c.fillStyle=carGrad;c.fillRect(Math.round(cx2-cw/2),Math.round(cy-ch/2),Math.round(cw),Math.round(ch));
    // Windshield
    c.fillStyle='rgba(160,210,255,0.6)';c.fillRect(Math.round(cx2-cw*.25),Math.round(cy-ch/2),Math.round(cw*.5),Math.max(1,ch*.35));
    // Chrome highlight
    c.fillStyle='rgba(255,255,255,0.4)';c.fillRect(Math.round(cx2-cw*.35),Math.round(cy-ch*.3),Math.round(cw*.15),1);
  }
  // Overhead lamp with glow
  c.fillStyle='rgba(255,240,180,.12)';c.beginPath();c.arc(x,y-h*.3,s*.18,0,Math.PI*2);c.fill();
  c.fillStyle='#9ca3af';c.fillRect(Math.round(x-1),Math.round(y-h/2-s*.12),2,Math.round(s*.12));
  c.fillStyle='#fde68a';c.beginPath();c.arc(x,y-h/2-s*.12,s*.03,0,Math.PI*2);c.fill();
}
function drawMicroFoodCart(c,x,y,s){
  const bw=s*.65,bh=s*.35,d=s*.08;
  // Wood-panel gradient body
  const woodGrad=c.createLinearGradient(x-bw/2,y-bh*.1,x-bw/2,y+bh*.9);
  woodGrad.addColorStop(0,'#d4a06a');woodGrad.addColorStop(1,'#8b5e3c');
  _3dBox(c,x-bw/2,y-bh*.1,bw,bh,d,'#c49456','#8b5e3c','#dab480');
  c.fillStyle=woodGrad;c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.1),Math.round(bw),Math.round(bh));
  // Wood grain lines
  c.fillStyle='rgba(100,60,20,.15)';
  for(let i=0;i<3;i++)c.fillRect(Math.round(x-bw/2+2),Math.round(y-bh*.05+i*bh*.3),Math.round(bw-4),1);
  // Scalloped awning with support poles
  const aw=bw+6,ah=s*.18;
  c.fillStyle='#dc2626';
  c.beginPath();c.moveTo(x-aw/2,y-bh*.1);c.lineTo(x-aw/2,y-bh*.1-ah);c.lineTo(x+aw/2,y-bh*.1-ah);c.lineTo(x+aw/2,y-bh*.1);
  // Scallops
  for(let i=0;i<5;i++){const sx=x+aw/2-i*aw/5;c.lineTo(sx-aw/10,y-bh*.1+ah*.15);c.lineTo(sx-aw/5,y-bh*.1);}
  c.closePath();c.fill();
  c.fillStyle='rgba(255,255,255,0.3)';
  for(let i=0;i<3;i++)c.fillRect(Math.round(x-aw*.3+i*aw*.2),Math.round(y-bh*.1-ah*.7),Math.round(aw*.1),Math.max(1,ah*.35));
  // Support poles
  c.fillStyle='#9ca3af';c.fillRect(Math.round(x-aw/2+1),Math.round(y-bh*.1-ah),1,Math.round(ah));
  c.fillRect(Math.round(x+aw/2-2),Math.round(y-bh*.1-ah),1,Math.round(ah));
  // Glowing serving window with steam wisps
  c.fillStyle='#fde68a';c.fillRect(Math.round(x-bw*.22),Math.round(y-bh*.02),Math.round(bw*.44),Math.round(bh*.5));
  c.fillStyle='rgba(255,255,255,.15)';c.fillRect(Math.round(x-bw*.22),Math.round(y-bh*.02),Math.round(bw*.44),Math.max(1,bh*.08));
  // Steam wisps
  c.fillStyle='rgba(200,200,200,.2)';
  const t=performance.now()*.002;
  c.beginPath();c.arc(x-s*.05,y-bh*.15+Math.sin(t)*2,s*.03,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.05,y-bh*.2+Math.sin(t+1)*2,s*.025,0,Math.PI*2);c.fill();
  // Detailed wheels with hubcaps
  const wr=Math.max(2,s*.065);
  c.fillStyle='#1a1a1a';
  c.beginPath();c.arc(x-bw*.28,y+bh+wr*.3,wr,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+bw*.28,y+bh+wr*.3,wr,0,Math.PI*2);c.fill();
  c.fillStyle='#9ca3af';
  c.beginPath();c.arc(x-bw*.28,y+bh+wr*.3,wr*.4,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+bw*.28,y+bh+wr*.3,wr*.4,0,Math.PI*2);c.fill();
  // Chalkboard menu
  if(s>=22){c.fillStyle='#1a2e1a';c.fillRect(Math.round(x+bw*.15),Math.round(y+bh*.05),Math.round(bw*.2),Math.round(bh*.35));
  c.fillStyle='rgba(255,255,255,.4)';c.fillRect(Math.round(x+bw*.17),Math.round(y+bh*.1),Math.round(bw*.05),1);c.fillRect(Math.round(x+bw*.17),Math.round(y+bh*.18),Math.round(bw*.1),1);}
}
function drawMicroGarage(c,x,y,s){
  const bw=s*.7,bh=s*.5,d=s*.1;
  // Brick texture body
  _3dBox(c,x-bw/2,y-bh*.2,bw,bh,d,'#c4652a','#8a3a12','#d47a3a');
  _brickTexture(c,x-bw/2,y-bh*.2,bw,bh,'#c4652a');
  // Pitched terracotta roof with tile rows
  const roofH=s*.28;
  _roofPitched(c,x-bw/2-1,y-bh*.2-roofH,bw+2,roofH,'#a0342a');
  // Tile row lines
  c.fillStyle='rgba(0,0,0,.1)';
  for(let i=1;i<4;i++)c.fillRect(Math.round(x-bw*.35),Math.round(y-bh*.2-roofH+i*roofH*.28),Math.round(bw*.35),1);
  // Metallic roller door with rivets/segments
  const dw=bw*.52,dh=bh*.65;
  const doorGrad=c.createLinearGradient(x-dw/2,0,x+dw/2,0);
  doorGrad.addColorStop(0,'#3a3a3a');doorGrad.addColorStop(0.5,'#555');doorGrad.addColorStop(1,'#3a3a3a');
  c.fillStyle=doorGrad;c.fillRect(Math.round(x-dw/2),Math.round(y-bh*.2+bh-dh),Math.round(dw),Math.round(dh));
  // Door segments
  c.fillStyle='rgba(255,255,255,0.08)';
  const segH=dh/5;
  for(let i=0;i<5;i++){c.fillRect(Math.round(x-dw/2+1),Math.round(y-bh*.2+bh-dh+i*segH),Math.round(dw-2),1);}
  // Rivets
  c.fillStyle='rgba(255,255,255,0.2)';
  for(let i=0;i<4;i++){
    c.beginPath();c.arc(x-dw*.35,y-bh*.2+bh-dh+segH*(i+.5),s*.015,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(x+dw*.35,y-bh*.2+bh-dh+segH*(i+.5),s*.015,0,Math.PI*2);c.fill();
  }
  // Warm glow under door
  c.fillStyle='rgba(255,180,60,0.35)';c.fillRect(Math.round(x-dw/2+1),Math.round(y-bh*.2+bh-2),Math.round(dw-2),3);
  c.fillStyle='rgba(255,200,80,.1)';c.beginPath();c.arc(x,y+bh*.25,dw*.4,0,Math.PI*2);c.fill();
  // Side window with cross frame
  if(s>=22){
    const ws=Math.max(4,s*.12);
    c.fillStyle='#fde68a';c.fillRect(Math.round(x+bw*.18),Math.round(y-bh*.05),Math.round(ws),Math.round(ws));
    c.fillStyle='#7a3a12';c.fillRect(Math.round(x+bw*.18+ws/2-.5),Math.round(y-bh*.05),1,Math.round(ws));
    c.fillRect(Math.round(x+bw*.18),Math.round(y-bh*.05+ws/2-.5),Math.round(ws),1);
  }
}
function drawMicroApartment(c,x,y,s){
  const bw=s*.5,bh=s*.82,d=s*.1;
  // Blue gradient facade
  const facadeGrad=c.createLinearGradient(x-bw/2,y-bh*.42,x-bw/2,y+bh*.4);
  facadeGrad.addColorStop(0,'#3b82f6');facadeGrad.addColorStop(1,'#1e40af');
  _3dBox(c,x-bw/2,y-bh*.42,bw,bh,d,'#2563eb','#162d6b','#3b82f6');
  c.fillStyle=facadeGrad;c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.42),Math.round(bw),Math.round(bh));
  // Ambient occlusion at edges
  c.fillStyle='rgba(0,0,0,.12)';c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.42),2,Math.round(bh));
  c.fillRect(Math.round(x+bw/2-2),Math.round(y-bh*.42),2,Math.round(bh));
  // 3x4 window grid (random warm/cool/dark)
  const cols=3,rows=4;
  const ww=Math.max(3,bw*.18),wh=Math.max(2,bh*.06);
  const gapX=(bw-cols*ww)/(cols+1),gapY=(bh*.7-rows*wh)/(rows+1);
  _windowGrid(c,x-bw/2+gapX,y-bh*.36+gapY,cols,rows,ww+gapX,wh+gapY,0.6);
  // Balcony ledges with railings
  for(let r=0;r<rows;r++){
    const wy=y-bh*.36+gapY+r*(wh+gapY)+wh;
    c.fillStyle='rgba(200,210,220,.3)';c.fillRect(Math.round(x-bw/2+2),Math.round(wy),Math.round(bw-4),Math.max(1,s*.02));
    // Railing dots
    if(s>=20){c.fillStyle='rgba(255,255,255,.15)';for(let i=0;i<4;i++)c.fillRect(Math.round(x-bw*.3+i*bw*.2),Math.round(wy+1),1,Math.max(1,s*.015));}
  }
  // Fire escape on side
  c.fillStyle='rgba(100,100,100,.25)';
  for(let r=0;r<3;r++){c.fillRect(Math.round(x+bw/2-1),Math.round(y-bh*.3+r*bh*.2),Math.round(d*.6),Math.round(bh*.12));}
  // Rooftop AC units
  c.fillStyle='#94a3b8';c.fillRect(Math.round(x-bw*.2),Math.round(y-bh*.44),Math.round(s*.08),Math.round(s*.04));
  c.fillRect(Math.round(x+bw*.08),Math.round(y-bh*.44),Math.round(s*.06),Math.round(s*.035));
  // Entrance canopy
  const dw=Math.max(4,bw*.32),dh=Math.max(5,bh*.1);
  c.fillStyle='#1e40af';c.fillRect(Math.round(x-dw/2-2),Math.round(y+bh*.34),Math.round(dw+4),3);
  c.fillStyle='#7dd3fc';c.fillRect(Math.round(x-dw/2),Math.round(y+bh*.35),Math.round(dw),Math.round(dh));
  _specularHighlight(c,x-dw/2,y+bh*.35,dw,1);
}
function drawMicroRestaurant(c,x,y,s){
  const bw=s*.72,bh=s*.48,d=s*.09;
  // Stucco gradient walls
  const stuccoGrad=c.createLinearGradient(x-bw/2,y-bh*.15,x-bw/2,y+bh*.75);
  stuccoGrad.addColorStop(0,'#faf0d8');stuccoGrad.addColorStop(1,'#e8d5b0');
  _3dBox(c,x-bw/2,y-bh*.15,bw,bh,d,'#f5e6c8','#c0a070','#faf0d8');
  c.fillStyle=stuccoGrad;c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.15),Math.round(bw),Math.round(bh));
  // Scalloped awning with metal frame
  const aw=bw+4,ah=Math.max(4,s*.14);
  c.fillStyle='#dc2626';
  c.beginPath();c.moveTo(x-aw/2,y-bh*.15-ah);c.lineTo(x+aw/2,y-bh*.15-ah);c.lineTo(x+aw/2,y-bh*.15);
  for(let i=0;i<5;i++){const sx2=x+aw/2-i*aw/5;c.lineTo(sx2-aw/10,y-bh*.15+ah*.12);c.lineTo(sx2-aw/5,y-bh*.15);}
  c.closePath();c.fill();
  c.fillStyle='rgba(255,255,255,0.25)';for(let i=0;i<3;i++)c.fillRect(Math.round(x-aw*.3+i*aw*.22),Math.round(y-bh*.15-ah*.8),Math.round(aw*.08),Math.round(ah*.5));
  // Metal frame line
  c.fillStyle='#9ca3af';c.fillRect(Math.round(x-aw/2),Math.round(y-bh*.15-ah-1),Math.round(aw),1);
  // Floor-to-ceiling windows with table silhouettes
  const ww=Math.max(4,bw*.2),wh=Math.max(3,bh*.55);
  c.fillStyle='rgba(253,230,138,.7)';
  c.fillRect(Math.round(x-bw*.34),Math.round(y-bh*.05),Math.round(ww),Math.round(wh));
  c.fillRect(Math.round(x+bw*.14),Math.round(y-bh*.05),Math.round(ww),Math.round(wh));
  _glassReflection(c,x-bw*.34,y-bh*.05,ww,wh);
  _glassReflection(c,x+bw*.14,y-bh*.05,ww,wh);
  // Table silhouettes inside
  if(s>=22){c.fillStyle='rgba(120,80,40,.2)';c.fillRect(Math.round(x-bw*.28),Math.round(y+bh*.25),Math.round(s*.06),Math.round(s*.03));c.fillRect(Math.round(x+bw*.2),Math.round(y+bh*.25),Math.round(s*.06),Math.round(s*.03));}
  // Ornate wood door
  const dw=Math.max(4,bw*.15),dh2=Math.max(5,bh*.45);
  c.fillStyle='#7c2d12';c.fillRect(Math.round(x-dw/2),Math.round(y+bh*.2),Math.round(dw),Math.round(dh2));
  c.fillStyle='#92400e';c.fillRect(Math.round(x-dw/2+1),Math.round(y+bh*.22),Math.round(dw-2),Math.round(dh2*.7));
  c.fillStyle='#fbbf24';c.beginPath();c.arc(x+dw*.2,y+bh*.4,s*.02,0,Math.PI*2);c.fill();
  // Sidewalk tables
  if(s>=20){c.fillStyle='rgba(180,160,120,.3)';c.fillRect(Math.round(x-bw*.45),Math.round(y+bh*.7),Math.round(s*.04),Math.round(s*.04));c.fillRect(Math.round(x+bw*.35),Math.round(y+bh*.7),Math.round(s*.04),Math.round(s*.04));}
  // Potted plants
  c.fillStyle='#22c55e';c.beginPath();c.arc(x-bw*.42,y+bh*.65,s*.03,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+bw*.42,y+bh*.65,s*.03,0,Math.PI*2);c.fill();
  c.fillStyle='#92400e';c.fillRect(Math.round(x-bw*.44),Math.round(y+bh*.67),Math.round(s*.05),Math.round(s*.03));
  c.fillRect(Math.round(x+bw*.4),Math.round(y+bh*.67),Math.round(s*.05),Math.round(s*.03));
}
function drawMicroLaundromat(c,x,y,s){
  const bw=s*.72,bh=s*.6,d=s*.09;
  _3dBox(c,x-bw/2,y-bh*.2,bw,bh,d,'#7dd3fc','#0369a1','#a5d8ff');
  // Glass storefront
  c.fillStyle='rgba(186,230,253,.4)';c.fillRect(Math.round(x-bw/2+2),Math.round(y-bh*.12),Math.round(bw-4),Math.round(bh*.6));
  _glassReflection(c,x-bw/2+2,y-bh*.12,bw-4,bh*.6);
  // Tile floor pattern
  c.fillStyle='rgba(255,255,255,.08)';
  for(let i=0;i<4;i++)c.fillRect(Math.round(x-bw/2+3+i*(bw/4)),Math.round(y+bh*.4),Math.round(bw/4-1),Math.round(bh*.12));
  // 4 washers with circular glass doors
  const wr=s*.09,washerGap=bw*.22;
  for(let i=0;i<4;i++){
    const wx2=x-bw*.32+i*washerGap;
    c.fillStyle='#e0f2fe';c.fillRect(Math.round(wx2-wr),Math.round(y-s*.02),Math.round(wr*2),Math.round(wr*2.2));
    // Circular door
    c.fillStyle='#bae6fd';c.strokeStyle='#0369a1';c.lineWidth=1;
    c.beginPath();c.arc(wx2,y+s*.08,wr*.7,0,Math.PI*2);c.fill();c.stroke();
    c.fillStyle='#38bdf8';c.beginPath();c.arc(wx2,y+s*.08,wr*.35,0,Math.PI*2);c.fill();
    // Glass shine
    c.fillStyle='rgba(255,255,255,.3)';c.beginPath();c.arc(wx2-wr*.15,y+s*.06,wr*.15,0,Math.PI*2);c.fill();
  }
  // Neon "OPEN" sign (pink glow)
  c.fillStyle='rgba(236,72,153,.2)';c.beginPath();c.arc(x,y-bh*.15,s*.1,0,Math.PI*2);c.fill();
  c.fillStyle='#ec4899';c.font='bold '+Math.max(5,s*.08)+'px sans-serif';c.textAlign='center';c.textBaseline='middle';
  c.fillText('OPEN',x,y-bh*.16);
  // Steam rising
  c.fillStyle='rgba(200,220,240,.15)';
  const t=performance.now()*.002;
  c.beginPath();c.arc(x-s*.1,y-bh*.25+Math.sin(t)*2,s*.04,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.08,y-bh*.28+Math.sin(t+1.5)*2,s*.035,0,Math.PI*2);c.fill();
}
function drawMicroOffice(c,x,y,s){
  const bw=s*.5,bh=s*.85,d=s*.1;
  _3dBox(c,x-bw/2,y-bh*.4,bw,bh,d,'#4b6584','#2c3e50','#5a7a9a');
  // Glass curtain wall with reflection gradient
  c.fillStyle='rgba(116,185,255,0.25)';c.fillRect(Math.round(x-bw/2+2),Math.round(y-bh*.35),Math.round(bw-4),Math.round(bh*.72));
  _glassReflection(c,x-bw/2+2,y-bh*.35,bw-4,bh*.72);
  // Steel frame columns
  c.fillStyle='rgba(44,62,80,0.5)';
  c.fillRect(Math.round(x-bw/2+1),Math.round(y-bh*.35),2,Math.round(bh*.72));
  c.fillRect(Math.round(x+bw/2-3),Math.round(y-bh*.35),2,Math.round(bh*.72));
  c.fillRect(Math.round(x-1),Math.round(y-bh*.35),2,Math.round(bh*.72));
  // Window grid (some lit, some dark)
  _windowGrid(c,x-bw/2+4,y-bh*.33,2,4,bw*.43,bh*.15,0.5);
  // Revolving door
  c.fillStyle='#334155';c.fillRect(Math.round(x-bw*.12),Math.round(y+bh*.28),Math.round(bw*.24),Math.round(bh*.1));
  c.fillStyle='rgba(160,200,240,.4)';c.beginPath();c.arc(x,y+bh*.32,bw*.08,0,Math.PI*2);c.fill();
  // Rooftop helipad "H"
  c.fillStyle='rgba(255,255,255,.12)';c.beginPath();c.arc(x,y-bh*.42,bw*.25,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,.3)';c.font='bold '+Math.max(5,s*.1)+'px sans-serif';c.textAlign='center';c.textBaseline='middle';
  c.fillText('H',x,y-bh*.41);
  // Antenna array
  c.strokeStyle='#dfe6e9';c.lineWidth=1;
  c.beginPath();c.moveTo(x-bw*.15,y-bh*.4);c.lineTo(x-bw*.15,y-bh*.4-s*.1);c.stroke();
  c.beginPath();c.moveTo(x+bw*.15,y-bh*.4);c.lineTo(x+bw*.15,y-bh*.4-s*.08);c.stroke();
  c.beginPath();c.moveTo(x,y-bh*.4);c.lineTo(x,y-bh*.4-s*.14);c.stroke();
}
function drawMicroCasino(c,x,y,s){
  const bw=s*.72,bh=s*.55,d=s*.1;
  // Art deco purple body
  const purpGrad=c.createLinearGradient(x-bw/2,y-bh*.15,x-bw/2,y+bh*.65);
  purpGrad.addColorStop(0,'#8b5cf6');purpGrad.addColorStop(1,'#4c1d95');
  _3dBox(c,x-bw/2,y-bh*.15,bw,bh,d,'#6c3ce0','#3b0764','#8b5cf6');
  c.fillStyle=purpGrad;c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.15),Math.round(bw),Math.round(bh));
  // Gold trim art deco patterns
  c.fillStyle='#fbbf24';
  c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.17),Math.round(bw),Math.max(3,s*.05));
  c.fillRect(Math.round(x-bw/2),Math.round(y+bh*.35),Math.round(bw),Math.max(2,s*.03));
  // Art deco chevrons
  c.strokeStyle='rgba(251,191,36,.3)';c.lineWidth=1;
  for(let i=0;i<3;i++){
    const cy2=y-bh*.05+i*bh*.15;
    c.beginPath();c.moveTo(x-bw*.3,cy2);c.lineTo(x,cy2-s*.04);c.lineTo(x+bw*.3,cy2);c.stroke();
  }
  // Neon marquee with chasing lights
  c.fillStyle='rgba(251,191,36,.15)';c.fillRect(Math.round(x-bw/2-2),Math.round(y-bh*.2),Math.round(bw+4),Math.round(s*.1));
  const t=Math.floor(performance.now()/200)%8;
  for(let i=0;i<8;i++){
    c.fillStyle=i===t?'#fde047':'rgba(251,191,36,.3)';
    c.beginPath();c.arc(x-bw*.35+i*bw*.1,y-bh*.16,s*.015,0,Math.PI*2);c.fill();
  }
  // Faceted diamond sign with sparkle
  c.fillStyle='#fde047';c.beginPath();
  c.moveTo(x,y-s*.03);c.lineTo(x+s*.1,y+s*.08);c.lineTo(x,y+s*.2);c.lineTo(x-s*.1,y+s*.08);
  c.closePath();c.fill();
  // Diamond facets
  c.fillStyle='rgba(255,255,255,.2)';c.beginPath();c.moveTo(x,y-s*.03);c.lineTo(x-s*.05,y+s*.08);c.lineTo(x,y+s*.08);c.closePath();c.fill();
  // Sparkle
  const sp=performance.now()*.003;
  c.fillStyle='rgba(255,255,255,.7)';c.beginPath();c.arc(x+Math.cos(sp)*s*.06,y+s*.05+Math.sin(sp)*s*.04,s*.02,0,Math.PI*2);c.fill();
  // Velvet walls bottom
  c.fillStyle='rgba(139,0,40,.2)';c.fillRect(Math.round(x-bw/2+2),Math.round(y+bh*.2),Math.round(bw-4),Math.round(bh*.18));
  // Red carpet entrance
  c.fillStyle='#dc2626';c.fillRect(Math.round(x-s*.06),Math.round(y+bh*.38),Math.round(s*.12),Math.round(s*.08));
  c.fillStyle='rgba(255,200,60,.3)';c.fillRect(Math.round(x-s*.06),Math.round(y+bh*.38),Math.round(s*.12),1);
}
function drawMicroMall(c,x,y,s){
  const bw=s*.84,bh=s*.45,d=s*.1;
  // White panel facade
  _3dBox(c,x-bw/2,y-bh*.05,bw,bh,d,'#e5e5e5','#a0a0a0','#f5f5f5');
  c.fillStyle='#f0f0f0';c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.05),Math.round(bw),Math.round(bh));
  // Glass atrium center
  c.fillStyle='rgba(186,230,253,.35)';c.fillRect(Math.round(x-bw*.15),Math.round(y-bh*.03),Math.round(bw*.3),Math.round(bh*.5));
  _glassReflection(c,x-bw*.15,y-bh*.03,bw*.3,bh*.5);
  // Multi-storefront with different awning colors
  const awColors=['#ef4444','#3b82f6','#22c55e'];
  for(let i=-1;i<=1;i++){
    const ax=x+i*s*.27;
    c.fillStyle=awColors[i+1];
    c.beginPath();c.moveTo(ax-s*.09,y-bh*.05);c.lineTo(ax+s*.09,y-bh*.05);
    c.lineTo(ax+s*.1,y+s*.06);c.lineTo(ax-s*.1,y+s*.06);c.fill();
    // Storefront window
    c.fillStyle='rgba(253,230,138,.5)';c.fillRect(Math.round(ax-s*.07),Math.round(y+s*.06),Math.round(s*.14),Math.round(bh*.35));
  }
  // SALE banner
  c.fillStyle='#fbbf24';c.font='bold '+Math.max(4,s*.06)+'px sans-serif';c.textAlign='center';
  c.fillText('SALE',x,y-bh*.08);
  // Planters with topiary
  c.fillStyle='#7c2d12';c.fillRect(Math.round(x-bw*.4),Math.round(y+bh*.36),Math.round(s*.05),Math.round(s*.04));
  c.fillRect(Math.round(x+bw*.35),Math.round(y+bh*.36),Math.round(s*.05),Math.round(s*.04));
  c.fillStyle='#22c55e';c.beginPath();c.arc(x-bw*.38,y+bh*.33,s*.04,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+bw*.38,y+bh*.33,s*.04,0,Math.PI*2);c.fill();
  // Skylight dome on roof
  c.fillStyle='rgba(186,230,253,.3)';c.beginPath();c.arc(x,y-bh*.08,bw*.12,Math.PI,0);c.fill();
  c.strokeStyle='rgba(100,100,100,.2)';c.lineWidth=0.5;c.stroke();
  // Entrance
  c.fillStyle='#737373';c.fillRect(Math.round(x-s*.05),Math.round(y+bh*.3),Math.round(s*.1),Math.round(s*.12));
}
function drawMicroHotel(c,x,y,s){
  const bw=s*.55,bh=s*.75,d=s*.12;
  // Teal facade with gradient
  const tealGrad=c.createLinearGradient(x-bw/2,y-bh*.35,x-bw/2,y+bh*.38);
  tealGrad.addColorStop(0,'#14b8a6');tealGrad.addColorStop(1,'#0f766e');
  _3dBox(c,x-bw/2,y-bh*.35,bw,bh,d,'#0f766e','#064e3b','#14b8a6');
  c.fillStyle=tealGrad;c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.35),Math.round(bw),Math.round(bh));
  // Gold floor accent lines
  c.fillStyle='#fbbf24';
  c.fillRect(Math.round(x-bw/2),Math.round(y-bh*.35),Math.round(bw),3);
  for(let i=0;i<3;i++)c.fillRect(Math.round(x-bw/2+1),Math.round(y-bh*.15+i*bh*.18),Math.round(bw-2),1);
  // 3x5 warm windows
  _windowGrid(c,x-bw/2+3,y-bh*.28,3,5,bw*.28,bh*.1,0.7);
  // Columned portico
  const cw2=bw*.55;
  c.fillStyle='#b45309';c.fillRect(Math.round(x-cw2/2),Math.round(y+bh*.28),Math.round(cw2),Math.max(3,s*.06));
  c.fillStyle='#d4a06a';
  c.fillRect(Math.round(x-cw2/2+2),Math.round(y+bh*.28+s*.04),2,Math.round(bh*.1));
  c.fillRect(Math.round(x+cw2/2-4),Math.round(y+bh*.28+s*.04),2,Math.round(bh*.1));
  // Doorman silhouette
  if(s>=22){c.fillStyle='rgba(0,0,0,.3)';c.fillRect(Math.round(x+cw2*.2),Math.round(y+bh*.3),Math.round(s*.03),Math.round(s*.06));}
  // Red carpet
  c.fillStyle='#dc2626';c.fillRect(Math.round(x-s*.04),Math.round(y+bh*.35),Math.round(s*.08),Math.round(s*.07));
  // Ornate gold canopy
  c.fillStyle='rgba(251,191,36,.15)';c.fillRect(Math.round(x-cw2/2),Math.round(y+bh*.26),Math.round(cw2),Math.round(s*.04));
  _specularHighlight(c,x-cw2/2,y+bh*.26,cw2,2);
  // Door
  c.fillStyle='#1a1a1a';c.fillRect(Math.round(x-bw*.08),Math.round(y+bh*.3),Math.round(bw*.16),Math.round(bh*.1));
  // Rooftop star with glow
  c.fillStyle='rgba(251,191,36,.15)';c.beginPath();c.arc(x,y-bh*.38,s*.1,0,Math.PI*2);c.fill();
  c.fillStyle='#fbbf24';
  const sx2=x,sy2=y-bh*.38;
  c.beginPath();
  for(let i=0;i<5;i++){
    const a=Math.PI*2*i/5-Math.PI/2,or=Math.max(3,s*.06),ir=or*.4;
    c.lineTo(sx2+Math.cos(a)*or,sy2+Math.sin(a)*or);
    c.lineTo(sx2+Math.cos(a+Math.PI/5)*ir,sy2+Math.sin(a+Math.PI/5)*ir);
  }
  c.closePath();c.fill();
}
function drawMicroStadium(c,x,y,s){
  // Drop shadow
  c.fillStyle='rgba(0,0,0,0.2)';c.beginPath();c.ellipse(x+s*.04,y+s*.14,s*.46,s*.36,0,0,Math.PI*2);c.fill();
  // Curved outer shell with gradient
  const shellGrad=c.createLinearGradient(x,y-s*.3,x,y+s*.4);
  shellGrad.addColorStop(0,'#b0bec5');shellGrad.addColorStop(1,'#455a64');
  c.fillStyle=shellGrad;c.beginPath();c.ellipse(x,y+s*.05,s*.45,s*.36,0,0,Math.PI*2);c.fill();
  c.strokeStyle='#334155';c.lineWidth=1;c.stroke();
  // Tiered seating rows
  for(let i=0;i<3;i++){
    const r=s*(.36-i*.04),ry=s*(.26-i*.03);
    c.fillStyle=_darken('#78909c',i*15);c.beginPath();c.ellipse(x,y+s*.05,r,ry,0,0,Math.PI*2);c.fill();
  }
  // Green field with yard lines
  c.fillStyle='#22c55e';c.beginPath();c.ellipse(x,y+s*.05,s*.26,s*.16,0,0,Math.PI*2);c.fill();
  c.strokeStyle='rgba(255,255,255,.5)';c.lineWidth=0.5;
  c.beginPath();c.moveTo(x,y-s*.1);c.lineTo(x,y+s*.2);c.stroke();
  c.beginPath();c.ellipse(x,y+s*.05,s*.08,s*.05,0,0,Math.PI*2);c.stroke();
  // Scoreboard panel
  c.fillStyle='#1e293b';c.fillRect(Math.round(x-s*.1),Math.round(y-s*.35),Math.round(s*.2),Math.round(s*.06));
  c.fillStyle='#fde047';c.font='bold '+Math.max(3,s*.04)+'px sans-serif';c.textAlign='center';c.fillText('0-0',x,y-s*.31);
  // Colored fan dots
  if(s>=18){
    const fanColors=['#ef4444','#3b82f6','#fbbf24'];
    for(let i=0;i<8;i++){
      const angle=Math.PI*2*i/8;
      c.fillStyle=fanColors[i%3];c.beginPath();c.arc(x+Math.cos(angle)*s*.32,y+s*.05+Math.sin(angle)*s*.22,s*.015,0,Math.PI*2);c.fill();
    }
  }
  // 4 floodlight towers with light cones
  const towers=[[-s*.42,-.34],[s*.4,-.34],[-s*.38,.3],[s*.38,.3]];
  for(const[tx,ty]of towers){
    c.fillStyle='#94a3b8';c.fillRect(Math.round(x+tx),Math.round(y+ty*s),Math.round(s*.03),Math.round(s*.18));
    c.fillStyle='rgba(253,224,71,.2)';c.beginPath();c.arc(x+tx+s*.015,y+ty*s,s*.05,0,Math.PI*2);c.fill();
    c.fillStyle='#fde047';c.beginPath();c.arc(x+tx+s*.015,y+ty*s,s*.02,0,Math.PI*2);c.fill();
  }
}
function drawMicroSkyscraper(c,x,y,s){
  // Tapered glass tower (wide base→narrow top)
  const bwBase=s*.38,bwTop=s*.24,bh=s*.9,d=s*.1;
  // Gradient dark→light blue
  const towerGrad=c.createLinearGradient(x,y+bh*.4,x,y-bh*.42);
  towerGrad.addColorStop(0,'#172554');towerGrad.addColorStop(1,'#3b82f6');
  // Tapered shape
  c.fillStyle='rgba(0,0,0,.2)';c.beginPath();c.ellipse(x+d/2,y+bh*.42,bwBase*.55,d*.5,0,0,Math.PI*2);c.fill();
  c.fillStyle=towerGrad;
  c.beginPath();c.moveTo(x-bwBase/2,y+bh*.4);c.lineTo(x-bwTop/2,y-bh*.42);c.lineTo(x+bwTop/2,y-bh*.42);c.lineTo(x+bwBase/2,y+bh*.4);c.closePath();c.fill();
  // Side face
  c.fillStyle='#162050';
  c.beginPath();c.moveTo(x+bwBase/2,y+bh*.4);c.lineTo(x+bwTop/2,y-bh*.42);c.lineTo(x+bwTop/2+d,y-bh*.42-d);c.lineTo(x+bwBase/2+d,y+bh*.4-d);c.closePath();c.fill();
  // Glass reflection
  _glassReflection(c,x-bwBase*.35,y-bh*.35,bwBase*.7,bh*.72);
  // Window grid
  _windowGrid(c,x-bwBase*.3,y-bh*.35,2,6,bwBase*.3,bh*.1,0.5);
  // Setback terraces with greenery
  c.fillStyle='#1e3a8a';c.fillRect(Math.round(x-bwBase*.35),Math.round(y),Math.round(bwBase*.7),3);
  c.fillStyle='#22c55e';c.fillRect(Math.round(x-bwBase*.3),Math.round(y-2),Math.round(bwBase*.15),3);
  c.fillRect(Math.round(x+bwBase*.15),Math.round(y-2),Math.round(bwBase*.15),3);
  // Sky lounge bright at top
  c.fillStyle='rgba(253,230,138,.6)';c.fillRect(Math.round(x-bwTop*.35),Math.round(y-bh*.38),Math.round(bwTop*.7),Math.round(bh*.06));
  // Spire with blinking red light
  c.strokeStyle='#94a3b8';c.lineWidth=1;c.beginPath();c.moveTo(x,y-bh*.42);c.lineTo(x,y-bh*.42-s*.2);c.stroke();
  const blink=Math.sin(performance.now()*.005)>0;
  if(blink){c.fillStyle='#ef4444';c.beginPath();c.arc(x,y-bh*.42-s*.2,s*.025,0,Math.PI*2);c.fill();}
}
function drawMicroCityBlock(c,x,y,s){
  // 4-5 varied buildings (different heights/styles)
  const d=s*.07;
  _3dBox(c,x-s*.42,y,s*.18,s*.38,d,'#78909c','#455a64','#90a4ae');
  _3dBox(c,x-s*.2,y-s*.15,s*.16,s*.53,d,'#5c6bc0','#3949ab','#7986cb');
  _3dBox(c,x-s*.01,y-s*.35,s*.14,s*.73,d,'#42a5f5','#1976d2','#64b5f6');
  _3dBox(c,x+s*.16,y-s*.1,s*.2,s*.48,d,'#ef5350','#c62828','#ef9a9a');
  _3dBox(c,x+s*.32,y-s*.2,s*.12,s*.58,d,'#66bb6a','#2e7d32','#a5d6a7');
  // Connecting skybridge
  c.fillStyle='rgba(200,200,200,.4)';c.fillRect(Math.round(x-s*.04),Math.round(y-s*.15),Math.round(s*.2),Math.round(s*.03));
  // Rooftop water towers
  c.fillStyle='#8d6e63';c.fillRect(Math.round(x-s*.18),Math.round(y-s*.2),Math.round(s*.05),Math.round(s*.06));
  c.fillRect(Math.round(x+s*.18),Math.round(y-s*.15),Math.round(s*.04),Math.round(s*.05));
  // Street-level shops with awnings
  c.fillStyle='#ef4444';c.fillRect(Math.round(x-s*.4),Math.round(y+s*.34),Math.round(s*.12),Math.round(s*.03));
  c.fillStyle='#fbbf24';c.fillRect(Math.round(x+s*.18),Math.round(y+s*.34),Math.round(s*.12),Math.round(s*.03));
  // Window grids on buildings
  _windowGrid(c,x-s*.18,y-s*.28,1,3,s*.1,s*.08,0.5);
  _windowGrid(c,x+s*.02,y-s*.3,1,4,s*.1,s*.08,0.6);
  // Tiny cars with headlights
  if(s>=20){
    c.fillStyle='#1e40af';c.fillRect(Math.round(x-s*.3),Math.round(y+s*.42),Math.round(s*.06),Math.round(s*.03));
    c.fillStyle='#fde047';c.beginPath();c.arc(x-s*.24,y+s*.435,s*.01,0,Math.PI*2);c.fill();
    c.fillStyle='#ef4444';c.fillRect(Math.round(x+s*.2),Math.round(y+s*.42),Math.round(s*.06),Math.round(s*.03));
    c.fillStyle='#fde047';c.beginPath();c.arc(x+s*.26,y+s*.435,s*.01,0,Math.PI*2);c.fill();
  }
}
function drawMicroAirport(c,x,y,s){
  const d=s*.07;
  // Runway with "24" marking and center line
  const rwGrad=c.createLinearGradient(x-s*.46,0,x+s*.46,0);
  rwGrad.addColorStop(0,'#1f2937');rwGrad.addColorStop(.5,'#374151');rwGrad.addColorStop(1,'#1f2937');
  c.fillStyle=rwGrad;c.fillRect(Math.round(x-s*.46),Math.round(y+s*.28),Math.round(s*.92),Math.round(s*.12));
  // Runway edge lights
  c.fillStyle='#60a5fa';
  for(let i=0;i<6;i++){c.beginPath();c.arc(x-s*.4+i*s*.16,y+s*.28,s*.012,0,Math.PI*2);c.fill();c.beginPath();c.arc(x-s*.4+i*s*.16,y+s*.4,s*.012,0,Math.PI*2);c.fill();}
  // Center dashes
  c.fillStyle='#fbbf24';
  for(let i=0;i<5;i++)c.fillRect(Math.round(x-s*.36+i*s*.16),Math.round(y+s*.33),Math.round(s*.08),Math.round(s*.02));
  // "24" marking
  if(s>=22){c.font=`bold ${Math.max(6,s*.06)}px sans-serif`;c.fillStyle='#e5e7eb';c.textAlign='center';c.fillText('24',x+s*.32,y+s*.37);}
  // Taxiway lights
  c.fillStyle='rgba(34,197,94,.4)';
  for(let i=0;i<3;i++)c.fillRect(Math.round(x-s*.15+i*s*.12),Math.round(y+s*.25),Math.round(s*.02),Math.round(s*.03));
  // Long terminal with curved roof
  const termGrad=c.createLinearGradient(x,y+s*.1,x,y-s*.12);
  termGrad.addColorStop(0,'#4b5563');termGrad.addColorStop(1,'#9ca3af');
  c.fillStyle=termGrad;
  c.beginPath();c.moveTo(x-s*.42,y+s*.12);c.lineTo(x-s*.42,y-s*.04);c.quadraticCurveTo(x-s*.1,y-s*.18,x+s*.22,y-s*.04);c.lineTo(x+s*.22,y+s*.12);c.closePath();c.fill();
  // Terminal windows
  c.fillStyle='rgba(147,197,253,.5)';
  for(let i=0;i<5;i++)c.fillRect(Math.round(x-s*.36+i*s*.12),Math.round(y),Math.round(s*.08),Math.round(s*.06));
  // Terminal side face
  c.fillStyle='#374151';
  c.beginPath();c.moveTo(x+s*.22,y+s*.12);c.lineTo(x+s*.22,y-s*.04);c.lineTo(x+s*.22+d,y-s*.04-d*.5);c.lineTo(x+s*.22+d,y+s*.12-d*.5);c.closePath();c.fill();
  // Control tower
  const twGrad=c.createLinearGradient(x+s*.32,y+s*.12,x+s*.32,y-s*.38);
  twGrad.addColorStop(0,'#6b7280');twGrad.addColorStop(1,'#d1d5db');
  c.fillStyle=twGrad;c.fillRect(Math.round(x+s*.3),Math.round(y-s*.2),Math.round(s*.08),Math.round(s*.32));
  // Tower glass cabin
  const cabGrad=c.createLinearGradient(x+s*.26,0,x+s*.42,0);
  cabGrad.addColorStop(0,'#60a5fa');cabGrad.addColorStop(1,'#1d4ed8');
  c.fillStyle=cabGrad;c.fillRect(Math.round(x+s*.26),Math.round(y-s*.32),Math.round(s*.16),Math.round(s*.1));
  // Tower roof
  c.fillStyle='#374151';c.fillRect(Math.round(x+s*.24),Math.round(y-s*.34),Math.round(s*.2),Math.round(s*.03));
  // Radar dome with pulse rings
  c.fillStyle='#22c55e';c.beginPath();c.arc(x+s*.34,y-s*.38,s*.05,Math.PI,0);c.fill();
  c.strokeStyle='rgba(34,197,94,.25)';c.lineWidth=1;
  for(let r=1;r<=3;r++){c.beginPath();c.arc(x+s*.34,y-s*.38,s*.05+r*s*.04,Math.PI*.8,Math.PI*.2,true);c.stroke();}
  // Plane on tarmac
  if(s>=18){
    c.fillStyle='#e5e7eb';
    c.beginPath();c.moveTo(x-s*.3,y+s*.2);c.lineTo(x-s*.22,y+s*.18);c.lineTo(x-s*.14,y+s*.2);c.closePath();c.fill();
    c.fillRect(Math.round(x-s*.24),Math.round(y+s*.185),Math.round(s*.05),Math.round(s*.025));
    // Wings
    c.fillRect(Math.round(x-s*.28),Math.round(y+s*.19),Math.round(s*.12),Math.round(s*.01));
    // Engine glow
    c.fillStyle='rgba(253,224,71,.3)';c.beginPath();c.arc(x-s*.27,y+s*.2,s*.015,0,Math.PI*2);c.fill();
  }
}
function drawMicroResort(c,x,y,s){
  const d=s*.07;
  // Beach gradient meeting blue water
  const beachGrad=c.createLinearGradient(x,y+s*.15,x,y+s*.45);
  beachGrad.addColorStop(0,'#fde68a');beachGrad.addColorStop(.5,'#f59e0b');beachGrad.addColorStop(1,'#0ea5e9');
  c.fillStyle=beachGrad;c.fillRect(Math.round(x-s*.46),Math.round(y+s*.2),Math.round(s*.92),Math.round(s*.25));
  // Water ripples
  c.strokeStyle='rgba(255,255,255,.2)';c.lineWidth=1;
  for(let i=0;i<3;i++){c.beginPath();c.moveTo(x-s*.4,y+s*.38+i*s*.03);c.quadraticCurveTo(x,y+s*.36+i*s*.03,x+s*.4,y+s*.38+i*s*.03);c.stroke();}
  // Tiered villa with balconies
  _3dBox(c,x+s*.02,y-s*.08,s*.36,s*.28,d,'#fef3c7','#d97706','#fff7ed');
  // Second tier
  _3dBox(c,x+s*.08,y-s*.26,s*.24,s*.18,d*.7,'#fef9c3','#ca8a04','#fffbeb');
  // Balcony ledges
  c.fillStyle='#92400e';
  c.fillRect(Math.round(x),Math.round(y+s*.02),Math.round(s*.4),Math.round(s*.02));
  c.fillRect(Math.round(x+s*.06),Math.round(y-s*.12),Math.round(s*.28),Math.round(s*.02));
  // Balcony railings
  c.strokeStyle='rgba(255,255,255,.4)';c.lineWidth=1;
  c.strokeRect(Math.round(x+s*.02),Math.round(y-s*.01),Math.round(s*.08),Math.round(s*.04));
  c.strokeRect(Math.round(x+s*.28),Math.round(y-s*.01),Math.round(s*.08),Math.round(s*.04));
  // Thatched roof texture
  const roofGrad=c.createLinearGradient(x+s*.2,y-s*.42,x+s*.2,y-s*.26);
  roofGrad.addColorStop(0,'#854d0e');roofGrad.addColorStop(1,'#92400e');
  c.fillStyle=roofGrad;
  c.beginPath();c.moveTo(x+s*.02,y-s*.26);c.lineTo(x+s*.2,y-s*.42);c.lineTo(x+s*.38,y-s*.26);c.closePath();c.fill();
  // Thatch lines
  c.strokeStyle='rgba(120,53,15,.4)';c.lineWidth=1;
  for(let i=0;i<4;i++){const px=x+s*.08+i*s*.06;c.beginPath();c.moveTo(px,y-s*.26);c.lineTo(x+s*.2,y-s*.38);c.stroke();}
  // 3 palm trees with layered fronds
  const palms=[[-s*.32,s*.1],[-s*.24,-.02],[s*.38,.05]];
  for(const[px,py]of palms){
    // Shadow
    c.fillStyle='rgba(0,0,0,.12)';c.beginPath();c.ellipse(x+px,y+s*.2,s*.06,s*.02,0,0,Math.PI*2);c.fill();
    // Trunk
    c.strokeStyle='#854d0e';c.lineWidth=Math.max(2,s*.04);
    c.beginPath();c.moveTo(x+px,y+s*.18);c.quadraticCurveTo(x+px-s*.04,y+py,x+px+s*.02,y+py-s*.15);c.stroke();
    // Frond layers
    const fx=x+px+s*.02,fy=y+py-s*.15;
    c.fillStyle='#15803d';
    for(let a=0;a<5;a++){const ang=Math.PI*2*a/5-Math.PI/4;c.beginPath();c.ellipse(fx+Math.cos(ang)*s*.08,fy+Math.sin(ang)*s*.04,s*.09,s*.025,ang*.3,0,Math.PI*2);c.fill();}
    c.fillStyle='#22c55e';
    for(let a=0;a<4;a++){const ang=Math.PI*2*a/4;c.beginPath();c.ellipse(fx+Math.cos(ang)*s*.05,fy+Math.sin(ang)*s*.03,s*.06,s*.02,ang*.3,0,Math.PI*2);c.fill();}
  }
  // Kidney-shaped pool
  c.fillStyle='#0ea5e9';
  c.beginPath();c.arc(x+s*.12,y+s*.12,s*.06,0,Math.PI*2);c.arc(x+s*.2,y+s*.14,s*.05,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,.25)';c.beginPath();c.arc(x+s*.1,y+s*.1,s*.03,0,Math.PI*2);c.fill();
  // Tiki torches with flame
  if(s>=16){
    const torches=[[-.38,.15],[.42,.12]];
    for(const[tx,ty]of torches){
      c.strokeStyle='#854d0e';c.lineWidth=Math.max(1,s*.02);c.beginPath();c.moveTo(x+tx*s,y+ty*s+s*.05);c.lineTo(x+tx*s,y+ty*s-s*.04);c.stroke();
      // Flame
      c.fillStyle='#f97316';c.beginPath();c.arc(x+tx*s,y+ty*s-s*.06,s*.02,0,Math.PI*2);c.fill();
      c.fillStyle='#fbbf24';c.beginPath();c.arc(x+tx*s,y+ty*s-s*.065,s*.012,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(251,146,60,.2)';c.beginPath();c.arc(x+tx*s,y+ty*s-s*.06,s*.04,0,Math.PI*2);c.fill();
    }
  }
}
function drawMicroSpacePort(c,x,y,s){
  const d=s*.06;
  // Concrete launch pad with texture
  const padGrad=c.createLinearGradient(x,y+s*.35,x,y+s*.18);
  padGrad.addColorStop(0,'#374151');padGrad.addColorStop(1,'#6b7280');
  c.fillStyle=padGrad;c.fillRect(Math.round(x-s*.44),Math.round(y+s*.18),Math.round(s*.88),Math.round(s*.2));
  // Pad markings
  c.strokeStyle='#fbbf24';c.lineWidth=Math.max(1,s*.015);c.setLineDash([s*.04,s*.02]);
  c.strokeRect(Math.round(x-s*.15),Math.round(y+s*.2),Math.round(s*.3),Math.round(s*.14));
  c.setLineDash([]);
  // Smoke billowing from base
  c.fillStyle='rgba(209,213,219,.25)';
  c.beginPath();c.arc(x-s*.18,y+s*.3,s*.12,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.2,y+s*.28,s*.1,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x-s*.05,y+s*.32,s*.15,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(229,231,235,.15)';
  c.beginPath();c.arc(x-s*.25,y+s*.22,s*.1,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.28,y+s*.2,s*.08,0,Math.PI*2);c.fill();
  // Gantry framework (behind rocket)
  c.strokeStyle='#9ca3af';c.lineWidth=Math.max(1,s*.02);
  c.beginPath();c.moveTo(x+s*.18,y+s*.2);c.lineTo(x+s*.18,y-s*.3);c.stroke();
  c.beginPath();c.moveTo(x+s*.14,y+s*.2);c.lineTo(x+s*.22,y+s*.2);c.stroke();
  c.beginPath();c.moveTo(x+s*.14,y);c.lineTo(x+s*.22,y);c.stroke();
  c.beginPath();c.moveTo(x+s*.14,y-s*.15);c.lineTo(x+s*.22,y-s*.15);c.stroke();
  // Cross braces
  c.lineWidth=Math.max(1,s*.01);c.strokeStyle='rgba(156,163,175,.5)';
  c.beginPath();c.moveTo(x+s*.14,y+s*.2);c.lineTo(x+s*.22,y);c.stroke();
  c.beginPath();c.moveTo(x+s*.22,y);c.lineTo(x+s*.14,y-s*.15);c.stroke();
  // Rocket body with panel lines
  const rGrad=c.createLinearGradient(x-s*.08,0,x+s*.08,0);
  rGrad.addColorStop(0,'#b0b8c0');rGrad.addColorStop(.3,'#f0f4f8');rGrad.addColorStop(.5,'#ffffff');rGrad.addColorStop(.7,'#f0f4f8');rGrad.addColorStop(1,'#b0b8c0');
  c.fillStyle=rGrad;c.fillRect(Math.round(x-s*.07),Math.round(y-s*.14),Math.round(s*.14),Math.round(s*.36));
  // Panel lines
  c.strokeStyle='rgba(148,163,184,.3)';c.lineWidth=1;
  for(let i=1;i<=3;i++)c.beginPath(),c.moveTo(x-s*.07,y-s*.14+i*s*.09),c.lineTo(x+s*.07,y-s*.14+i*s*.09),c.stroke();
  // Window porthole
  c.fillStyle='#60a5fa';c.beginPath();c.arc(x,y-s*.05,s*.025,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,.3)';c.beginPath();c.arc(x-s*.008,y-s*.055,s*.012,0,Math.PI*2);c.fill();
  // Red nose cone with highlight
  const noseGrad=c.createLinearGradient(x-s*.07,0,x+s*.07,0);
  noseGrad.addColorStop(0,'#b91c1c');noseGrad.addColorStop(.4,'#ef4444');noseGrad.addColorStop(1,'#991b1b');
  c.fillStyle=noseGrad;c.beginPath();c.moveTo(x,y-s*.44);c.lineTo(x+s*.07,y-s*.14);c.lineTo(x-s*.07,y-s*.14);c.closePath();c.fill();
  // Nose highlight
  c.fillStyle='rgba(255,255,255,.15)';c.beginPath();c.moveTo(x-s*.02,y-s*.4);c.lineTo(x-s*.06,y-s*.14);c.lineTo(x-s*.07,y-s*.14);c.lineTo(x-s*.01,y-s*.42);c.closePath();c.fill();
  // Fins with gradient
  const finGrad=c.createLinearGradient(x-s*.16,0,x-s*.07,0);
  finGrad.addColorStop(0,'#dc2626');finGrad.addColorStop(1,'#ef4444');
  c.fillStyle=finGrad;
  c.beginPath();c.moveTo(x-s*.16,y+s*.22);c.lineTo(x-s*.07,y+s*.05);c.lineTo(x-s*.07,y+s*.22);c.closePath();c.fill();
  c.beginPath();c.moveTo(x+s*.16,y+s*.22);c.lineTo(x+s*.07,y+s*.05);c.lineTo(x+s*.07,y+s*.22);c.closePath();c.fill();
  // Multi-layer flame exhaust (orange→yellow→white core)
  c.fillStyle='rgba(249,115,22,.2)';c.beginPath();c.moveTo(x-s*.12,y+s*.22);c.lineTo(x,y+s*.48);c.lineTo(x+s*.12,y+s*.22);c.fill();
  c.fillStyle='#f97316';c.beginPath();c.moveTo(x-s*.08,y+s*.22);c.lineTo(x,y+s*.42);c.lineTo(x+s*.08,y+s*.22);c.fill();
  c.fillStyle='#fbbf24';c.beginPath();c.moveTo(x-s*.05,y+s*.22);c.lineTo(x,y+s*.36);c.lineTo(x+s*.05,y+s*.22);c.fill();
  c.fillStyle='#fff';c.beginPath();c.moveTo(x-s*.025,y+s*.22);c.lineTo(x,y+s*.3);c.lineTo(x+s*.025,y+s*.22);c.fill();
}
function drawMicroOrbitalHotel(c,x,y,s){
  // Purple energy halo
  const haloGrad=c.createRadialGradient(x,y,s*.2,x,y,s*.46);
  haloGrad.addColorStop(0,'rgba(139,92,246,.08)');haloGrad.addColorStop(.6,'rgba(167,139,250,.12)');haloGrad.addColorStop(1,'rgba(139,92,246,0)');
  c.fillStyle=haloGrad;c.beginPath();c.arc(x,y,s*.46,0,Math.PI*2);c.fill();
  // Segmented torus ring (8 sections)
  const ringR=s*.28,segW=s*.08;
  for(let i=0;i<8;i++){
    const a1=Math.PI*2*i/8,a2=Math.PI*2*(i+.85)/8;
    const mx=(Math.cos(a1)+Math.cos(a2))/2,my=(Math.sin(a1)+Math.sin(a2))/2;
    const bright=i<4?'#7c3aed':'#6d28d9';
    c.fillStyle=bright;
    c.beginPath();
    c.arc(x+Math.cos(a1)*ringR,y+Math.sin(a1)*ringR*.55,segW/2,0,Math.PI*2);c.fill();
    // Segment body
    c.beginPath();
    const x1=x+Math.cos(a1)*ringR,y1=y+Math.sin(a1)*ringR*.55;
    const x2=x+Math.cos(a2)*ringR,y2=y+Math.sin(a2)*ringR*.55;
    c.moveTo(x1-segW*.3*Math.sin(a1),y1+segW*.3*Math.cos(a1));
    c.lineTo(x2-segW*.3*Math.sin(a2),y2+segW*.3*Math.cos(a2));
    c.lineTo(x2+segW*.3*Math.sin(a2),y2-segW*.3*Math.cos(a2));
    c.lineTo(x1+segW*.3*Math.sin(a1),y1-segW*.3*Math.cos(a1));
    c.closePath();c.fill();
    // Viewport light
    if(i%2===0){c.fillStyle='rgba(253,224,71,.4)';c.beginPath();c.arc((x1+x2)/2,(y1+y2)/2,s*.015,0,Math.PI*2);c.fill();}
  }
  // Highlight on top segments
  c.strokeStyle='rgba(196,181,253,.35)';c.lineWidth=Math.max(1,s*.02);
  c.beginPath();c.ellipse(x,y,ringR,ringR*.55,0,Math.PI*.9,Math.PI*1.9);c.stroke();
  // Central sphere hub
  const hubGrad=c.createRadialGradient(x-s*.03,y-s*.03,s*.02,x,y,s*.1);
  hubGrad.addColorStop(0,'#e9d5ff');hubGrad.addColorStop(.5,'#a78bfa');hubGrad.addColorStop(1,'#6d28d9');
  c.fillStyle=hubGrad;c.beginPath();c.arc(x,y,s*.1,0,Math.PI*2);c.fill();
  // Hub viewports
  c.fillStyle='rgba(96,165,250,.6)';
  for(let i=0;i<3;i++){const a=Math.PI*2*i/3-Math.PI/6;c.beginPath();c.arc(x+Math.cos(a)*s*.06,y+Math.sin(a)*s*.04,s*.02,0,Math.PI*2);c.fill();}
  c.fillStyle='rgba(255,255,255,.2)';c.beginPath();c.arc(x-s*.04,y-s*.04,s*.04,0,Math.PI*2);c.fill();
  // Large solar arrays extending from hub
  const solarGrad=c.createLinearGradient(x-s*.46,0,x-s*.2,0);
  solarGrad.addColorStop(0,'#1d4ed8');solarGrad.addColorStop(1,'#3b82f6');
  c.fillStyle=solarGrad;
  // Left array
  c.fillRect(Math.round(x-s*.46),Math.round(y-s*.04),Math.round(s*.22),Math.round(s*.08));
  // Array panel lines
  c.strokeStyle='rgba(96,165,250,.3)';c.lineWidth=1;
  for(let i=1;i<4;i++)c.beginPath(),c.moveTo(x-s*.46+i*s*.055,y-s*.04),c.lineTo(x-s*.46+i*s*.055,y+s*.04),c.stroke();
  // Right array
  c.fillStyle='#2563eb';c.fillRect(Math.round(x+s*.24),Math.round(y-s*.04),Math.round(s*.22),Math.round(s*.08));
  for(let i=1;i<4;i++)c.beginPath(),c.moveTo(x+s*.24+i*s*.055,y-s*.04),c.lineTo(x+s*.24+i*s*.055,y+s*.04),c.stroke();
  // Array highlight
  c.fillStyle='rgba(147,197,253,.2)';
  c.fillRect(Math.round(x-s*.46),Math.round(y-s*.04),Math.round(s*.22),Math.max(1,s*.02));
  c.fillRect(Math.round(x+s*.24),Math.round(y-s*.04),Math.round(s*.22),Math.max(1,s*.02));
  // Array struts
  c.strokeStyle='#9ca3af';c.lineWidth=Math.max(1,s*.015);
  c.beginPath();c.moveTo(x-s*.1,y);c.lineTo(x-s*.24,y);c.stroke();
  c.beginPath();c.moveTo(x+s*.1,y);c.lineTo(x+s*.24,y);c.stroke();
  // Docking ports with tiny ships
  if(s>=16){
    c.fillStyle='#e5e7eb';
    c.beginPath();c.moveTo(x,y-ringR*.55-s*.05);c.lineTo(x+s*.02,y-ringR*.55-s*.02);c.lineTo(x-s*.02,y-ringR*.55-s*.02);c.closePath();c.fill();
    c.fillStyle='rgba(59,130,246,.4)';c.beginPath();c.arc(x,y-ringR*.55-s*.03,s*.008,0,Math.PI*2);c.fill();
  }
}
function drawMicroFloatingCity(c,x,y,s){
  // Faint dome grid at very top
  c.strokeStyle='rgba(147,197,253,.08)';c.lineWidth=1;
  c.beginPath();c.ellipse(x,y-s*.1,s*.4,s*.25,0,Math.PI,0);c.stroke();
  for(let i=1;i<=3;i++){c.beginPath();c.ellipse(x,y-s*.1,s*.4*i/4,s*.25*i/4,0,Math.PI,0);c.stroke();}
  // Anti-gravity glow rings at base
  c.strokeStyle='rgba(96,165,250,.15)';c.lineWidth=Math.max(1,s*.02);
  c.beginPath();c.ellipse(x,y+s*.22,s*.32,s*.06,0,0,Math.PI*2);c.stroke();
  c.strokeStyle='rgba(96,165,250,.1)';
  c.beginPath();c.ellipse(x,y+s*.28,s*.36,s*.07,0,0,Math.PI*2);c.stroke();
  c.beginPath();c.ellipse(x,y+s*.34,s*.4,s*.08,0,0,Math.PI*2);c.stroke();
  // Volumetric cloud cluster (layered gradients)
  const cloudGrad1=c.createRadialGradient(x,y+s*.2,s*.02,x,y+s*.2,s*.28);
  cloudGrad1.addColorStop(0,'rgba(241,245,249,.7)');cloudGrad1.addColorStop(1,'rgba(226,232,240,.1)');
  c.fillStyle=cloudGrad1;c.beginPath();c.arc(x,y+s*.2,s*.28,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(248,250,252,.5)';
  c.beginPath();c.arc(x-s*.15,y+s*.16,s*.16,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.18,y+s*.18,s*.14,0,Math.PI*2);c.fill();
  c.fillStyle='#e2e8f0';
  c.beginPath();c.arc(x-s*.08,y+s*.1,s*.15,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x+s*.1,y+s*.12,s*.13,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x,y+s*.06,s*.17,0,Math.PI*2);c.fill();
  // 7+ crystalline spires
  const spires=[
    {ox:-.25,h:.42,w:.07,col1:'#60a5fa',col2:'#2563eb'},
    {ox:-.14,h:.55,w:.06,col1:'#818cf8',col2:'#4f46e5'},
    {ox:-.04,h:.65,w:.08,col1:'#a78bfa',col2:'#7c3aed'},
    {ox:.08,h:.5,w:.07,col1:'#38bdf8',col2:'#0284c7'},
    {ox:.18,h:.35,w:.06,col1:'#60a5fa',col2:'#1d4ed8'},
    {ox:.27,h:.45,w:.05,col1:'#818cf8',col2:'#6d28d9'},
    {ox:-.32,h:.3,w:.05,col1:'#93c5fd',col2:'#3b82f6'},
  ];
  for(const sp of spires){
    const sx=x+sp.ox*s,sy=y+s*.05,sh=sp.h*s,sw=sp.w*s;
    // Crystal body gradient
    const spGrad=c.createLinearGradient(sx-sw/2,0,sx+sw/2,0);
    spGrad.addColorStop(0,sp.col2);spGrad.addColorStop(.4,sp.col1);spGrad.addColorStop(.6,'rgba(255,255,255,.3)');spGrad.addColorStop(1,sp.col2);
    c.fillStyle=spGrad;
    // Pointed spire shape
    c.beginPath();c.moveTo(sx-sw/2,sy);c.lineTo(sx-sw*.3,sy-sh);c.lineTo(sx+sw*.3,sy-sh);c.lineTo(sx+sw/2,sy);c.closePath();c.fill();
    // Tip glow
    c.fillStyle='rgba(255,255,255,.4)';c.beginPath();c.arc(sx,sy-sh,sw*.3,0,Math.PI*2);c.fill();
  }
  // Hanging gardens (greenery between spires)
  if(s>=16){
    c.fillStyle='rgba(34,197,94,.3)';
    c.beginPath();c.arc(x-s*.1,y-s*.05,s*.04,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(x+s*.05,y-s*.02,s*.035,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(x+s*.15,y,s*.03,0,Math.PI*2);c.fill();
  }
  // Tiny airships
  if(s>=20){
    c.fillStyle='#f1f5f9';
    c.beginPath();c.ellipse(x+s*.32,y-s*.3,s*.04,s*.015,-.2,0,Math.PI*2);c.fill();
    c.fillStyle='rgba(239,68,68,.5)';c.fillRect(Math.round(x+s*.3),Math.round(y-s*.28),Math.round(s*.015),Math.round(s*.01));
    c.fillStyle='#e2e8f0';
    c.beginPath();c.ellipse(x-s*.35,y-s*.2,s*.03,s*.012,.1,0,Math.PI*2);c.fill();
  }
}
function drawMicroMoonBase(c,x,y,s){
  // Earth crescent in sky (background)
  if(s>=14){
    const earthGrad=c.createRadialGradient(x+s*.32,y-s*.38,s*.01,x+s*.32,y-s*.38,s*.06);
    earthGrad.addColorStop(0,'#60a5fa');earthGrad.addColorStop(.5,'#2563eb');earthGrad.addColorStop(1,'#1e3a8a');
    c.fillStyle=earthGrad;c.beginPath();c.arc(x+s*.32,y-s*.38,s*.06,0,Math.PI*2);c.fill();
    // Cloud wisps
    c.fillStyle='rgba(255,255,255,.25)';c.beginPath();c.arc(x+s*.3,y-s*.39,s*.02,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(x+s*.34,y-s*.37,s*.015,0,Math.PI*2);c.fill();
  }
  // Textured gray lunar surface with craters
  const surfGrad=c.createLinearGradient(x,y+s*.15,x,y+s*.42);
  surfGrad.addColorStop(0,'#6b7280');surfGrad.addColorStop(.3,'#4b5563');surfGrad.addColorStop(1,'#374151');
  c.fillStyle=surfGrad;c.fillRect(Math.round(x-s*.46),Math.round(y+s*.15),Math.round(s*.92),Math.round(s*.28));
  // Surface highlight edge
  c.fillStyle='#9ca3af';c.fillRect(Math.round(x-s*.46),Math.round(y+s*.15),Math.round(s*.92),Math.max(2,s*.02));
  // Craters
  const craters=[[-.3,.28,.06],[.25,.3,.05],[-.1,.35,.04],[.35,.25,.03],[-.38,.32,.035]];
  for(const[cx,cy,cr]of craters){
    c.fillStyle='rgba(0,0,0,.15)';c.beginPath();c.arc(x+cx*s,y+cy*s,cr*s,0,Math.PI*2);c.fill();
    c.fillStyle='rgba(255,255,255,.05)';c.beginPath();c.arc(x+cx*s-cr*s*.3,y+cy*s-cr*s*.3,cr*s*.5,0,Math.PI*2);c.fill();
  }
  // Main geodesic dome with triangular panels
  const dGrad=c.createRadialGradient(x-s*.06,y-s*.02,s*.02,x,y+s*.1,s*.26);
  dGrad.addColorStop(0,'#f8fafc');dGrad.addColorStop(.5,'#cbd5e1');dGrad.addColorStop(1,'#64748b');
  c.fillStyle=dGrad;c.beginPath();c.arc(x,y+s*.15,s*.24,Math.PI,0);c.fill();
  // Triangular panel lines on dome
  c.strokeStyle='rgba(100,116,139,.3)';c.lineWidth=1;
  const domeCenter={x:x,y:y+s*.15};
  // Horizontal bands
  for(let i=1;i<=3;i++){
    const bandY=domeCenter.y-i*s*.06;
    const bandHalf=Math.sqrt(Math.max(0,(s*.24)**2-(i*s*.06)**2));
    c.beginPath();c.moveTo(domeCenter.x-bandHalf,bandY);c.lineTo(domeCenter.x+bandHalf,bandY);c.stroke();
  }
  // Vertical ribs
  for(let a=-2;a<=2;a++){
    const ribX=domeCenter.x+a*s*.08;
    c.beginPath();c.moveTo(ribX,domeCenter.y);c.quadraticCurveTo(ribX-a*s*.01,domeCenter.y-s*.18,domeCenter.x,domeCenter.y-s*.24);c.stroke();
  }
  // 2 secondary domes via tunnels
  // Left secondary dome
  const ldGrad=c.createRadialGradient(x-s*.32,y+s*.08,s*.01,x-s*.3,y+s*.15,s*.12);
  ldGrad.addColorStop(0,'#f1f5f9');ldGrad.addColorStop(1,'#94a3b8');
  c.fillStyle=ldGrad;c.beginPath();c.arc(x-s*.3,y+s*.15,s*.12,Math.PI,0);c.fill();
  // Right secondary dome
  c.fillStyle=ldGrad;c.beginPath();c.arc(x+s*.32,y+s*.15,s*.1,Math.PI,0);c.fill();
  // Connecting tunnels
  c.fillStyle='#94a3b8';
  c.fillRect(Math.round(x-s*.18),Math.round(y+s*.1),Math.round(s*.12),Math.round(s*.06));
  c.fillRect(Math.round(x+s*.12),Math.round(y+s*.11),Math.round(s*.1),Math.round(s*.05));
  c.fillStyle='rgba(255,255,255,.1)';
  c.fillRect(Math.round(x-s*.18),Math.round(y+s*.1),Math.round(s*.12),Math.max(1,s*.015));
  c.fillRect(Math.round(x+s*.12),Math.round(y+s*.11),Math.round(s*.1),Math.max(1,s*.015));
  // Main dome viewport (blue glow)
  c.fillStyle='rgba(96,165,250,.2)';c.beginPath();c.arc(x,y+s*.02,s*.08,0,Math.PI*2);c.fill();
  c.fillStyle='#60a5fa';c.beginPath();c.arc(x,y+s*.02,s*.055,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,.3)';c.beginPath();c.arc(x-s*.02,y-s*.01,s*.025,0,Math.PI*2);c.fill();
  // Rover
  if(s>=16){
    c.fillStyle='#d1d5db';c.fillRect(Math.round(x+s*.15),Math.round(y+s*.28),Math.round(s*.06),Math.round(s*.03));
    c.fillStyle='#4b5563';
    c.beginPath();c.arc(x+s*.16,y+s*.31,s*.01,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(x+s*.2,y+s*.31,s*.01,0,Math.PI*2);c.fill();
  }
  // Comm dish
  c.strokeStyle='#e5e7eb';c.lineWidth=Math.max(1,s*.015);
  c.beginPath();c.moveTo(x+s*.38,y+s*.15);c.lineTo(x+s*.38,y-s*.05);c.stroke();
  c.fillStyle='#d1d5db';c.beginPath();c.arc(x+s*.38,y-s*.08,s*.04,Math.PI*.7,Math.PI*.3,true);c.lineTo(x+s*.38,y-s*.05);c.closePath();c.fill();
  // Antenna red blink
  const blink=Math.sin(performance.now()*.004)>0;
  if(blink){c.fillStyle='#ef4444';c.beginPath();c.arc(x+s*.38,y-s*.09,s*.015,0,Math.PI*2);c.fill();}
}
function drawMicroMarsColony(c,x,y,s){
  // Phobos in sky
  if(s>=16){
    c.fillStyle='#a8a29e';c.beginPath();c.ellipse(x-s*.32,y-s*.4,s*.03,s*.025,0,0,Math.PI*2);c.fill();
    c.fillStyle='rgba(255,255,255,.1)';c.beginPath();c.arc(x-s*.33,y-s*.41,s*.012,0,Math.PI*2);c.fill();
  }
  // Red terrain with rock outcrops
  const terrGrad=c.createLinearGradient(x,y+s*.12,x,y+s*.42);
  terrGrad.addColorStop(0,'#b91c1c');terrGrad.addColorStop(.4,'#991b1b');terrGrad.addColorStop(1,'#7f1d1d');
  c.fillStyle=terrGrad;c.fillRect(Math.round(x-s*.46),Math.round(y+s*.12),Math.round(s*.92),Math.round(s*.32));
  // Surface highlight
  c.fillStyle='#dc2626';c.fillRect(Math.round(x-s*.46),Math.round(y+s*.12),Math.round(s*.92),Math.max(2,s*.02));
  // Rock outcrops
  c.fillStyle='#78350f';
  c.beginPath();c.moveTo(x-s*.4,y+s*.2);c.lineTo(x-s*.36,y+s*.12);c.lineTo(x-s*.32,y+s*.2);c.closePath();c.fill();
  c.beginPath();c.moveTo(x+s*.34,y+s*.22);c.lineTo(x+s*.37,y+s*.14);c.lineTo(x+s*.42,y+s*.16);c.lineTo(x+s*.42,y+s*.22);c.closePath();c.fill();
  c.fillStyle='#92400e';
  c.beginPath();c.moveTo(x+s*.28,y+s*.2);c.lineTo(x+s*.3,y+s*.15);c.lineTo(x+s*.34,y+s*.2);c.closePath();c.fill();
  // 3 biodomes with hex framework and green glow
  const domes=[{cx:-.18,r:.18},{cx:.15,r:.15},{cx:.35,r:.1}];
  for(const dome of domes){
    const dx=x+dome.cx*s,dr=dome.r*s;
    // Green glow underneath
    c.fillStyle='rgba(34,197,94,.12)';c.beginPath();c.arc(dx,y+s*.12,dr*1.2,Math.PI,0);c.fill();
    // Dome body
    const domGrad=c.createRadialGradient(dx-dr*.3,y+s*.12-dr*.6,dr*.1,dx,y+s*.12,dr);
    domGrad.addColorStop(0,'rgba(255,255,255,.7)');domGrad.addColorStop(.4,'rgba(209,213,219,.5)');domGrad.addColorStop(1,'rgba(100,116,139,.6)');
    c.fillStyle=domGrad;c.beginPath();c.arc(dx,y+s*.12,dr,Math.PI,0);c.fill();
    // Hex framework lines
    c.strokeStyle='rgba(75,85,99,.3)';c.lineWidth=1;
    // Horizontal bands
    for(let i=1;i<=2;i++){
      const by=y+s*.12-i*dr*.35;
      const bw=Math.sqrt(Math.max(0,dr*dr-(i*dr*.35)**2));
      c.beginPath();c.moveTo(dx-bw,by);c.lineTo(dx+bw,by);c.stroke();
    }
    // Vertical ribs
    for(let a=-1;a<=1;a++){
      c.beginPath();c.moveTo(dx+a*dr*.4,y+s*.12);c.quadraticCurveTo(dx+a*dr*.2,y+s*.12-dr*.8,dx,y+s*.12-dr);c.stroke();
    }
    // Plants visible inside (green tint)
    c.fillStyle='rgba(34,197,94,.2)';c.beginPath();c.arc(dx,y+s*.06,dr*.5,Math.PI,0);c.fill();
    // Tiny green dots (plants)
    if(s>=14){
      c.fillStyle='#22c55e';
      for(let p=0;p<3;p++){
        c.beginPath();c.arc(dx-dr*.3+p*dr*.3,y+s*.08,s*.01,0,Math.PI*2);c.fill();
      }
    }
  }
  // Connecting tunnels between domes
  c.fillStyle='#9ca3af';
  c.fillRect(Math.round(x-s*.02),Math.round(y+s*.06),Math.round(s*.14),Math.round(s*.07));
  c.fillRect(Math.round(x+s*.22),Math.round(y+s*.08),Math.round(s*.08),Math.round(s*.05));
  c.fillStyle='rgba(255,255,255,.08)';
  c.fillRect(Math.round(x-s*.02),Math.round(y+s*.06),Math.round(s*.14),Math.max(1,s*.015));
  c.fillRect(Math.round(x+s*.22),Math.round(y+s*.08),Math.round(s*.08),Math.max(1,s*.015));
  // Terraforming tower with vapor
  c.fillStyle='#6b7280';c.fillRect(Math.round(x-s*.36),Math.round(y-s*.1),Math.round(s*.06),Math.round(s*.22));
  c.fillStyle='#9ca3af';c.fillRect(Math.round(x-s*.38),Math.round(y-s*.12),Math.round(s*.1),Math.round(s*.03));
  // Vapor wisps
  c.fillStyle='rgba(209,213,219,.2)';
  c.beginPath();c.arc(x-s*.33,y-s*.16,s*.04,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x-s*.36,y-s*.22,s*.035,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(x-s*.3,y-s*.26,s*.03,0,Math.PI*2);c.fill();
  // Blinking light on tower
  const tblink=Math.sin(performance.now()*.003)>0;
  if(tblink){c.fillStyle='#22c55e';c.beginPath();c.arc(x-s*.33,y-s*.12,s*.015,0,Math.PI*2);c.fill();}
  // Solar array
  c.strokeStyle='#6b7280';c.lineWidth=Math.max(1,s*.015);
  c.beginPath();c.moveTo(x+s*.42,y+s*.12);c.lineTo(x+s*.42,y-s*.02);c.stroke();
  const solGrad=c.createLinearGradient(x+s*.36,0,x+s*.48,0);
  solGrad.addColorStop(0,'#1d4ed8');solGrad.addColorStop(1,'#3b82f6');
  c.fillStyle=solGrad;c.fillRect(Math.round(x+s*.36),Math.round(y-s*.02),Math.round(s*.12),Math.round(s*.14));
  // Panel grid lines
  c.strokeStyle='rgba(96,165,250,.3)';c.lineWidth=1;
  c.beginPath();c.moveTo(x+s*.42,y-s*.02);c.lineTo(x+s*.42,y+s*.12);c.stroke();
  c.beginPath();c.moveTo(x+s*.36,y+s*.04);c.lineTo(x+s*.48,y+s*.04);c.stroke();
  // Solar highlight
  c.fillStyle='rgba(147,197,253,.15)';c.fillRect(Math.round(x+s*.36),Math.round(y-s*.02),Math.round(s*.12),Math.max(1,s*.02));
}

// Render a cell in the micro-grid system
function renderCell(c,r,col,cellX,cellY,cellW,cellH){
  if(!state.cityGrid||!state.cityGrid[r]||!state.cityGrid[r][col])return;
  const buildings=state.cityGrid[r][col];
  const n=buildings.length;
  // Cell ground color
  c.fillStyle=getCellGroundColor(buildings);
  c.fillRect(cellX+1,cellY+1,cellW-2,cellH-2);
  // Cell ground detail
  drawCellGround(c,cellX,cellY,cellW,cellH,n,r,col);
  if(n===0)return;
  // Occupied cell border glow
  c.strokeStyle='rgba(255,255,255,0.15)';c.lineWidth=1;c.strokeRect(cellX+1,cellY+1,cellW-2,cellH-2);
  // Sort: low tier first (front rows), high tier last (back rows)
  const sorted=[...buildings].sort((a,b)=>a.tier-b.tier);
  sorted.forEach((bld,i)=>{
    const slot=getMicroSlotPos(cellX,cellY,cellW,cellH,i,n);
    drawMicroBuilding(c,bld.type,slot.x,slot.y,slot.w,slot.h,bld);
    // Level indicator dots below building
    const lvl=bld.level||1;
    if(lvl>1){
      const dotR=Math.max(1.5,slot.w*0.04);
      const dotSpacing=dotR*3;
      const dotY=slot.y+Math.min(slot.h,MAX_SPRITE_PX)*0.45+dotR*2;
      const startX=slot.x-(lvl-1)*dotSpacing/2;
      for(let d=0;d<lvl;d++){
        c.fillStyle=lvl>=5?'#fbbf24':'#60a5fa';
        c.beginPath();c.arc(startX+d*dotSpacing,dotY,dotR,0,Math.PI*2);c.fill();
      }
      // Level 5 golden glow
      if(lvl>=5){
        c.save();
        c.shadowColor='rgba(251,191,36,0.6)';c.shadowBlur=8;
        c.strokeStyle='rgba(251,191,36,0.3)';c.lineWidth=1;
        const s=Math.min(slot.w,slot.h)*0.45;
        c.strokeRect(slot.x-s,slot.y-s,s*2,s*2);
        c.restore();
      }
    }
  });
}

// ╔══════════════════════════════════════════════╗
// ║      SECTION: MANAGER NPCs                   ║
// ╚══════════════════════════════════════════════╝
const MANAGER_NPC_CONFIG=[
  {id:0,name:'Valet',color:'#ef4444',hat:false,targets:['parking','foodcart','garage'],size:0.55,speed:30},
  {id:1,name:'Accountant',color:'#3b82f6',hat:false,targets:['apartment','restaurant','laundromat'],size:0.55,speed:35},
  {id:2,name:'Property Mgr',color:'#f59e0b',hat:true,targets:['office','casino','mall'],size:0.6,speed:40},
  {id:3,name:'Director',color:'#8b5cf6',hat:false,targets:['hotel','stadium','skyscraper'],size:0.6,speed:50},
  {id:4,name:'VP',color:'#06b6d4',hat:false,targets:['cityblock','airport','resort'],size:0.65,speed:55},
  {id:5,name:'Board',color:'#fbbf24',hat:false,targets:['spaceport','orbitalhotel','floatingcity','moonbase','marscolony'],size:0.65,speed:70},
];
let managerSprites=[];
function initManagerNPCs(){
  managerSprites=[];
  for(let i=0;i<MANAGERS.length&&i<MANAGER_NPC_CONFIG.length;i++){
    if(!state.managers[i])continue;
    const cfg=MANAGER_NPC_CONFIG[i];
    managerSprites.push({id:i,cfg,x:canvasW/2,y:canvasH/2,targetCell:null,collecting:false,collectTimer:0,routeQueue:[],facing:1,walkFrame:0});
  }
}
function buildManagerRoute(mgr){
  const gs=getGridSize();
  if(!state.cityGrid)return;
  const relevant=[];
  for(let r=0;r<gs;r++){for(let c=0;c<gs;c++){
    if(!state.cityGrid[r]||!state.cityGrid[r][c])continue;
    if(state.cityGrid[r][c].some(b=>mgr.cfg.targets.includes(b.type)))relevant.push({r,c});
  }}
  if(relevant.length===0)return;
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW;
  const curR=Math.floor((mgr.y-pad)/cellH),curC=Math.floor((mgr.x-pad)/cellW);
  const remaining=[...relevant];const route=[];let cur={r:curR,c:curC};
  while(remaining.length>0){
    remaining.sort((a,b)=>(Math.abs(a.r-cur.r)+Math.abs(a.c-cur.c))-(Math.abs(b.r-cur.r)+Math.abs(b.c-cur.c)));
    const next=remaining.shift();route.push(next);cur=next;
  }
  mgr.routeQueue=route;
}
function updateManagerNPCs(dt){
  const gs=getGridSize();
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW;
  // Sync with hired managers
  for(let i=0;i<MANAGERS.length&&i<MANAGER_NPC_CONFIG.length;i++){
    if(state.managers[i]&&!managerSprites.find(m=>m.id===i)){
      const cfg=MANAGER_NPC_CONFIG[i];
      const ms={id:i,cfg,x:pad+Math.random()*gs*cellW,y:pad+Math.random()*gs*cellH,targetCell:null,collecting:false,collectTimer:0,routeQueue:[],facing:1,walkFrame:0};
      buildManagerRoute(ms);
      managerSprites.push(ms);
    }
  }
  managerSprites=managerSprites.filter(m=>state.managers[m.id]);
  for(const mgr of managerSprites){
    if(mgr.collecting){
      mgr.collectTimer-=dt;
      if(mgr.collectTimer<=0){
        mgr.collecting=false;
        // Spawn tiny collect particle (smaller text to reduce visual noise)
        floatTexts.push({x:mgr.x,y:mgr.y-10,text:'+'+fmt(getIncome()*0.1),color:'#4ade80',size:7,life:1});
      }
      continue;
    }
    if(!mgr.targetCell&&mgr.routeQueue.length>0)mgr.targetCell=mgr.routeQueue.shift();
    if(!mgr.targetCell){buildManagerRoute(mgr);continue;}
    const tx=pad+mgr.targetCell.c*cellW+cellW/2,ty=pad+mgr.targetCell.r*cellH+cellH/2;
    const dx2=tx-mgr.x,dy2=ty-mgr.y,dist2=Math.sqrt(dx2*dx2+dy2*dy2);
    if(dist2<3){
      mgr.collecting=true;mgr.collectTimer=1.2;mgr.targetCell=null;
      if(mgr.routeQueue.length===0)buildManagerRoute(mgr);
    }else{
      const spd=mgr.cfg.speed*dt;mgr.x+=(dx2/dist2)*spd;mgr.y+=(dy2/dist2)*spd;
      mgr.facing=dx2>0?1:-1;mgr.walkFrame+=spd*0.2;
    }
  }
}
function drawManagerNPC(c,mgr){
  const size=6*mgr.cfg.size;
  c.save();c.translate(mgr.x,mgr.y);c.scale(mgr.facing,1);
  c.fillStyle=mgr.cfg.color;c.fillRect(-size*.2,-size*.3,size*.4,size*.5);
  c.fillStyle='#fde68a';c.beginPath();c.arc(0,-size*.45,size*.18,0,Math.PI*2);c.fill();
  c.strokeStyle=mgr.cfg.color;c.lineWidth=0.8;
  const leg=mgr.collecting?0:Math.sin(mgr.walkFrame)*size*.12;
  c.beginPath();c.moveTo(-size*.1,size*.2);c.lineTo(-size*.15+leg,size*.5);c.moveTo(size*.1,size*.2);c.lineTo(size*.15-leg,size*.5);c.stroke();
  if(mgr.collecting){c.fillStyle='#fbbf24';const bob=Math.sin(Date.now()*.01)*1.5;c.beginPath();c.arc(0,-size*.7+bob,size*.1,0,Math.PI*2);c.fill();}
  c.restore();
}

// ╔══════════════════════════════════════════════╗
// ║      SECTION: INCOME FLOATING TEXT            ║
// ╚══════════════════════════════════════════════╝
let incomeFloats=[];
let incomeFloatTimer=0;
function spawnIncomeFloat(){
  if(incomeFloats.length>=6)return; // Cap visible floats to reduce visual noise
  const gs=getGridSize();
  if(!state.cityGrid)return;
  const occupied=[];
  for(let r=0;r<gs;r++)for(let c=0;c<gs;c++)if(state.cityGrid[r]&&state.cityGrid[r][c]&&state.cityGrid[r][c].length>0)occupied.push({r,c});
  if(occupied.length===0)return;
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW;
  const cell=occupied[Math.floor(Math.random()*occupied.length)];
  const x2=pad+cell.c*cellW+cellW/2+(Math.random()-0.5)*cellW*.4;
  const y2=pad+cell.r*cellH+cellH/2;
  incomeFloats.push({x:x2,y:y2,text:'+'+fmt(getIncome())+'/s',life:2,maxLife:2});
}
function renderIncomeFloats(dt){
  for(const f of incomeFloats){
    f.y-=12*dt;f.life-=dt;
    const alpha=Math.max(0,f.life/f.maxLife);
    ctx.globalAlpha=alpha*0.55;ctx.fillStyle='#4ade80';ctx.font='bold 9px sans-serif';ctx.textAlign='center';
    ctx.fillText(f.text,f.x,f.y);ctx.globalAlpha=1;
  }
  for(let i=incomeFloats.length-1;i>=0;i--){if(incomeFloats[i].life<=0)incomeFloats.splice(i,1);}
}

// ╔══════════════════════════════════════════════╗
// ║      SECTION: SPIN WHEEL                     ║
// ╚══════════════════════════════════════════════╝
const WHEEL_SEGMENTS=[
  {label:'Cash ×10',color:'#22c55e',weight:25,reward:'cash_small'},
  {label:'Cash ×100',color:'#16a34a',weight:15,reward:'cash_medium'},
  {label:'Cash ×1000',color:'#15803d',weight:5,reward:'cash_large'},
  {label:'Coffee Rush',color:'#f97316',weight:15,reward:'powerup_coffee'},
  {label:'Energy!',color:'#eab308',weight:10,reward:'powerup_energy'},
  {label:'+1 Prestige',color:'#a855f7',weight:3,reward:'prestige_point'},
  {label:'JACKPOT',color:'#fbbf24',weight:2,reward:'jackpot'},
  {label:'Try Again',color:'#64748b',weight:25,reward:'nothing'},
];
const FREE_SPIN_COOLDOWN=30*60*1000;
let wheelState={active:false,angle:0,phase:'idle',targetAngle:0,startAngle:0,spinStartTime:0,spinDuration:0,result:null,lastSegIndex:-1};
function canSpin(){return Date.now()-(state.wheelLastSpin||0)>=FREE_SPIN_COOLDOWN;}
function getSpinCooldownText(){
  const rem=FREE_SPIN_COOLDOWN-(Date.now()-(state.wheelLastSpin||0));
  if(rem<=0)return'FREE SPIN!';
  const m=Math.floor(rem/60000),s=Math.floor((rem%60000)/1000);
  return m+':'+String(s).padStart(2,'0');
}
function weightedRandom(segs){
  let total=0;for(const s of segs)total+=s.weight;
  let r=Math.random()*total;
  for(const s of segs){r-=s.weight;if(r<=0)return s;}
  return segs[segs.length-1];
}
function startSpin(){
  if(!canSpin())return;
  const result=weightedRandom(WHEEL_SEGMENTS);
  const idx=WHEEL_SEGMENTS.indexOf(result);
  const segAngle=(Math.PI*2)/WHEEL_SEGMENTS.length;
  const targetCenter=idx*segAngle+segAngle/2;
  const fullRots=(3+Math.random()*2)*Math.PI*2;
  wheelState.active=true;wheelState.phase='spinning';
  wheelState.startAngle=wheelState.angle;wheelState.targetAngle=wheelState.angle+fullRots+(Math.PI*2-targetCenter);
  wheelState.spinStartTime=Date.now();wheelState.spinDuration=3000+Math.random()*1000;wheelState.result=result;
  playSound('buy');
}
function updateWheel(){
  if(wheelState.phase!=='spinning')return;
  const elapsed=Date.now()-wheelState.spinStartTime;
  const progress=Math.min(elapsed/wheelState.spinDuration,1);
  const eased=1-Math.pow(1-progress,3);
  wheelState.angle=wheelState.startAngle+(wheelState.targetAngle-wheelState.startAngle)*eased;
  const segIdx=Math.floor(((wheelState.angle%(Math.PI*2))/(Math.PI*2))*WHEEL_SEGMENTS.length);
  if(segIdx!==wheelState.lastSegIndex){wheelState.lastSegIndex=segIdx;playSound('click');}
  if(progress>=1){wheelState.phase='result';setTimeout(()=>awardWheelPrize(wheelState.result),500);}
}
function awardWheelPrize(seg){
  switch(seg.reward){
    case'cash_small':state.cash+=getClickValue()*10;state.totalCash+=getClickValue()*10;break;
    case'cash_medium':state.cash+=getClickValue()*100;state.totalCash+=getClickValue()*100;break;
    case'cash_large':state.cash+=getClickValue()*1000;state.totalCash+=getClickValue()*1000;break;
    case'powerup_coffee':if(POWERUPS[0])activatePowerup(0);break;
    case'powerup_energy':if(POWERUPS[1])activatePowerup(1);break;
    case'prestige_point':state.prestigePoints+=1;break;
    case'jackpot':const amt=getIncome()*60;state.cash+=amt;state.totalCash+=amt;notify('JACKPOT! +'+fmt(amt));break;
    case'nothing':notify('Better luck next time!');break;
  }
  state.wheelLastSpin=Date.now();saveGame();updateHUD();
  setTimeout(()=>{wheelState.active=false;wheelState.phase='idle';},2000);
}
function drawWheel(c){
  if(!wheelState.active)return;
  c.fillStyle='rgba(0,0,0,0.7)';c.fillRect(0,0,canvasW,canvasH);
  const cx2=canvasW/2,cy2=canvasH*0.42,radius=Math.min(canvasW,canvasH)*0.32;
  const segAngle=(Math.PI*2)/WHEEL_SEGMENTS.length;
  c.save();c.translate(cx2,cy2);c.rotate(wheelState.angle);
  WHEEL_SEGMENTS.forEach((seg,i)=>{
    c.beginPath();c.moveTo(0,0);c.arc(0,0,radius,i*segAngle,(i+1)*segAngle);c.closePath();
    c.fillStyle=seg.color;c.fill();c.strokeStyle='#fff';c.lineWidth=1.5;c.stroke();
    c.save();c.rotate(i*segAngle+segAngle/2);c.textAlign='center';c.fillStyle='#fff';
    c.font=`bold ${Math.max(9,radius*0.07)}px sans-serif`;c.fillText(seg.label,radius*0.6,3);c.restore();
  });
  c.restore();
  // Pointer
  c.fillStyle='#ef4444';c.beginPath();c.moveTo(cx2,cy2-radius-10);c.lineTo(cx2-8,cy2-radius-24);c.lineTo(cx2+8,cy2-radius-24);c.closePath();c.fill();
  // Hub
  c.fillStyle='#1e293b';c.beginPath();c.arc(cx2,cy2,radius*.1,0,Math.PI*2);c.fill();c.strokeStyle='#fbbf24';c.lineWidth=2;c.stroke();
  // Result text
  if(wheelState.phase==='result'&&wheelState.result){
    c.fillStyle='#fff';c.font='bold 18px sans-serif';c.textAlign='center';c.textBaseline='middle';
    c.fillText(wheelState.result.label+'!',cx2,cy2+radius+40);
  }
  // Close hint
  if(wheelState.phase==='result'){
    c.fillStyle='rgba(255,255,255,.4)';c.font='12px sans-serif';c.fillText('Tap to close',cx2,cy2+radius+65);
  }
}

function drawStreets(c,gs,pad,cellW,cellH){
  const roadW=Math.max(6,Math.min(12,cellW*.1));
  const sidewalkW=roadW+4;
  // Sidewalks
  c.fillStyle="rgba(80,85,95,.4)";
  for(let i=0;i<=gs;i++){
    c.fillRect(pad+i*cellW-sidewalkW/2,pad,sidewalkW,gs*cellH);
    c.fillRect(pad,pad+i*cellH-sidewalkW/2,gs*cellW,sidewalkW);
  }
  // Road surface
  c.fillStyle="rgba(40,45,55,.8)";
  for(let i=0;i<=gs;i++){
    c.fillRect(pad+i*cellW-roadW/2,pad,roadW,gs*cellH);
    c.fillRect(pad,pad+i*cellH-roadW/2,gs*cellW,roadW);
  }
  // Center lane markings (gold dashes)
  c.strokeStyle="rgba(240,192,64,.2)";c.lineWidth=1;c.setLineDash([4,6]);
  for(let i=0;i<=gs;i++){
    c.beginPath();c.moveTo(pad+i*cellW,pad);c.lineTo(pad+i*cellW,pad+gs*cellH);c.stroke();
    c.beginPath();c.moveTo(pad,pad+i*cellH);c.lineTo(pad+gs*cellW,pad+i*cellH);c.stroke();
  }
  c.setLineDash([]);
  // Crosswalks (skip if cells too small)
  if(cellW>=35){
    c.fillStyle="rgba(255,255,255,.12)";
    for(let r=0;r<=gs;r++){
      for(let cc=0;cc<=gs;cc++){
        const ix=pad+cc*cellW,iy=pad+r*cellH;
        // Horizontal stripes near intersection
        for(let s=0;s<3;s++){
          c.fillRect(ix-roadW/2,iy+roadW/2+2+s*4,roadW,2);
          c.fillRect(ix+roadW/2+2+s*4,iy-roadW/2,2,roadW);
        }
      }
    }
  }
  // Intersection patches
  c.fillStyle="rgba(60,65,75,.6)";
  for(let r=0;r<=gs;r++){
    for(let cc=0;cc<=gs;cc++){
      c.fillRect(pad+cc*cellW-roadW/2,pad+r*cellH-roadW/2,roadW,roadW);
    }
  }
}

function drawCityDecor(c,gs,pad,cellW,cellH,time){
  const cos=state.cosmetics.cityDecor;
  // Street lamps
  if(cos.streetLamps){
    c.fillStyle="rgba(255,220,100,.6)";
    for(let r=0;r<=gs;r++){for(let cc=0;cc<=gs;cc++){
      c.beginPath();c.arc(pad+cc*cellW,pad+r*cellH,3,0,Math.PI*2);c.fill();
    }}
  }
  // Park trees in empty cells
  if(cos.parkTrees){
    let placed=0;const totalOwned=state.properties.reduce((a,b)=>a+b,0);
    for(let r=0;r<gs;r++){for(let cc=0;cc<gs;cc++){
      if(placed>=totalOwned){
        const tx=pad+cc*cellW+cellW/2,ty=pad+r*cellH+cellH/2;
        c.fillStyle="rgba(34,120,60,.5)";c.beginPath();c.arc(tx,ty,Math.min(8,cellW*.12),0,Math.PI*2);c.fill();
        c.fillStyle="rgba(80,60,30,.5)";c.fillRect(tx-1,ty+Math.min(6,cellW*.08),2,Math.min(6,cellW*.08));
      }
      placed++;
    }}
  }
  // Traffic lights
  if(cos.trafficLights){
    const phase=Math.floor(time/1500)%2;
    for(let r=0;r<=gs;r++){for(let cc=0;cc<=gs;cc++){
      if((r+cc)%2===0){
        c.fillStyle=phase===0?"rgba(255,80,80,.6)":"rgba(80,255,80,.6)";
        c.beginPath();c.arc(pad+cc*cellW+8,pad+r*cellH-8,2.5,0,Math.PI*2);c.fill();
      }
    }}
  }
  // City fountain in center
  if(cos.cityFountain){
    const fcx=pad+gs*cellW/2,fcy=pad+gs*cellH/2;
    const phase=Math.sin(time/400)*3;
    c.fillStyle="rgba(96,165,250,.3)";c.beginPath();c.arc(fcx,fcy,8,0,Math.PI*2);c.fill();
    c.fillStyle="rgba(96,165,250,.5)";c.beginPath();c.arc(fcx,fcy-phase-4,3,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(fcx-4,fcy-phase-2,2,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(fcx+4,fcy-phase-2,2,0,Math.PI*2);c.fill();
  }
}

function drawCity(gs){
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW,ms=getMilestone();
  // Ensure cityGrid exists
  if(!state.cityGrid||state.cityGrid.length<gs)rebuildCityGrid();
  // BG
  ctx.fillStyle=ms.color;ctx.fillRect(0,0,canvasW,canvasH);
  // Use offscreen cache for streets + micro-grid buildings
  if(buildingCacheDirty||buildingCacheGS!==gs||!buildingCache||hasActiveScaffolding()){
    if(!buildingCache){buildingCache=document.createElement('canvas');}
    buildingCache.width=canvasW;buildingCache.height=canvasH;
    const bc=buildingCache.getContext('2d');
    bc.clearRect(0,0,canvasW,canvasH);
    drawStreets(bc,gs,pad,cellW,cellH);
    // Render each cell with micro-grid system
    for(let r=0;r<gs;r++){
      for(let c=0;c<gs;c++){
        const cellX=pad+c*cellW,cellY=pad+r*cellH;
        renderCell(bc,r,c,cellX,cellY,cellW,cellH);
      }
    }
    buildingCacheDirty=false;buildingCacheGS=gs;
  }
  ctx.drawImage(buildingCache,0,0);
  // Building pulse on income tick (windows flash brighter)
  if(Date.now()%1000<150&&getIncome()>0){
    ctx.fillStyle='rgba(255,220,100,0.03)';ctx.fillRect(pad,pad,gs*cellW,gs*cellH);
  }
  drawCityDecor(ctx,gs,pad,cellW,cellH,performance.now());
  // Zone label
  ctx.font="600 11px -apple-system,system-ui,sans-serif";
  ctx.textAlign="left";ctx.textBaseline="top";
  ctx.fillStyle="rgba(240,192,64,.25)";
  ctx.fillText(ms.name.toUpperCase(),pad+4,pad-16);
  if(state.prestigeCount>0){
    ctx.fillStyle="rgba(167,139,250,.4)";
    ctx.font="11px system-ui";ctx.textAlign="right";
    ctx.fillText("★".repeat(Math.min(state.prestigeCount,10))+" P"+state.prestigeCount,canvasW-14,pad-16);
  }
}

// ─── Vehicle Movement System ───
function syncVehicleSprites(gs){
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW;
  // Rebuild if grid changed
  if(lastVehicleSyncGS!==gs){vehicleSprites=[];lastVehicleSyncGS=gs;}
  // Count desired types (1 sprite per type owned)
  const desired=[];
  for(let i=0;i<VEHICLES.length;i++){if(state.vehicles[i]>0)desired.push(i);}
  // Remove sprites for types no longer owned
  vehicleSprites=vehicleSprites.filter(v=>state.vehicles[v.type]>0);
  // Add missing types
  const existing=new Set(vehicleSprites.map(v=>v.type));
  for(const t of desired){
    if(!existing.has(t)){
      // Spawn at random road position
      const isHeli=t===7,isYacht=t===8,isJet=t===9;
      const ri=Math.floor(Math.random()*(gs+1)),ci=Math.floor(Math.random()*(gs+1));
      const x=pad+ci*cellW,y=pad+ri*cellH;
      vehicleSprites.push({type:t,x,y,targetX:x,targetY:y,speed:30+t*25,angle:0,dir:Math.floor(Math.random()*4),isHeli,isYacht,isJet,heliAngle:Math.random()*Math.PI*2});
    }
  }
}
function updateVehicles(dt,gs){
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs,cellH=cellW;
  for(const v of vehicleSprites){
    if(v.isHeli||v.isYacht){
      v.heliAngle+=dt*(v.isYacht?.15:.3);
      const cx2=pad+gs*cellW/2,cy2=pad+gs*cellH/2;
      const radius=Math.min(gs*cellW,gs*cellH)*(v.isYacht?.42:.35);
      v.x=cx2+Math.cos(v.heliAngle)*radius;
      v.y=cy2+Math.sin(v.heliAngle)*radius;
      v.angle=v.heliAngle+Math.PI/2;
      continue;
    }
    if(v.isJet){
      v.x+=120*dt;v.angle=0;
      if(v.x>canvasW+50){v.x=-50;v.y=pad+Math.random()*gs*cellH;}
      continue;
    }
    const dx=v.targetX-v.x,dy=v.targetY-v.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const step=v.speed*dt;
    if(dist<step+1){
      v.x=v.targetX;v.y=v.targetY;
      // Pick next road segment
      const dirs=[];
      const ci=Math.round((v.x-pad)/cellW),ri=Math.round((v.y-pad)/cellH);
      if(ci>0)dirs.push({x:pad+(ci-1)*cellW,y:v.y,d:0});
      if(ci<gs)dirs.push({x:pad+(ci+1)*cellW,y:v.y,d:1});
      if(ri>0)dirs.push({x:v.x,y:pad+(ri-1)*cellH,d:2});
      if(ri<gs)dirs.push({x:v.x,y:pad+(ri+1)*cellH,d:3});
      // Prefer continuing same direction
      const same=dirs.filter(d=>d.d===v.dir);
      const pick=(same.length>0&&Math.random()<0.7)?same[0]:dirs[Math.floor(Math.random()*dirs.length)];
      if(pick){v.targetX=pick.x;v.targetY=pick.y;v.dir=pick.d;}
    }else{
      v.x+=(dx/dist)*step;v.y+=(dy/dist)*step;
      v.angle=Math.atan2(dy,dx);
    }
  }
}
function drawVehicleSprite(c,type,x,y,angle){
  c.save();c.translate(x,y);c.rotate(angle);
  const gs=getGridSize();const s=Math.max(14,Math.min(28,(canvasW-100)/gs*.18));
  const sc=s/10; // scale factor relative to old 10px size
  switch(type){
    case 0:// Skateboard
      c.fillStyle="#D2691E";c.fillRect(-s/2,-2*sc,s,4*sc);
      c.fillStyle="#333";c.beginPath();c.arc(-s/3,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(s/3,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      break;
    case 1:// Bicycle
      c.strokeStyle="#00BFFF";c.lineWidth=1.2*sc;
      c.beginPath();c.arc(-4*sc,0,3*sc,0,Math.PI*2);c.stroke();
      c.beginPath();c.arc(4*sc,0,3*sc,0,Math.PI*2);c.stroke();
      c.beginPath();c.moveTo(-4*sc,0);c.lineTo(0,-3*sc);c.lineTo(4*sc,0);c.stroke();
      break;
    case 2:// Scooter
      c.fillStyle="#00FF7F";c.fillRect(-4*sc,-2*sc,8*sc,4*sc);
      c.fillStyle="#333";c.beginPath();c.arc(-4*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(4*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.strokeStyle="#00FF7F";c.lineWidth=1.5*sc;c.beginPath();c.moveTo(5*sc,-2*sc);c.lineTo(6*sc,-5*sc);c.stroke();
      break;
    case 3:// Car
      c.fillStyle="#1E90FF";c.beginPath();c.roundRect(-6*sc,-3*sc,12*sc,6*sc,2*sc);c.fill();
      c.fillStyle="#0a3a6f";c.fillRect(-4*sc,-4*sc,8*sc,2*sc);
      c.fillStyle="#222";c.beginPath();c.arc(-4*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(4*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      break;
    case 4:// Sports Car
      c.fillStyle="#FF4500";c.beginPath();c.roundRect(-7*sc,-2.5*sc,14*sc,5*sc,2*sc);c.fill();
      c.fillStyle="#8b2500";c.fillRect(-4*sc,-4*sc,8*sc,2*sc);
      c.fillStyle="#222";c.beginPath();c.arc(-5*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(5*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      break;
    case 5:// Luxury
      c.fillStyle="#191970";c.beginPath();c.roundRect(-7*sc,-3*sc,14*sc,6*sc,2*sc);c.fill();
      c.fillStyle="#23236e";c.fillRect(-5*sc,-4.5*sc,10*sc,2*sc);
      c.fillStyle="#222";c.beginPath();c.arc(-5*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(5*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.fillStyle="#f0c040";c.fillRect(7*sc,-1*sc,2*sc,2*sc);
      break;
    case 6:// Limo
      c.fillStyle="#2F4F4F";c.beginPath();c.roundRect(-9*sc,-3*sc,18*sc,6*sc,2*sc);c.fill();
      c.fillStyle="#3a5a5a";c.fillRect(-6*sc,-4.5*sc,12*sc,2*sc);
      c.fillStyle="#222";c.beginPath();c.arc(-7*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(0,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(7*sc,3*sc,1.5*sc,0,Math.PI*2);c.fill();
      c.fillStyle="#c0c0c0";c.fillRect(-8*sc,-1*sc,1.5*sc,2*sc);c.fillRect(8*sc,-1*sc,1.5*sc,2*sc);
      break;
    case 7:// Helicopter
      c.globalAlpha=.8;
      c.fillStyle="#708090";c.beginPath();c.ellipse(0,0,7*sc,4*sc,0,0,Math.PI*2);c.fill();
      c.fillStyle="#4a5568";c.fillRect(6*sc,-1*sc,5*sc,2*sc);
      const rAngle=performance.now()*.02;
      c.strokeStyle="rgba(255,255,255,.5)";c.lineWidth=1.5*sc;
      c.beginPath();c.moveTo(-8*sc*Math.cos(rAngle),-3*sc);c.lineTo(8*sc*Math.cos(rAngle),-3*sc);c.stroke();
      c.globalAlpha=1;
      break;
    case 8:// Yacht
      c.fillStyle="#1E90FF";c.beginPath();c.moveTo(-8*sc,2*sc);c.lineTo(-6*sc,-2*sc);c.lineTo(8*sc,-2*sc);c.lineTo(6*sc,2*sc);c.closePath();c.fill();
      c.fillStyle="#fff";c.beginPath();c.moveTo(2*sc,-2*sc);c.lineTo(2*sc,-8*sc);c.lineTo(7*sc,-2*sc);c.closePath();c.fill();
      c.strokeStyle="rgba(255,255,255,.6)";c.lineWidth=1;c.beginPath();c.moveTo(2*sc,-2*sc);c.lineTo(2*sc,-8*sc);c.stroke();
      break;
    case 9:// Private Jet
      c.fillStyle="#C0C0C0";c.beginPath();c.ellipse(0,0,8*sc,2.5*sc,0,0,Math.PI*2);c.fill();
      c.fillStyle="#a0a0a0";c.beginPath();c.moveTo(-3*sc,-2.5*sc);c.lineTo(-2*sc,-6*sc);c.lineTo(3*sc,-6*sc);c.lineTo(4*sc,-2.5*sc);c.closePath();c.fill();
      c.fillStyle="#c0392b";c.fillRect(-8*sc,-0.5*sc,16*sc,1*sc);
      c.fillStyle="#a0a0a0";c.beginPath();c.moveTo(6*sc,0);c.lineTo(9*sc,-2*sc);c.lineTo(9*sc,2*sc);c.closePath();c.fill();
      break;
  }
  c.restore();
}
function drawMogul(m){
  const cos=state.cosmetics.characterOutfit;
  ctx.save();ctx.translate(m.x,m.y);
  if(!m.facingRight)ctx.scale(-1,1);
  const la=Math.sin(m.walkFrame*.3)*.5;
  const aa=Math.sin(m.walkFrame*.3+1)*.6;
  // Rainbow Aura (behind everything)
  if(cos.aura){
    const t=performance.now()*.002;
    const hue=Math.floor(t*60)%360;
    ctx.fillStyle=`hsla(${hue},70%,60%,.15)`;
    ctx.beginPath();ctx.arc(0,-5,28,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=`hsla(${(hue+120)%360},70%,60%,.08)`;
    ctx.beginPath();ctx.arc(0,-5,35,0,Math.PI*2);ctx.fill();
  }
  // Cape (behind body)
  if(cos.cape){
    const capeSwing=Math.sin(m.walkFrame*.25)*8;
    ctx.fillStyle="#8b0000";
    ctx.beginPath();ctx.moveTo(-6,-6);ctx.lineTo(-8-capeSwing,18);ctx.lineTo(8+capeSwing,18);ctx.lineTo(6,-6);ctx.closePath();ctx.fill();
    ctx.fillStyle="rgba(200,0,0,.3)";
    ctx.beginPath();ctx.moveTo(-4,-4);ctx.lineTo(-6-capeSwing*.7,15);ctx.lineTo(6+capeSwing*.7,15);ctx.lineTo(4,-4);ctx.closePath();ctx.fill();
  }
  // Shadow
  ctx.fillStyle="rgba(0,0,0,.3)";ctx.beginPath();ctx.ellipse(0,24,14,5,0,0,Math.PI*2);ctx.fill();
  // Shoes
  ctx.fillStyle="#1a1a1a";
  const lx1=-4+Math.sin(la)*7, ly1=22;
  const lx2=4-Math.sin(la)*7, ly2=22;
  ctx.beginPath();ctx.ellipse(lx1,ly1,4,2,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(lx2,ly2,4,2,0,0,Math.PI*2);ctx.fill();
  // Pants (dark gray)
  ctx.strokeStyle="#252540";ctx.lineWidth=4;ctx.lineCap="round";
  ctx.beginPath();ctx.moveTo(-1,8);ctx.lineTo(lx1,ly1-2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(1,8);ctx.lineTo(lx2,ly2-2);ctx.stroke();
  // Body (suit jacket)
  const eqSuit=cos._equippedSuit||"classic";
  let suitColor="#1a1a3a",lapelColor="#15152a";
  if(eqSuit==="whiteSuit"||cos.whiteSuit){suitColor="#e8e8f0";lapelColor="#d0d0d8";}
  else if(eqSuit==="goldSuit"){suitColor="#c49b20";lapelColor="#a68018";}
  else if(eqSuit==="redVelvet"){suitColor="#8b1a1a";lapelColor="#6b1010";}
  else if(eqSuit==="tuxedo"){suitColor="#0a0a1e";lapelColor="#000010";}
  ctx.fillStyle=suitColor;
  ctx.beginPath();
  ctx.moveTo(-8,-6);ctx.lineTo(-9,10);ctx.lineTo(9,10);ctx.lineTo(8,-6);
  ctx.closePath();ctx.fill();
  // Suit lapels
  ctx.fillStyle=lapelColor;
  ctx.beginPath();ctx.moveTo(0,-6);ctx.lineTo(-4,4);ctx.lineTo(0,4);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(0,-6);ctx.lineTo(4,4);ctx.lineTo(0,4);ctx.closePath();ctx.fill();
  // Shirt
  ctx.fillStyle=(eqSuit==="whiteSuit"||cos.whiteSuit)?"#f8f8ff":"#e8e8f0";ctx.fillRect(-2,-4,4,8);
  // Tie
  ctx.fillStyle="#c41e3a";
  ctx.beginPath();ctx.moveTo(0,-4);ctx.lineTo(-2,0);ctx.lineTo(0,6);ctx.lineTo(2,0);ctx.closePath();ctx.fill();
  ctx.fillStyle="#9a1830";ctx.beginPath();ctx.arc(0,-3,1.5,0,Math.PI*2);ctx.fill();
  // Arms
  ctx.strokeStyle=suitColor;ctx.lineWidth=4;
  const rArmX=10+Math.sin(aa)*6, rArmY=12;
  const lArmX=-10-Math.sin(aa)*6, lArmY=12;
  ctx.beginPath();ctx.moveTo(7,0);ctx.quadraticCurveTo(10,6,rArmX,rArmY);ctx.stroke();
  ctx.beginPath();ctx.moveTo(-7,0);ctx.quadraticCurveTo(-10,6,lArmX,lArmY);ctx.stroke();
  // Hands
  ctx.fillStyle="#f0d0a8";
  ctx.beginPath();ctx.arc(rArmX,rArmY,2.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(lArmX,lArmY,2.5,0,Math.PI*2);ctx.fill();
  // Briefcase
  const caseColor=cos.goldCase?"#f0c040":"#6b3a1a";
  const caseHighlight=cos.goldCase?"#ffd700":"#8b5a2a";
  const caseLatch=cos.goldCase?"#fff":"#f0c040";
  ctx.fillStyle=caseColor;
  const bx=rArmX,by=rArmY+2;
  ctx.beginPath();ctx.roundRect(bx-5,by-1,10,7,2);ctx.fill();
  ctx.fillStyle=caseHighlight;ctx.fillRect(bx-5,by-1,10,1.5);
  ctx.fillStyle=caseLatch;ctx.fillRect(bx-1.5,by+1,3,1.5);
  ctx.strokeStyle=cos.goldCase?"#b8860b":"#4a2a0a";ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(bx,by-2,3,Math.PI,0);ctx.stroke();
  // Watch (on left wrist)
  if(cos.watch){ctx.fillStyle="#f0c040";ctx.fillRect(lArmX-2,lArmY-1.5,4,2.5);ctx.fillStyle="#ffd700";ctx.beginPath();ctx.arc(lArmX,lArmY-0.5,2,0,Math.PI*2);ctx.fill();}
  // Rose (on lapel)
  if(cos.rose){ctx.fillStyle="#c41e3a";ctx.beginPath();ctx.arc(-5,-2,1.8,0,Math.PI*2);ctx.fill();ctx.fillStyle="#2a5a2a";ctx.fillRect(-5.3,0,0.8,2.5);}
  // Neck
  ctx.fillStyle="#f0d0a8";ctx.fillRect(-3,-10,6,5);
  // Head
  ctx.fillStyle="#f0d0a8";ctx.beginPath();ctx.arc(0,-15,9,0,Math.PI*2);ctx.fill();
  // Ears
  ctx.beginPath();ctx.arc(-9,-15,2.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(9,-15,2.5,0,Math.PI*2);ctx.fill();
  // Eyes
  ctx.fillStyle="#fff";
  ctx.beginPath();ctx.ellipse(3,-16,2.5,2,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(-3,-16,2.5,2,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle="#1a1a2e";
  ctx.beginPath();ctx.arc(3.5,-16,1.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(-2.5,-16,1.2,0,Math.PI*2);ctx.fill();
  // Eyebrows
  ctx.strokeStyle="#2a2a3a";ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(1,-19);ctx.lineTo(5.5,-18.5);ctx.stroke();
  ctx.beginPath();ctx.moveTo(-1,-19);ctx.lineTo(-5.5,-18.5);ctx.stroke();
  // Mustache
  ctx.fillStyle="#2a2a3a";
  ctx.beginPath();
  ctx.moveTo(-6,-12);ctx.quadraticCurveTo(-3,-10,0,-11);ctx.quadraticCurveTo(3,-10,6,-12);
  ctx.quadraticCurveTo(3,-11,0,-12.5);ctx.quadraticCurveTo(-3,-11,-6,-12);
  ctx.fill();
  // Smile
  ctx.strokeStyle="#c08080";ctx.lineWidth=1;
  ctx.beginPath();ctx.arc(0,-11,3,0.2,Math.PI-0.2);ctx.stroke();
  // Hat (from configurator or legacy)
  const eqHat=cos._equippedHat||"topHat";
  if(eqHat==="crown"||cos.crown){
    ctx.fillStyle="#f0c040";
    ctx.beginPath();ctx.moveTo(-8,-23);ctx.lineTo(-8,-32);ctx.lineTo(-4,-28);ctx.lineTo(0,-34);ctx.lineTo(4,-28);ctx.lineTo(8,-32);ctx.lineTo(8,-23);ctx.closePath();ctx.fill();
    ctx.fillStyle="#c41e3a";ctx.beginPath();ctx.arc(-4,-28,1.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(0,-30,1.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(4,-28,1.5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#ffd700";ctx.fillRect(-8,-25,16,2.5);
  }else if(eqHat==="fedora"){
    ctx.fillStyle="#6b4226";ctx.beginPath();ctx.ellipse(0,-23,13,3,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#8b5a3a";ctx.beginPath();ctx.roundRect(-8,-32,16,10,3);ctx.fill();
    ctx.fillStyle="#1a1a1a";ctx.fillRect(-8,-25,16,1.5);
  }else if(eqHat==="baseballCap"){
    ctx.fillStyle="#2563eb";ctx.beginPath();ctx.arc(0,-22,9,Math.PI,0);ctx.fill();
    ctx.fillStyle="#1e40af";ctx.fillRect(-12,-22,24,3);
    ctx.fillStyle="#fff";ctx.font="bold 5px sans-serif";ctx.textAlign="center";ctx.fillText("M",0,-26);
  }else if(eqHat==="cowboyHat"){
    ctx.fillStyle="#a0764a";ctx.beginPath();ctx.ellipse(0,-22,15,3.5,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#c4956a";ctx.beginPath();ctx.moveTo(-6,-22);ctx.quadraticCurveTo(-3,-35,0,-33);ctx.quadraticCurveTo(3,-35,6,-22);ctx.lineTo(-6,-22);ctx.fill();
  }else if(eqHat==="wizardHat"){
    ctx.fillStyle="#3b1f8e";ctx.beginPath();ctx.ellipse(0,-22,11,3,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.moveTo(-9,-22);ctx.lineTo(0,-44);ctx.lineTo(9,-22);ctx.closePath();ctx.fill();
    ctx.fillStyle="#ffd700";ctx.beginPath();ctx.arc(-2,-32,1.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(3,-28,1,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(0,-36,1.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#f0c040";ctx.fillRect(-9,-24,18,2);
  }else{
    // Default top hat
    ctx.fillStyle="#1a1a2e";ctx.beginPath();ctx.ellipse(0,-23,12,3,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#1a1a35";ctx.beginPath();ctx.roundRect(-7,-38,14,16,2);ctx.fill();
    ctx.fillStyle="#f0c040";ctx.fillRect(-7,-26,14,2.5);
    ctx.fillStyle="rgba(255,255,255,.08)";ctx.fillRect(-5,-36,4,12);
  }
  // Monocle
  if(state.prestigeCount>0||cos.monocleSparkle){
    ctx.strokeStyle="#f0c040";ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(4,-16,3.5,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(7,-14);ctx.lineTo(8,-8);ctx.stroke();
    // Diamond sparkle effect
    if(cos.monocleSparkle){
      const sp=performance.now()*.003;
      const sx=4+Math.cos(sp*3)*2,sy=-16+Math.sin(sp*5)*2;
      ctx.fillStyle="rgba(255,255,255,.8)";
      ctx.beginPath();ctx.moveTo(sx,sy-2);ctx.lineTo(sx+1,sy);ctx.lineTo(sx,sy+2);ctx.lineTo(sx-1,sy);ctx.closePath();ctx.fill();
    }
  }
  // Cigar
  if(cos.cigar){ctx.fillStyle="#8b6b3a";ctx.fillRect(6,-12,7,2);ctx.fillStyle="#ff6030";ctx.beginPath();ctx.arc(13,-11,1.3,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(180,180,180,.25)";ctx.beginPath();ctx.arc(14,-14,2.5,0,Math.PI*2);ctx.fill();}
  ctx.restore();
}
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=0.025;
    if(p.life<=0){particles.splice(i,1);continue;}
    ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size||2.5,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}
function drawFloatTexts(dt){
  for(let i=floatTexts.length-1;i>=0;i--){
    const f=floatTexts[i];
    f.y-=70*dt;f.life-=dt/0.7;
    if(f.life<=0){floatTexts.splice(i,1);continue;}
    ctx.globalAlpha=f.life;
    ctx.fillStyle=f.color;
    ctx.font=`800 ${f.size}px -apple-system,system-ui,sans-serif`;
    ctx.textAlign="center";ctx.textBaseline="middle";
    const s=1+(1-f.life)*0.2;
    ctx.save();ctx.translate(f.x,f.y);ctx.scale(s,s);
    ctx.fillText(f.text,0,0);
    ctx.restore();
  }
  ctx.globalAlpha=1;
}
function spawnParticles(x,y,count,color){
  for(let i=0;i<count;i++){
    particles.push({x,y,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7-3,life:.4+Math.random()*.6,color:color||"#f0c040",size:1.5+Math.random()*2});
  }
}
// ─── Tax Inspector System ───
function updateTaxInspector(dt,gs){
  const totalProps=state.properties.reduce((a,b)=>a+b,0);
  const ti=state.taxInspector;
  if(state.randomEvent.active&&state.randomEvent.effect==='taxHoliday'){ti.active=false;return;}
  if(totalProps<5){ti.active=false;return;}
  // Timed visit system: active 30-60s, then cooldown 45-90s
  if(!ti.active){
    ti.drainTimer+=dt;
    const cooldown=45+Math.random()*45; // 45-90s between visits
    if(ti.drainTimer>=cooldown){
      ti.active=true;ti.draining=false;ti.tapped=false;ti.approaching=true;
      ti.visitTimer=30+Math.random()*30; // 30-60s visit duration
      const pad2=50,cellW2=(canvasW-pad2*2)/gs;
      const ci2=Math.floor(Math.random()*(gs+1)),ri2=Math.floor(Math.random()*(gs+1));
      ti.x=pad2+ci2*cellW2;ti.y=pad2+ri2*(canvasH-pad2*2)/gs;
      ti.targetX=ti.x;ti.targetY=ti.y;ti.speed=40;ti.drainTimer=0;
    }
    return;
  }
  // Count down visit duration — inspector leaves after time expires
  ti.visitTimer=(ti.visitTimer||30)-dt;
  if(ti.visitTimer<=0){ti.active=false;ti.draining=false;ti.tapped=false;return;}
  const dx2=state.mogul.x-ti.x,dy2=state.mogul.y-ti.y;
  const dist2=Math.sqrt(dx2*dx2+dy2*dy2);
  if(dist2<30&&!ti.draining&&!ti.tapped){
    ti.draining=true;ti.approaching=false;
    const taxLevel=Math.min(5,Math.floor(totalProps/10));
    let drainAmt=getIncome()*0.05*taxLevel;
    // Managers auto-reduce drain (each hired manager reduces 12%)
    const hiredManagers=state.managers.filter(m=>m).length;
    drainAmt*=Math.max(0.1,1-hiredManagers*0.12);
    // Tax Optimizer perk: reduce drain by 10%/lvl
    drainAmt*=Math.max(0.1,1-getPerkEffect('taxReduction'));
    state.cash=Math.max(0,state.cash-drainAmt);
    floatTexts.push({x:ti.x,y:ti.y-20,text:"-"+fmt(drainAmt)+" Tax!",color:"#f87171",size:16,life:1});
    spawnParticles(ti.x,ti.y,8,"#f87171");
    setTimeout(()=>{ti.active=false;ti.draining=false;ti.tapped=false;},1500);
    return;
  }
  if(!ti.draining){
    const step2=ti.speed*dt;
    if(dist2>5){ti.x+=(dx2/dist2)*step2;ti.y+=(dy2/dist2)*step2;}
  }
}
function drawTaxInspector(c){
  const ti=state.taxInspector;if(!ti.active)return;
  c.save();c.translate(ti.x,ti.y);
  c.fillStyle="#1a1a2e";c.fillRect(-5,-2,10,12);
  c.fillStyle="#f0d0a8";c.beginPath();c.arc(0,-7,6,0,Math.PI*2);c.fill();
  c.fillStyle="#dc143c";c.beginPath();c.moveTo(0,-2);c.lineTo(-1.5,2);c.lineTo(0,5);c.lineTo(1.5,2);c.closePath();c.fill();
  c.fillStyle="#8B4513";c.fillRect(6,0,5,7);c.fillStyle="#fff";c.fillRect(7,1,3,5);
  c.strokeStyle="#333";c.lineWidth=1;
  c.beginPath();c.arc(-2.5,-8,2,0,Math.PI*2);c.stroke();
  c.beginPath();c.arc(2.5,-8,2,0,Math.PI*2);c.stroke();
  c.beginPath();c.moveTo(0.5,-8);c.lineTo(-0.5,-8);c.stroke();
  if(ti.approaching&&!ti.draining){
    const bob=Math.sin(performance.now()*.005)*3;
    c.fillStyle="#f87171";c.font="bold 16px system-ui";c.textAlign="center";c.textBaseline="middle";
    c.fillText("!",0,-18+bob);
  }
  c.restore();
}
function checkTaxInspectorTap(x,y){
  const ti=state.taxInspector;
  if(!ti.active||ti.draining||ti.tapped)return false;
  const dx3=x-ti.x,dy3=y-ti.y;
  if(Math.sqrt(dx3*dx3+dy3*dy3)<30){
    ti.tapped=true;
    const taxLevel=Math.min(5,Math.floor(state.properties.reduce((a,b)=>a+b,0)/10));
    const fullDrain=getIncome()*0.05*taxLevel;
    const saved=fullDrain*0.8;
    floatTexts.push({x:ti.x,y:ti.y-20,text:"+"+fmt(saved)+" Saved!",color:"#34d399",size:16,life:1});
    spawnParticles(ti.x,ti.y,10,"#34d399");
    state.taxOutclicks=(state.taxOutclicks||0)+1;
    ti.active=false;checkAchievements();
    return true;
  }
  return false;
}

// ─── Random Events System ───
let eventTimerAccum=0;
function updateRandomEvents(dt){
  if(state.randomEvent.active){
    if(Date.now()/1000>=state.randomEvent.endsAt){
      if(state.randomEvent.effect==='incomeBoost')state.passiveMultBonus/=state.randomEvent.value;
      else if(state.randomEvent.effect==='incomePenalty')state.passiveMultBonus/=state.randomEvent.value;
      state.randomEvent.active=false;
      document.getElementById('event-banner').style.display='none';
    }else{
      const remaining=Math.ceil(state.randomEvent.endsAt-Date.now()/1000);
      const banner=document.getElementById('event-banner');
      banner.innerHTML=state.randomEvent.name+' <span class="event-timer">'+remaining+'s</span>';
    }
    return;
  }
  eventTimerAccum+=dt;
  // Event Catalyst perk: 15%/lvl more likely (reduces timer threshold)
  const eventThreshold=(180+Math.random()*120)*Math.max(0.3,1-getPerkEffect('eventBoost'));
  if(eventTimerAccum>=eventThreshold){
    eventTimerAccum=0;triggerRandomEvent();
  }
}
function triggerRandomEvent(){
  const evt=RANDOM_EVENTS[Math.floor(Math.random()*RANDOM_EVENTS.length)];
  state.eventsExperienced=(state.eventsExperienced||0)+1;
  addXP(100);
  const banner=document.getElementById('event-banner');
  banner.style.display='block';
  banner.style.background=evt.color+'22';banner.style.border='1px solid '+evt.color+'44';banner.style.color=evt.color;
  if(evt.effect==='instantCash'){
    const bonus=getIncome()*evt.value;
    state.cash+=bonus;state.totalCash+=bonus;
    banner.textContent=evt.name+': '+fmt(bonus);
    setTimeout(()=>{banner.style.display='none';},3000);
    notify(evt.name+": +"+fmt(bonus));
  }else if(evt.effect==='discount'){
    state.nextDiscount=true;
    banner.textContent=evt.name+': Next purchase 50% off!';
    setTimeout(()=>{banner.style.display='none';},5000);
    notify(evt.name+": Next purchase 50% off!");
  }else{
    // Event Catalyst perk: events last 20%/lvl longer
    const evtDuration=evt.duration*(1+getPerkEffect('eventBoost')*1.33);
    state.randomEvent={active:true,name:evt.name,effect:evt.effect,value:evt.value,endsAt:Date.now()/1000+evtDuration,color:evt.color};
    if(evt.effect==='incomeBoost')state.passiveMultBonus*=evt.value;
    else if(evt.effect==='incomePenalty')state.passiveMultBonus*=evt.value;
    banner.innerHTML=evt.name+' <span class="event-timer">'+evt.duration+'s</span>';
    notify(evt.name+": "+evt.desc);
  }
  checkAchievements();updateHUD();
}

function render(ts){
  if(!lastFrame)lastFrame=ts;
  const dt=Math.min((ts-lastFrame)/1000,0.1);
  lastFrame=ts;
  if(!ctx){requestAnimationFrame(render);return;}
  updateCamera();
  ctx.clearRect(0,0,canvasW,canvasH);
  const gs=getGridSize();
  // === WORLD SPACE (camera transform) ===
  applyCamera(ctx);
  drawCity(gs);
  // Vehicle system
  syncVehicleSprites(gs);
  updateVehicles(dt,gs);
  for(const v of vehicleSprites){drawVehicleSprite(ctx,v.type,v.x,v.y,v.angle);}
  const wps=getWaypoints(gs);
  if(wps.length>0){
    const m=state.mogul,target=wps[m.targetIdx%wps.length];
    const dx=target.x-m.x,dy=target.y-m.y,dist=Math.sqrt(dx*dx+dy*dy);
    m.speed=60+state.clicksThisSecond*30+Math.min(getIncome()*.01,200);
    const step=m.speed*dt;
    if(dist<step+2){m.x=target.x;m.y=target.y;m.targetIdx=(m.targetIdx+1)%wps.length;}
    else{m.x+=(dx/dist)*step;m.y+=(dy/dist)*step;}
    m.facingRight=dx>0||(dx===0&&m.facingRight);
    m.walkFrame+=m.speed*dt*.15;
    drawMogul(m);
  }
  // Manager NPCs
  updateManagerNPCs(dt);
  for(const mgr of managerSprites)drawManagerNPC(ctx,mgr);
  // Tax inspector
  updateTaxInspector(dt,gs);
  drawTaxInspector(ctx);
  // Income $ particles (world space)
  updateIncomeParticles(dt);
  drawIncomeParticles(ctx);
  // Income floating text (world space)
  incomeFloatTimer+=dt;
  if(incomeFloatTimer>=3&&getIncome()>0){incomeFloatTimer=0;spawnIncomeFloat();}
  renderIncomeFloats(dt);
  drawParticles();
  drawFloatTexts(dt);
  resetCamera(ctx);
  // === SCREEN SPACE (HUD, overlays) ===
  // Random events
  updateRandomEvents(dt);
  // Spin wheel overlay
  updateWheel();
  drawWheel(ctx);
  requestAnimationFrame(render);
}

// ═══════════════════════════════════════════════════════════════
// CLICK HANDLING
// ═══════════════════════════════════════════════════════════════
function handleClick(e){
  if(currentView !== "game") return;
  const sx=e.clientX, sy=e.clientY;
  // Spin wheel blocks game clicks
  if(wheelState.active){
    if(wheelState.phase==='idle')startSpin();
    else if(wheelState.phase==='result'){wheelState.active=false;wheelState.phase='idle';}
    return;
  }
  // Convert to world coords for building/entity detection
  const world=screenToWorld(sx,sy);
  const wx=world.x,wy=world.y;
  // Check tax inspector tap first (world coords)
  if(checkTaxInspectorTap(wx,wy))return;
  // Check building tap for upgrade popup
  if(detectBuildingTap(wx,wy))return;
  // Close upgrade popup on click elsewhere
  if(upgradeTarget){hideUpgradePopup();return;}
  // Click decay system
  const now=Date.now();
  const timeSinceLast=now-state.lastClickTime;
  const decayReduction=getPerkEffect('clickDecayReduction');
  if(timeSinceLast<500){
    state.clickDecayFactor=Math.max(0.1,state.clickDecayFactor-(0.15-decayReduction));
  }else{
    state.clickDecayFactor=Math.min(1.0,state.clickDecayFactor+0.3);
  }
  state.lastClickTime=now;
  updateStaminaBar();
  let value=getClickValue()*state.clickDecayFactor;
  // Critical Strike check
  const critChance=getPerkEffect('critChance');
  let isCrit=false;
  if(critChance>0&&Math.random()<critChance){
    value*=3;isCrit=true;
    // Splash Damage from crits
    const splashPct=getPerkEffect('critSplash');
    if(splashPct>0){
      const splashVal=value*splashPct;
      state.cash+=splashVal;state.totalCash+=splashVal;
    }
  }
  // Midas Touch: every 10th click
  state.midasCounter=(state.midasCounter||0)+1;
  if((state.unlockedPerks['midasTouch']||0)>=1&&state.midasCounter>=10){
    state.midasCounter=0;
    value*=10;
    // 5s income burst
    const burstIncome=getIncome()*5;
    state.cash+=burstIncome;state.totalCash+=burstIncome;
    floatTexts.push({x:wx,y:wy-30,text:'MIDAS! +'+fmt(burstIncome),color:'#fbbf24',size:20,life:1.5});
  }
  state.cash+=value; state.totalCash+=value; state.totalClicks++; state.clicksThisSecond++;
  // Float text color based on efficiency + crit
  const effPct=Math.round(state.clickDecayFactor*100);
  let ftColor=value>100?'#f0c040':'#34d399';
  let ftExtra='';
  if(isCrit){ftColor='#fbbf24';ftExtra=' CRIT!';}
  if(effPct<100)ftExtra+=' ('+effPct+'%)';
  floatTexts.push({x:wx,y:wy,text:'+'+fmt(value)+(ftExtra),color:ftColor,size:Math.min(14+Math.log10(value+1)*4,28)+(isCrit?4:0),life:1});
  spawnParticles(wx,wy,3+Math.min(Math.floor(value/100),10)+(isCrit?5:0),isCrit?'#fbbf24':'#f0c040');
  playSound('click'); haptic(10);
  // XP from click
  addXP(1+Math.max(0,Math.floor(Math.log10(value+1)*2)));
  // Double Dip: bonus XP from passive income
  const ddPct=getPerkEffect('clickXPBonus');
  if(ddPct>0)addXP(Math.floor(getIncome()*ddPct));
  checkMilestones(); checkAchievements(); updateHUD();
}
function detectBuildingTap(wx,wy){
  const gs=getGridSize();
  if(!state.cityGrid)return false;
  const pad=getGridPad(),cellW=(canvasW-pad*2)/gs;
  const col=Math.floor((wx-pad)/cellW),row=Math.floor((wy-pad)/cellW);
  if(row<0||row>=gs||col<0||col>=gs)return false;
  const cell=state.cityGrid[row]&&state.cityGrid[row][col];
  if(!cell||cell.length===0)return false;
  // Find closest building in cell
  const buildings=[...cell].sort((a,b)=>a.tier-b.tier);
  for(let i=buildings.length-1;i>=0;i--){
    const slot=getMicroSlotPos(pad+col*cellW,pad+row*cellW,cellW,cellW,i,cell.length);
    const dx=wx-slot.x,dy=wy-slot.y;
    if(Math.abs(dx)<slot.w/2&&Math.abs(dy)<slot.h/2){
      showUpgradePopup(buildings[i],row,col,i);
      return true;
    }
  }
  // Tap was inside cell but missed building - still count as building tap for first building
  showUpgradePopup(buildings[0],row,col,0);
  return true;
}
// Touch support
function handleTouch(e){
  e.preventDefault();
  for(let i=0;i<e.changedTouches.length;i++){
    const t=e.changedTouches[i];
    handleClick({clientX:t.clientX,clientY:t.clientY});
  }
}

function checkMilestones(){
  const gs=getGridSize();
  const msIdx=Math.min(gs-2,MILESTONES.length-1);
  if(msIdx>state.currentMilestone){
    const oldGs=state.currentMilestone+2;
    state.currentMilestone=msIdx;
    const newGs=gs;
    const ms=MILESTONES[msIdx];
    showMilestoneBanner(ms.name,ms.desc);
    notify("Map expanded: "+ms.name);
    // Expand cityGrid for new grid size
    if(state.cityGrid)expandCityGrid(oldGs,newGs);
    // Rebuild manager routes for new grid
    for(const mgr of managerSprites)buildManagerRoute(mgr);
    state.mogul.targetIdx=0;
    vehicleSprites=[];invalidateBuildingCache();
  }
}
function showMilestoneBanner(title,desc){
  const b=document.getElementById("milestone-banner");
  document.getElementById("ms-title").textContent=title;
  document.getElementById("ms-desc").textContent=desc;
  b.classList.add("show");
  setTimeout(()=>b.classList.remove("show"),2500);
}

// ═══════════════════════════════════════════════════════════════
// SHOP
// ═══════════════════════════════════════════════════════════════
function flashBuyAnimation(idx){
  const items=document.querySelectorAll("#shop-items .shop-item");
  if(items[idx]){items[idx].classList.add("just-bought");setTimeout(()=>items[idx].classList.remove("just-bought"),300);}
}
function buyVehicle(idx){
  const v=VEHICLES[idx];
  const qty=getActualBulkQty(v.baseCost,state.vehicles[idx],v.scaling);
  if(qty<=0)return;
  let cost=getBulkCost(v.baseCost,state.vehicles[idx],v.scaling,qty);
  if(state.nextDiscount){cost=Math.floor(cost*0.5);state.nextDiscount=false;notify("50% discount applied!");}
  // Bulk Buyer perk: 5%/lvl discount on 10+ purchases
  if(qty>=10){const bd=getPerkEffect('bulkDiscount');if(bd>0)cost=Math.floor(cost*(1-bd));}
  if(state.cash<cost)return;
  state.cash-=cost; state.vehicles[idx]+=qty;
  playSound('buy'); haptic(15);
  addXP(Math.floor(cost/100));
  addMomentumStack();
  checkAchievements(); updateHUD(); renderShop();
  flashBuyAnimation(idx);
}
function buyLand(){
  if(state.landCells>=MAX_LAND_CELLS){notify("Maximum land reached!");return;}
  const cost=getLandCost(state.landCells);
  if(state.cash<cost)return;
  state.cash-=cost;
  const oldGs=getGridSize();
  state.landCells++;
  const newGs=getGridSize();
  if(newGs>oldGs)expandCityGrid(oldGs,newGs);
  invalidateBuildingCache();
  playSound('buy');haptic(30);
  addXP(Math.floor(cost/30));
  notify(`Land purchased! ${state.landCells}/${MAX_LAND_CELLS} plots owned`);
  updateHUD();renderShop();
}
function buyProperty(idx){
  const p=PROPERTIES[idx];
  const qty=getActualBulkQty(p.baseCost,state.properties[idx],p.scaling);
  if(qty<=0)return;
  let cost=getBulkCost(p.baseCost,state.properties[idx],p.scaling,qty);
  if(state.nextDiscount){cost=Math.floor(cost*0.5);state.nextDiscount=false;notify("50% discount applied!");}
  // Bulk Buyer perk: 5%/lvl discount on 10+ purchases
  if(qty>=10){const bd=getPerkEffect('bulkDiscount');if(bd>0)cost=Math.floor(cost*(1-bd));}
  if(state.cash<cost)return;
  state.cash-=cost; state.properties[idx]+=qty;
  // Place buildings on the city grid
  for(let k=0;k<qty;k++)placeBuilding(idx);
  // Smart Buildings perk: auto-upgrade to level 2 when 10+ owned
  const smartLvl=getPerkEffect('smartBuildings');
  if(smartLvl>0&&state.properties[idx]>=10){
    const gs=getGridSize();
    for(let r=0;r<gs;r++)for(let c2=0;c2<gs;c2++){
      if(state.cityGrid&&state.cityGrid[r]&&state.cityGrid[r][c2]){
        for(const bld of state.cityGrid[r][c2]){
          if(bld.tier===idx&&bld.level<2)bld.level=2;
        }
      }
    }
  }
  invalidateBuildingCache();
  // Rebuild manager routes when buildings change
  for(const mgr of managerSprites)buildManagerRoute(mgr);
  playSound('buy'); haptic(15);
  addXP(Math.floor(cost/50));
  addMomentumStack();
  checkAchievements(); updateHUD(); renderShop();
  flashBuyAnimation(idx);
}
function buyLicense(idx){
  if(state.licenses[idx])return;
  if(idx>0&&!state.licenses[idx-1])return;
  if(state.cash<LICENSES[idx].cost)return;
  state.cash-=LICENSES[idx].cost; state.licenses[idx]=true;
  recalcMultiplier();
  playSound('buy'); haptic(20);
  notify("Acquired "+LICENSES[idx].name+" ("+LICENSES[idx].multiplier+"x)");
  checkAchievements(); updateHUD(); renderShop();
}

function renderShop(){
  const c=document.getElementById("shop-items");
  c.innerHTML="";
  if(currentShopTab==="vehicles"){
    VEHICLES.forEach((v,i)=>{
      const qty=getActualBulkQty(v.baseCost,state.vehicles[i],v.scaling);
      const cost=qty>0?getBulkCost(v.baseCost,state.vehicles[i],v.scaling,qty):getCost(v.baseCost,state.vehicles[i],v.scaling);
      const can=state.cash>=cost&&qty>0;
      const d=document.createElement("div");
      d.className="shop-item"+(can?"":" cant-afford");
      const ql=qty>1?` (x${qty})`:"";
      const mb=getMilestoneBonus(state.vehicles[i]);
      const nextT=MILESTONE_THRESHOLDS.find(t=>state.vehicles[i]<t);
      const mbBadge=mb>1?`<span class="milestone-badge">${mb}x</span>`:'';
      const nextHint=nextT?` (${nextT} for ${mb*2}x)`:'';
      // Canvas preview icon
      const iconCvs=document.createElement('canvas');iconCvs.width=44;iconCvs.height=44;iconCvs.style.borderRadius='12px';iconCvs.style.background='linear-gradient(135deg,#1e3a5f,#2563eb)';iconCvs.style.flexShrink='0';
      const ic=iconCvs.getContext('2d');try{drawVehicleSprite(ic,i,22,22,0);}catch(e){}
      d.appendChild(iconCvs);
      const infoDiv=document.createElement('div');infoDiv.className='item-info';
      infoDiv.innerHTML=`<div class="item-name">${v.name}${ql}${mbBadge}</div><div class="item-desc">+${fmt(v.clickBonus*mb)}/click each${nextHint}</div>`;
      d.appendChild(infoDiv);
      const rightDiv=document.createElement('div');rightDiv.className='item-right';
      rightDiv.innerHTML=`<div class="item-cost">${fmt(cost)}</div><div class="item-owned">Owned: ${state.vehicles[i]}</div>`;
      d.appendChild(rightDiv);
      if(can)d.onclick=()=>buyVehicle(i);
      c.appendChild(d);
    });
  }else if(currentShopTab==="properties"){
    PROPERTIES.forEach((p,i)=>{
      const qty=getActualBulkQty(p.baseCost,state.properties[i],p.scaling);
      const cost=qty>0?getBulkCost(p.baseCost,state.properties[i],p.scaling,qty):getCost(p.baseCost,state.properties[i],p.scaling);
      const can=state.cash>=cost&&qty>0;
      const d=document.createElement("div");
      d.className="shop-item"+(can?"":" cant-afford");
      const ql=qty>1?` (x${qty})`:"";
      const mb=getMilestoneBonus(state.properties[i]);
      const nextT=MILESTONE_THRESHOLDS.find(t=>state.properties[i]<t);
      const mbBadge=mb>1?`<span class="milestone-badge">${mb}x</span>`:'';
      const nextHint=nextT?` (${nextT} for ${mb*2}x)`:'';
      // Canvas preview icon
      const iconCvs=document.createElement('canvas');iconCvs.width=44;iconCvs.height=44;iconCvs.style.borderRadius='12px';iconCvs.style.background='linear-gradient(135deg,#1a3a2a,#059669)';iconCvs.style.flexShrink='0';
      const ic=iconCvs.getContext('2d');try{drawMicroBuilding(ic,PROPERTIES[i].type,22,22,30,30,null);}catch(e){}
      d.appendChild(iconCvs);
      const infoDiv=document.createElement('div');infoDiv.className='item-info';
      infoDiv.innerHTML=`<div class="item-name">${p.name}${ql}${mbBadge}</div><div class="item-desc">+${fmt(p.income*mb)}/sec each${nextHint}</div>`;
      d.appendChild(infoDiv);
      const rightDiv=document.createElement('div');rightDiv.className='item-right';
      rightDiv.innerHTML=`<div class="item-cost">${fmt(cost)}</div><div class="item-owned">Owned: ${state.properties[i]}</div>`;
      d.appendChild(rightDiv);
      if(can)d.onclick=()=>buyProperty(i);
      c.appendChild(d);
    });
  }else if(currentShopTab==="land"){
    // Land purchase tab
    const owned=state.landCells||1;
    const maxed=owned>=MAX_LAND_CELLS;
    const gs=getGridSize();
    // Header info
    const header=document.createElement("div");
    header.style.cssText="padding:16px 8px 8px;text-align:center";
    header.innerHTML=`<div style="font-size:18px;font-weight:800;color:var(--gold)">${ICONS.star} Your Empire</div>
      <div style="font-size:13px;color:var(--text-secondary);margin-top:4px">${owned} / ${MAX_LAND_CELLS} land plots owned (${gs}x${gs} grid)</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Each plot holds up to 9 buildings. Buy more land to grow your city!</div>`;
    c.appendChild(header);
    // Grid visualization
    const gridCvs=document.createElement('canvas');
    const gridVizSize=Math.min(200,canvasW-40);
    gridCvs.width=gridVizSize;gridCvs.height=gridVizSize;
    gridCvs.style.cssText=`display:block;margin:8px auto;border-radius:12px;background:#0f172a`;
    const gc=gridCvs.getContext('2d');
    const maxGs=getLandGridSize(MAX_LAND_CELLS);
    const vizCellSize=gridVizSize/maxGs;
    for(let r=0;r<maxGs;r++){
      for(let col=0;col<maxGs;col++){
        const cellIdx=r*maxGs+col;
        const cx=col*vizCellSize,cy=r*vizCellSize;
        if(cellIdx<owned){
          // Owned land
          const fillCount=state.cityGrid&&state.cityGrid[r]&&state.cityGrid[r][col]?state.cityGrid[r][col].length:0;
          const intensity=Math.min(1,fillCount/9);
          gc.fillStyle=`rgba(52,211,153,${0.2+intensity*0.6})`;
          gc.fillRect(cx+1,cy+1,vizCellSize-2,vizCellSize-2);
          if(fillCount>0){gc.fillStyle='#fff';gc.font=`bold ${Math.max(8,vizCellSize*.35)}px sans-serif`;gc.textAlign='center';gc.textBaseline='middle';gc.fillText(fillCount,cx+vizCellSize/2,cy+vizCellSize/2);}
        }else if(cellIdx<MAX_LAND_CELLS){
          // Available to buy
          gc.fillStyle='rgba(255,255,255,.05)';gc.fillRect(cx+1,cy+1,vizCellSize-2,vizCellSize-2);
        }
        gc.strokeStyle='rgba(255,255,255,.08)';gc.strokeRect(cx,cy,vizCellSize,vizCellSize);
      }
    }
    c.appendChild(gridCvs);
    // Buy button
    if(!maxed){
      const cost=getLandCost(owned);
      const can=state.cash>=cost;
      const d=document.createElement("div");
      d.className="shop-item"+(can?"":" cant-afford");
      d.style.cssText="margin:8px 0;border:2px solid var(--gold-glow)";
      d.innerHTML=`<div class="item-icon" style="font-size:24px">${ICONS.star}</div>
        <div class="item-info"><div class="item-name" style="color:var(--gold)">Buy Land Plot #${owned+1}</div>
        <div class="item-desc">Expand your city grid (${getLandGridSize(owned+1)}x${getLandGridSize(owned+1)} grid after)</div></div>
        <div class="item-right"><div class="item-cost" style="font-size:15px;font-weight:800">${fmt(cost)}</div></div>`;
      if(can)d.onclick=()=>buyLand();
      c.appendChild(d);
      // Show next few costs
      const preview=document.createElement("div");
      preview.style.cssText="padding:8px;font-size:11px;color:var(--text-muted)";
      let previewHtml="<div style='font-weight:700;margin-bottom:4px'>Upcoming land costs:</div>";
      for(let i=1;i<=Math.min(5,MAX_LAND_CELLS-owned);i++){
        const fc=getLandCost(owned+i-1);
        const fgs=getLandGridSize(owned+i);
        previewHtml+=`<div>Plot #${owned+i}: ${fmt(fc)} (${fgs}x${fgs} grid)</div>`;
      }
      preview.innerHTML=previewHtml;
      c.appendChild(preview);
    }else{
      const d=document.createElement("div");
      d.className="shop-item owned";
      d.innerHTML=`<div class="item-icon" style="font-size:24px">${ICONS.check}</div>
        <div class="item-info"><div class="item-name" style="color:var(--green)">All Land Owned!</div>
        <div class="item-desc">Your empire spans the maximum ${MAX_LAND_CELLS} plots (${gs}x${gs} grid)</div></div>`;
      c.appendChild(d);
    }
  }else if(currentShopTab==="licenses"){
    LICENSES.forEach((l,i)=>{
      const owned=state.licenses[i];
      const locked=i>0&&!state.licenses[i-1];
      const can=state.cash>=l.cost;
      const d=document.createElement("div");
      d.className="shop-item"+(owned?" owned":locked?" locked":can?"":" cant-afford");
      let statusHtml;
      if(owned) statusHtml=`<span class="item-status owned-s">${ICONS.check} Owned</span>`;
      else if(locked) statusHtml=`<span class="item-status locked-s">${ICONS.lock} Requires ${LICENSES[i-1].name}</span>`;
      else statusHtml=`<div class="item-cost">${fmt(l.cost)}</div>`;
      d.innerHTML=`<div class="item-icon license">${ICONS[LICENSE_ICONS[i]]}</div><div class="item-info"><div class="item-name">${l.name}</div><div class="item-desc">${l.multiplier}x all income</div></div><div class="item-right">${statusHtml}</div>`;
      if(!owned&&!locked&&can)d.onclick=()=>buyLicense(i);
      c.appendChild(d);
    });
  }else if(currentShopTab==="cosmetics"){
    // Building Decorations
    const sh1=document.createElement("div");sh1.style.cssText="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:12px 4px 6px";sh1.textContent="Building Decorations";c.appendChild(sh1);
    BUILDING_DECOR.forEach(item=>{
      const owned=!!state.cosmetics.buildingDecor[item.id];
      const can=state.cash>=item.cost;
      const d=document.createElement("div");
      d.className="shop-item"+(owned?" owned":can?"":" cant-afford");
      d.innerHTML=`<div class="item-icon cosmetic">${ICONS[PROPERTY_ICONS[item.tier]]}</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-desc">${item.desc} (${PROPERTIES[item.tier].name})</div></div><div class="item-right">${owned?'<span class="item-status owned-s">'+ICONS.check+' Owned</span>':'<div class="item-cost">'+fmt(item.cost)+'</div>'}</div>`;
      if(!owned&&can)d.onclick=()=>buyCosmetic('buildingDecor',item.id,item.cost);
      c.appendChild(d);
    });
    // Character Outfits
    const sh2=document.createElement("div");sh2.style.cssText="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:14px 4px 6px";sh2.textContent="Character Outfits";c.appendChild(sh2);
    CHAR_OUTFITS.forEach(item=>{
      const owned=!!state.cosmetics.characterOutfit[item.id];
      const can=state.cash>=item.cost;
      const d=document.createElement("div");
      d.className="shop-item"+(owned?" owned":can?"":" cant-afford");
      d.innerHTML=`<div class="item-icon cosmetic">${ICONS.star}</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-desc">${item.desc}</div></div><div class="item-right">${owned?'<span class="item-status owned-s">'+ICONS.check+' Owned</span>':'<div class="item-cost">'+fmt(item.cost)+'</div>'}</div>`;
      if(!owned&&can)d.onclick=()=>buyCosmetic('characterOutfit',item.id,item.cost);
      c.appendChild(d);
    });
    // City Decorations
    const sh3=document.createElement("div");sh3.style.cssText="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:14px 4px 6px";sh3.textContent="City Decorations";c.appendChild(sh3);
    CITY_DECOR.forEach(item=>{
      const owned=!!state.cosmetics.cityDecor[item.id];
      const can=state.cash>=item.cost;
      const d=document.createElement("div");
      d.className="shop-item"+(owned?" owned":can?"":" cant-afford");
      d.innerHTML=`<div class="item-icon cosmetic">${ICONS.star}</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-desc">${item.desc}</div></div><div class="item-right">${owned?'<span class="item-status owned-s">'+ICONS.check+' Owned</span>':'<div class="item-cost">'+fmt(item.cost)+'</div>'}</div>`;
      if(!owned&&can)d.onclick=()=>buyCosmetic('cityDecor',item.id,item.cost);
      c.appendChild(d);
    });
  }else if(currentShopTab==="managers"){
    MANAGERS.forEach((m,i)=>{
      const owned=state.managers[i];
      const can=state.cash>=m.cost;
      const d=document.createElement("div");
      d.className="shop-item"+(owned?" owned":can?"":" cant-afford");
      let statusHtml;
      if(owned) statusHtml=`<span class="item-status owned-s">${ICONS.check} Hired</span>`;
      else statusHtml=`<div class="item-cost">${fmt(m.cost)}</div>`;
      d.innerHTML=`<div class="item-icon license">${ICONS[MANAGER_ICONS[i]]}</div><div class="item-info"><div class="item-name">${m.name}</div><div class="item-desc">${m.desc} (+${m.autoClicksPerSec}/sec)</div></div><div class="item-right">${statusHtml}</div>`;
      if(!owned&&can)d.onclick=()=>buyManager(i);
      c.appendChild(d);
    });
    // Summary
    const acs=getAutoClicksPerSec();
    if(acs>0){
      const s=document.createElement("div");
      s.style.cssText="text-align:center;padding:12px;font-size:12px;color:var(--text-muted)";
      s.textContent="Total auto-clicks: "+acs+"/sec ("+fmt(getClickValue()*acs)+"/sec)";
      c.appendChild(s);
    }
  }else if(currentShopTab==="avatar"){
    renderAvatarConfigurator(c);
  }
}
let avatarConfigTab="hats";
let avatarSortMode="default";
function renderAvatarConfigurator(container){
  // Preview canvas
  const prevDiv=document.createElement("div");prevDiv.className="config-preview";
  const pvs=document.createElement("canvas");pvs.width=160;pvs.height=160;
  pvs.style.width="120px";pvs.style.height="120px";
  prevDiv.appendChild(pvs);
  const pvLabel=document.createElement("div");pvLabel.className="config-preview-label";pvLabel.textContent="Preview";prevDiv.appendChild(pvLabel);
  container.appendChild(prevDiv);
  // Draw preview mogul
  const pc=pvs.getContext("2d");
  pc.clearRect(0,0,160,160);
  drawMogulPreview(pc,80,95);
  // Category tabs
  const tabs=document.createElement("div");tabs.className="config-tabs";
  ["hats","suits","accessories","vehicles"].forEach(t=>{
    const b=document.createElement("button");b.className="config-tab"+(avatarConfigTab===t?" active":"");
    b.textContent=t.charAt(0).toUpperCase()+t.slice(1);
    b.onclick=()=>{avatarConfigTab=t;renderShop();};
    tabs.appendChild(b);
  });
  container.appendChild(tabs);
  // Sort
  const sortDiv=document.createElement("div");sortDiv.className="config-sort";
  const sel=document.createElement("select");
  [["default","Default"],["price-asc","Price: Low-High"],["price-desc","Price: High-Low"],["name","Name A-Z"],["owned","Owned First"]].forEach(([v,l])=>{
    const o=document.createElement("option");o.value=v;o.textContent=l;if(avatarSortMode===v)o.selected=true;sel.appendChild(o);
  });
  sel.onchange=()=>{avatarSortMode=sel.value;renderShop();};
  sortDiv.appendChild(sel);container.appendChild(sortDiv);
  // Item grid
  const grid=document.createElement("div");grid.className="config-grid";
  let items=[];
  const cos=state.cosmetics.characterOutfit;
  if(avatarConfigTab==="hats"){
    items=AVATAR_HATS.map(h=>({...h,category:"hat",owned:h.id==="topHat"||(h.id==="crown"?!!cos.crown:!!cos["hat_"+h.id]),equipped:getEquippedHat()===h.id}));
  }else if(avatarConfigTab==="suits"){
    items=AVATAR_SUITS.map(s=>({...s,category:"suit",owned:s.id==="classic"||(s.id==="whiteSuit"?!!cos.whiteSuit:!!cos["suit_"+s.id]),equipped:getEquippedSuit()===s.id}));
  }else if(avatarConfigTab==="accessories"){
    items=AVATAR_ACCESSORIES.map(a=>({...a,category:"accessory",owned:!!cos[a.id],equipped:!!cos[a.id]}));
  }else if(avatarConfigTab==="vehicles"){
    items=VEHICLE_SKINS.map(v=>({...v,category:"vehicleSkin",owned:v.id==="default"||!!cos["vskin_"+v.id],equipped:getEquippedVehicleSkin()===v.id}));
  }
  // Sort
  if(avatarSortMode==="price-asc")items.sort((a,b)=>a.cost-b.cost);
  else if(avatarSortMode==="price-desc")items.sort((a,b)=>b.cost-a.cost);
  else if(avatarSortMode==="name")items.sort((a,b)=>a.name.localeCompare(b.name));
  else if(avatarSortMode==="owned")items.sort((a,b)=>(b.owned?1:0)-(a.owned?1:0));
  items.forEach(item=>{
    const card=document.createElement("div");
    card.className="config-card"+(item.owned?" owned":"")+(item.equipped?" equipped":"");
    // Icon canvas
    const icv=document.createElement("canvas");icv.width=48;icv.height=48;icv.className="cc-icon";
    const ic=icv.getContext("2d");
    drawConfigIcon(ic,item,24,24);
    card.appendChild(icv);
    const nm=document.createElement("div");nm.className="cc-name";nm.textContent=item.name;card.appendChild(nm);
    if(item.equipped){
      const badge=document.createElement("div");badge.className="cc-equipped-badge";badge.textContent="E";card.appendChild(badge);
    }
    if(item.owned&&!item.equipped){
      const eq=document.createElement("div");eq.className="cc-owned";eq.textContent="OWNED";card.appendChild(eq);
      card.onclick=()=>{equipAvatar(item);renderShop();};
    }else if(!item.owned){
      if(item.cost>0){
        const cs=document.createElement("div");cs.className="cc-cost";cs.textContent=fmt(item.cost);card.appendChild(cs);
        if(state.cash>=item.cost){card.onclick=()=>{buyAvatarItem(item);renderShop();};}
        else{card.style.opacity="0.5";}
      }else{
        const eq=document.createElement("div");eq.className="cc-owned";eq.textContent="DEFAULT";card.appendChild(eq);
        card.onclick=()=>{equipAvatar(item);renderShop();};
      }
    }else if(item.equipped){
      const eq=document.createElement("div");eq.className="cc-owned";eq.textContent="EQUIPPED";card.appendChild(eq);
    }
    grid.appendChild(card);
  });
  container.appendChild(grid);
}
function getEquippedHat(){return state.cosmetics.characterOutfit._equippedHat||"topHat";}
function getEquippedSuit(){return state.cosmetics.characterOutfit._equippedSuit||"classic";}
function getEquippedVehicleSkin(){return state.cosmetics.characterOutfit._equippedVSkin||"default";}
function buyAvatarItem(item){
  if(state.cash<item.cost)return;
  state.cash-=item.cost;
  const cos=state.cosmetics.characterOutfit;
  if(item.category==="hat"){if(item.id==="crown")cos.crown=true;else cos["hat_"+item.id]=true;cos._equippedHat=item.id;}
  else if(item.category==="suit"){if(item.id==="whiteSuit")cos.whiteSuit=true;else cos["suit_"+item.id]=true;cos._equippedSuit=item.id;}
  else if(item.category==="accessory"){cos[item.id]=true;}
  else if(item.category==="vehicleSkin"){cos["vskin_"+item.id]=true;cos._equippedVSkin=item.id;}
  playSound('achieve');haptic(20);
  notify("Unlocked: "+item.name+"!");
  updateHUD();
}
function equipAvatar(item){
  const cos=state.cosmetics.characterOutfit;
  if(item.category==="hat"){cos._equippedHat=item.id;}
  else if(item.category==="suit"){cos._equippedSuit=item.id;}
  else if(item.category==="vehicleSkin"){cos._equippedVSkin=item.id;}
  // Accessories toggle
  else if(item.category==="accessory"){
    cos[item.id]=!cos[item.id];
  }
  haptic(10);
}
function drawMogulPreview(c,cx,cy){
  c.save();c.translate(cx,cy);
  const cos=state.cosmetics.characterOutfit;
  const hat=getEquippedHat();
  const suit=getEquippedSuit();
  const sc=1.4;c.scale(sc,sc);
  // Shadow
  c.fillStyle="rgba(0,0,0,.3)";c.beginPath();c.ellipse(0,24,14,5,0,0,Math.PI*2);c.fill();
  // Aura
  if(cos.aura){
    const t=performance.now()*.002;const hue=Math.floor(t*60)%360;
    c.fillStyle=`hsla(${hue},70%,60%,.15)`;c.beginPath();c.arc(0,-5,28,0,Math.PI*2);c.fill();
  }
  // Cape
  if(cos.cape){c.fillStyle="#8b0000";c.beginPath();c.moveTo(-6,-6);c.lineTo(-10,18);c.lineTo(10,18);c.lineTo(6,-6);c.closePath();c.fill();}
  // Shoes
  c.fillStyle="#1a1a1a";c.beginPath();c.ellipse(-4,22,4,2,0,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(4,22,4,2,0,0,Math.PI*2);c.fill();
  // Pants
  c.strokeStyle="#252540";c.lineWidth=4;c.lineCap="round";
  c.beginPath();c.moveTo(-1,8);c.lineTo(-4,20);c.stroke();c.beginPath();c.moveTo(1,8);c.lineTo(4,20);c.stroke();
  // Body
  let suitColor="#1a1a3a",lapelColor="#15152a";
  if(suit==="whiteSuit"||cos.whiteSuit){suitColor="#e8e8f0";lapelColor="#d0d0d8";}
  else if(suit==="goldSuit"){suitColor="#c49b20";lapelColor="#a68018";}
  else if(suit==="redVelvet"){suitColor="#8b1a1a";lapelColor="#6b1010";}
  else if(suit==="tuxedo"){suitColor="#0a0a1e";lapelColor="#000010";}
  c.fillStyle=suitColor;c.beginPath();c.moveTo(-8,-6);c.lineTo(-9,10);c.lineTo(9,10);c.lineTo(8,-6);c.closePath();c.fill();
  c.fillStyle=lapelColor;c.beginPath();c.moveTo(0,-6);c.lineTo(-4,4);c.lineTo(0,4);c.closePath();c.fill();
  c.beginPath();c.moveTo(0,-6);c.lineTo(4,4);c.lineTo(0,4);c.closePath();c.fill();
  // Rose
  if(cos.rose){c.fillStyle="#c41e3a";c.beginPath();c.arc(-5,-2,2,0,Math.PI*2);c.fill();c.fillStyle="#2a5a2a";c.fillRect(-5.5,0,1,3);}
  // Shirt + tie
  c.fillStyle="#e8e8f0";c.fillRect(-2,-4,4,8);
  c.fillStyle="#c41e3a";c.beginPath();c.moveTo(0,-4);c.lineTo(-2,0);c.lineTo(0,6);c.lineTo(2,0);c.closePath();c.fill();
  // Arms
  c.strokeStyle=suitColor;c.lineWidth=4;
  c.beginPath();c.moveTo(7,0);c.quadraticCurveTo(10,6,12,12);c.stroke();
  c.beginPath();c.moveTo(-7,0);c.quadraticCurveTo(-10,6,-12,12);c.stroke();
  // Hands
  c.fillStyle="#f0d0a8";c.beginPath();c.arc(12,12,2.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(-12,12,2.5,0,Math.PI*2);c.fill();
  // Watch
  if(cos.watch){c.fillStyle="#f0c040";c.fillRect(-13.5,10,3,2);c.fillStyle="#ffd700";c.beginPath();c.arc(-12,11,1.5,0,Math.PI*2);c.fill();}
  // Briefcase
  const caseColor=cos.goldCase?"#f0c040":"#6b3a1a";
  c.fillStyle=caseColor;c.beginPath();c.roundRect(7,14,10,7,2);c.fill();
  // Cigar
  if(cos.cigar){c.fillStyle="#8b6b3a";c.fillRect(6,-12,8,2.5);c.fillStyle="#ff6030";c.beginPath();c.arc(14,-11,1.5,0,Math.PI*2);c.fill();c.fillStyle="rgba(180,180,180,.3)";c.beginPath();c.arc(15,-14,3,0,Math.PI*2);c.fill();}
  // Neck + head
  c.fillStyle="#f0d0a8";c.fillRect(-3,-10,6,5);
  c.beginPath();c.arc(0,-15,9,0,Math.PI*2);c.fill();
  // Ears
  c.beginPath();c.arc(-9,-15,2.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(9,-15,2.5,0,Math.PI*2);c.fill();
  // Eyes
  c.fillStyle="#fff";c.beginPath();c.ellipse(3,-16,2.5,2,0,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(-3,-16,2.5,2,0,0,Math.PI*2);c.fill();
  c.fillStyle="#1a1a2e";c.beginPath();c.arc(3.5,-16,1.2,0,Math.PI*2);c.fill();c.beginPath();c.arc(-2.5,-16,1.2,0,Math.PI*2);c.fill();
  // Eyebrows
  c.strokeStyle="#2a2a3a";c.lineWidth=1.5;c.beginPath();c.moveTo(1,-19);c.lineTo(5.5,-18.5);c.stroke();c.beginPath();c.moveTo(-1,-19);c.lineTo(-5.5,-18.5);c.stroke();
  // Mustache
  c.fillStyle="#2a2a3a";c.beginPath();c.moveTo(-6,-12);c.quadraticCurveTo(-3,-10,0,-11);c.quadraticCurveTo(3,-10,6,-12);c.quadraticCurveTo(3,-11,0,-12.5);c.quadraticCurveTo(-3,-11,-6,-12);c.fill();
  // Smile
  c.strokeStyle="#c08080";c.lineWidth=1;c.beginPath();c.arc(0,-11,3,0.2,Math.PI-0.2);c.stroke();
  // Hat
  if(hat==="crown"||cos.crown){
    c.fillStyle="#f0c040";c.beginPath();c.moveTo(-8,-23);c.lineTo(-8,-32);c.lineTo(-4,-28);c.lineTo(0,-34);c.lineTo(4,-28);c.lineTo(8,-32);c.lineTo(8,-23);c.closePath();c.fill();
    c.fillStyle="#c41e3a";c.beginPath();c.arc(-4,-28,1.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(0,-30,1.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(4,-28,1.5,0,Math.PI*2);c.fill();
    c.fillStyle="#ffd700";c.fillRect(-8,-25,16,2.5);
  }else if(hat==="fedora"){
    c.fillStyle="#6b4226";c.beginPath();c.ellipse(0,-23,13,3,0,0,Math.PI*2);c.fill();
    c.fillStyle="#8b5a3a";c.beginPath();c.roundRect(-8,-32,16,10,3);c.fill();
    c.fillStyle="#1a1a1a";c.fillRect(-8,-25,16,1.5);
  }else if(hat==="baseballCap"){
    c.fillStyle="#2563eb";c.beginPath();c.arc(0,-22,9,Math.PI,0);c.fill();
    c.fillStyle="#1e40af";c.fillRect(-12,-22,24,3);
    c.fillStyle="#fff";c.font="bold 5px sans-serif";c.textAlign="center";c.fillText("M",0,-26);
  }else if(hat==="cowboyHat"){
    c.fillStyle="#a0764a";c.beginPath();c.ellipse(0,-22,15,3.5,0,0,Math.PI*2);c.fill();
    c.fillStyle="#c4956a";c.beginPath();c.moveTo(-6,-22);c.quadraticCurveTo(-3,-35,0,-33);c.quadraticCurveTo(3,-35,6,-22);c.lineTo(-6,-22);c.fill();
  }else if(hat==="wizardHat"){
    c.fillStyle="#3b1f8e";c.beginPath();c.ellipse(0,-22,11,3,0,0,Math.PI*2);c.fill();
    c.beginPath();c.moveTo(-9,-22);c.lineTo(0,-44);c.lineTo(9,-22);c.closePath();c.fill();
    c.fillStyle="#ffd700";c.beginPath();c.arc(-2,-32,1.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(3,-28,1,0,Math.PI*2);c.fill();c.beginPath();c.arc(0,-36,1.2,0,Math.PI*2);c.fill();
    c.fillStyle="#f0c040";c.fillRect(-9,-24,18,2);
  }else{
    // Default top hat
    c.fillStyle="#1a1a2e";c.beginPath();c.ellipse(0,-23,12,3,0,0,Math.PI*2);c.fill();
    c.fillStyle="#1a1a35";c.beginPath();c.roundRect(-7,-38,14,16,2);c.fill();
    c.fillStyle="#f0c040";c.fillRect(-7,-26,14,2.5);
    c.fillStyle="rgba(255,255,255,.08)";c.fillRect(-5,-36,4,12);
  }
  // Monocle
  if(cos.monocleSparkle){
    c.strokeStyle="#f0c040";c.lineWidth=1;c.beginPath();c.arc(4,-16,3.5,0,Math.PI*2);c.stroke();
    c.beginPath();c.moveTo(7,-14);c.lineTo(8,-8);c.stroke();
  }
  c.restore();
}
function drawConfigIcon(c,item,cx,cy){
  c.save();c.translate(cx,cy);
  if(item.category==="hat"){
    if(item.id==="crown"){c.fillStyle="#f0c040";c.beginPath();c.moveTo(-8,-4);c.lineTo(-8,-12);c.lineTo(-4,-8);c.lineTo(0,-14);c.lineTo(4,-8);c.lineTo(8,-12);c.lineTo(8,-4);c.closePath();c.fill();}
    else if(item.id==="topHat"){c.fillStyle="#1a1a2e";c.beginPath();c.ellipse(0,2,12,3,0,0,Math.PI*2);c.fill();c.fillStyle="#1a1a35";c.beginPath();c.roundRect(-6,-12,12,14,2);c.fill();c.fillStyle="#f0c040";c.fillRect(-6,-1,12,2);}
    else if(item.id==="fedora"){c.fillStyle="#6b4226";c.beginPath();c.ellipse(0,2,12,3,0,0,Math.PI*2);c.fill();c.fillStyle="#8b5a3a";c.beginPath();c.roundRect(-7,-8,14,10,3);c.fill();}
    else if(item.id==="baseballCap"){c.fillStyle="#2563eb";c.beginPath();c.arc(0,0,10,Math.PI,0);c.fill();c.fillStyle="#1e40af";c.fillRect(-12,0,24,3);}
    else if(item.id==="cowboyHat"){c.fillStyle="#a0764a";c.beginPath();c.ellipse(0,2,14,3.5,0,0,Math.PI*2);c.fill();c.fillStyle="#c4956a";c.beginPath();c.moveTo(-6,0);c.quadraticCurveTo(0,-14,6,0);c.fill();}
    else if(item.id==="wizardHat"){c.fillStyle="#3b1f8e";c.beginPath();c.moveTo(-10,6);c.lineTo(0,-16);c.lineTo(10,6);c.closePath();c.fill();c.fillStyle="#ffd700";c.beginPath();c.arc(0,-6,1.5,0,Math.PI*2);c.fill();}
  }else if(item.category==="suit"){
    const sc=item.id==="classic"?"#1a1a3a":item.id==="whiteSuit"?"#e8e8f0":item.id==="goldSuit"?"#c49b20":item.id==="redVelvet"?"#8b1a1a":"#0a0a1e";
    c.fillStyle=sc;c.beginPath();c.moveTo(-10,-10);c.lineTo(-12,12);c.lineTo(12,12);c.lineTo(10,-10);c.closePath();c.fill();
    c.fillStyle="#e8e8f0";c.fillRect(-2,-8,4,10);
    c.fillStyle="#c41e3a";c.beginPath();c.moveTo(0,-6);c.lineTo(-1.5,-2);c.lineTo(0,5);c.lineTo(1.5,-2);c.closePath();c.fill();
  }else if(item.category==="accessory"){
    if(item.id==="monocleSparkle"){c.strokeStyle="#f0c040";c.lineWidth=2;c.beginPath();c.arc(0,0,8,0,Math.PI*2);c.stroke();c.fillStyle="#ffd700";c.beginPath();c.arc(3,-3,2,0,Math.PI*2);c.fill();}
    else if(item.id==="goldCase"){c.fillStyle="#f0c040";c.beginPath();c.roundRect(-10,-6,20,12,3);c.fill();c.fillStyle="#ffd700";c.fillRect(-10,-6,20,2);c.fillStyle="#fff";c.fillRect(-2,-1,4,2);}
    else if(item.id==="cape"){c.fillStyle="#8b0000";c.beginPath();c.moveTo(-8,-10);c.lineTo(-12,10);c.lineTo(12,10);c.lineTo(8,-10);c.closePath();c.fill();}
    else if(item.id==="aura"){const g=c.createRadialGradient(0,0,2,0,0,14);g.addColorStop(0,"rgba(255,200,50,.5)");g.addColorStop(1,"rgba(100,50,255,0)");c.fillStyle=g;c.beginPath();c.arc(0,0,14,0,Math.PI*2);c.fill();}
    else if(item.id==="cigar"){c.fillStyle="#8b6b3a";c.fillRect(-8,-1.5,16,3);c.fillStyle="#ff6030";c.beginPath();c.arc(8,0,2,0,Math.PI*2);c.fill();}
    else if(item.id==="rose"){c.fillStyle="#c41e3a";c.beginPath();c.arc(0,-3,5,0,Math.PI*2);c.fill();c.fillStyle="#2a5a2a";c.fillRect(-1,2,2,8);}
    else if(item.id==="watch"){c.fillStyle="#f0c040";c.beginPath();c.arc(0,0,8,0,Math.PI*2);c.fill();c.fillStyle="#1a1a2e";c.beginPath();c.arc(0,0,6,0,Math.PI*2);c.fill();c.strokeStyle="#f0c040";c.lineWidth=1;c.beginPath();c.moveTo(0,0);c.lineTo(0,-4);c.moveTo(0,0);c.lineTo(3,0);c.stroke();}
  }else if(item.category==="vehicleSkin"){
    const vc=item.id==="gold"?"#f0c040":item.id==="racingStripes"?"#ef4444":item.id==="matteBlack"?"#1a1a1a":"#3b82f6";
    c.fillStyle=vc;c.beginPath();c.roundRect(-12,-6,24,12,4);c.fill();
    c.fillStyle="#111";c.beginPath();c.arc(-6,6,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(6,6,3,0,Math.PI*2);c.fill();
    if(item.id==="racingStripes"){c.fillStyle="#fff";c.fillRect(-10,-4,20,1.5);c.fillRect(-10,0,20,1.5);}
  }
  c.restore();
}
function buyManager(idx){
  if(state.managers[idx])return;
  if(state.cash<MANAGERS[idx].cost)return;
  state.cash-=MANAGERS[idx].cost;state.managers[idx]=true;
  playSound('achieve'); haptic(30);
  notify("Hired "+MANAGERS[idx].name+"! +"+MANAGERS[idx].autoClicksPerSec+" auto-clicks/sec");
  updateHUD(); renderShop();
}
function buyCosmetic(category,id,cost){
  if(state.cosmetics[category][id])return;
  if(state.cash<cost)return;
  state.cash-=cost;
  state.cosmetics[category][id]=true;
  invalidateBuildingCache();
  playSound('achieve');haptic(20);
  notify("Cosmetic unlocked!");
  updateHUD();renderShop();
}

// ═══════════════════════════════════════════════════════════════
// ACHIEVEMENTS
// ═══════════════════════════════════════════════════════════════
function checkAchievements(){
  ACHIEVEMENTS.forEach(ach=>{
    if(state.achievements[ach.id])return;
    if(ach.check(state)){
      state.achievements[ach.id]=true;
      if(ach.reward==="clickBonus")state.achievementClickBonus+=ach.amount;
      else if(ach.reward==="incomeBonus")state.achievementIncomeBonus+=ach.amount;
      else if(ach.reward==="multiplierBonus")state.achievementMultiplierBonus+=ach.amount;
      else if(ach.reward==="prestigeBonus")state.prestigeMultiplier+=ach.amount;
      addXP(500);
      playSound('achieve');haptic(25);
      notifyAchievement(ach.name,ach.desc);
    }
  });
}
function renderAchievements(c){
  const earned=ACHIEVEMENTS.filter(a=>state.achievements[a.id]);
  const locked=ACHIEVEMENTS.filter(a=>!state.achievements[a.id]);
  if(earned.length>0){
    const h=document.createElement("div");h.className="ach-section-title";
    h.textContent=`Earned (${earned.length}/${ACHIEVEMENTS.length})`;c.appendChild(h);
    earned.forEach(a=>{
      const d=document.createElement("div");d.className="ach-card earned";
      d.innerHTML=`<div class="ach-icon">${ICONS.trophy}</div><div class="ach-info"><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div></div>`;
      c.appendChild(d);
    });
  }
  if(locked.length>0){
    const h=document.createElement("div");h.className="ach-section-title";
    h.textContent="Locked";c.appendChild(h);
    locked.forEach(a=>{
      const d=document.createElement("div");d.className="ach-card locked-ach";
      d.innerHTML=`<div class="ach-icon">${ICONS.lock}</div><div class="ach-info"><div class="ach-name">???</div><div class="ach-desc">${a.desc}</div></div>`;
      c.appendChild(d);
    });
  }
}
function renderStatistics(c){
  const stats=[
    ["Total Cash Earned",fmt(state.totalCash)],
    ["Current Cash",fmt(state.cash)],
    ["Total Clicks",fmtNum(state.totalClicks)],
    ["Click Value",fmt(getClickValue())],
    ["Passive Income",fmt(getIncome())+"/s"],
    ["Multiplier",getEffectiveMultiplier().toFixed(1)+"x"],
    ["Vehicles Owned",state.vehicles.reduce((a,b)=>a+b,0).toString()],
    ["Properties Owned",state.properties.reduce((a,b)=>a+b,0).toString()],
    ["Licenses",state.licenses.filter(Boolean).length+"/"+LICENSES.length],
    ["Prestige Count",state.prestigeCount.toString()],
    ["Prestige Points",state.prestigePoints.toString()],
    ["Golden Briefcases",state.goldenCaught.toString()],
    ["Achievements",Object.keys(state.achievements).length+"/"+ACHIEVEMENTS.length],
    ["Grid Size",getGridSize()+"x"+getGridSize()],
    ["Tax Outclicks",(state.taxOutclicks||0).toString()],
    ["Random Events",(state.eventsExperienced||0).toString()],
  ];
  stats.forEach(([label,value])=>{
    const d=document.createElement("div");d.className="stat-row";
    d.innerHTML=`<span class="stat-row-label">${label}</span><span class="stat-row-value">${value}</span>`;
    c.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════════════════
// PRESTIGE
// ═══════════════════════════════════════════════════════════════
function showPrestigeModal(){
  const gain=getPrestigeGain();
  if(gain<=0)return;
  document.getElementById("prestige-gain-display").textContent="+"+gain+" pts";
  document.getElementById("prestige-detail").textContent=`New multiplier: ${(1+(state.prestigePoints+gain)*.1).toFixed(1)}x (currently ${state.prestigeMultiplier.toFixed(1)}x)`;
  document.getElementById("prestige-modal").classList.add("show");
}
function hidePrestigeModal(){ document.getElementById("prestige-modal").classList.remove("show"); }
function doPrestige(){
  const gain=getPrestigeGain();
  if(gain<=0)return;
  hidePrestigeModal();
  const isFirstPrestige=state.prestigeCount===0;
  // Prestige Power perk bonus
  const prestigeGainBonus=1+getPerkEffect('prestigeGain');
  const actualGain=Math.floor(gain*prestigeGainBonus);
  state.prestigePoints+=actualGain; state.prestigeCount++;
  // XP from prestige
  addXP(state.xpLevel*1000);
  // Phoenix Rebirth: retain 10% cash + vehicles
  const phoenixActive=(state.unlockedPerks['phoenixRebirth']||0)>=1;
  const savedCash=phoenixActive?state.cash*0.1:0;
  const savedVehicles=phoenixActive?[...state.vehicles]:null;
  state.prestigeMultiplier=1+state.prestigePoints*0.1;
  state.cash=0;state.totalCash=0;state.totalClicks=0;
  state.vehicles=VEHICLES.map(()=>0);state.properties=PROPERTIES.map(()=>0);
  state.licenses=LICENSES.map(()=>false);state.managers=MANAGERS.map(()=>false);
  state.multiplier=1;state.currentMilestone=0;state.mogul.targetIdx=0;
  state.taxInspector={active:false,x:0,y:0,targetX:0,targetY:0,speed:40,drainTimer:0,approaching:false,draining:false,tapped:false};
  state.randomEvent={active:false,name:'',effect:'',value:0,endsAt:0,color:''};
  state.nextDiscount=false;
  // Reset city grid, land, and managers
  state.landCells=1;
  state.cityGrid=null;initCityGrid(1);
  managerSprites=[];incomeFloats=[];
  document.getElementById('event-banner').style.display='none';
  invalidateBuildingCache();
  // Apply prestige perk start bonuses
  if(state.prestigePerks.startCash)state.cash=PRESTIGE_PERKS.find(p=>p.id==='startCash').value;
  if(state.prestigePerks.startSkateboard)state.vehicles[0]=1;
  if(state.prestigePerks.startCar)state.vehicles[3]=1;
  if(state.prestigePerks.autoClicker)state.managers[0]=true;
  // Phoenix Rebirth restore
  if(phoenixActive&&savedVehicles){state.cash+=savedCash;for(let i=0;i<savedVehicles.length;i++)state.vehicles[i]=Math.max(state.vehicles[i],savedVehicles[i]);}
  state.achievementClickBonus=0;state.achievementIncomeBonus=0;state.achievementMultiplierBonus=0;
  ACHIEVEMENTS.forEach(a=>{
    if(state.achievements[a.id]){
      if(a.reward==="clickBonus")state.achievementClickBonus+=a.amount;
      else if(a.reward==="incomeBonus")state.achievementIncomeBonus+=a.amount;
      else if(a.reward==="multiplierBonus")state.achievementMultiplierBonus+=a.amount;
    }
  });
  if(isFirstPrestige){
    celebrateFirstPrestige(actualGain);
  }else{
    const milestonePrestiges=[5,10,25,50,100];
    const isMilestone=milestonePrestiges.includes(state.prestigeCount);
    if(isMilestone){
      celebratePrestigeMilestone(actualGain);
    }else{
      playSound('prestige'); haptic(50);
      notify("Prestige! +"+actualGain+" points (Total: "+state.prestigePoints+")");
    }
  }
  updateRankDisplay();
  checkAchievements(); saveGame(); updateHUD();
  if(currentView==="shop")renderShop();
  if(currentView==="boosts")renderBoosts();
  if(currentView==="stats")renderStats();
}

// ═══════════════════════════════════════════════════════════════
// POWER-UPS
// ═══════════════════════════════════════════════════════════════
function activatePowerup(idx){
  const pu=POWERUPS[idx],ps=state.powerups[idx],now=Date.now()/1000,cost=getPowerupCost(idx);
  if(state.cash<cost||ps.active||now<ps.cooldownUntil)return;
  state.cash-=cost; ps.uses++;
  if(pu.instant){
    const bonus=getIncome()*60;
    state.cash+=bonus;state.totalCash+=bonus;
    notify("Tax Refund! +"+fmt(bonus));
    ps.cooldownUntil=now+pu.cooldown;
  }else{
    ps.active=true;ps.activeUntil=now+pu.duration;ps.cooldownUntil=now+pu.duration+pu.cooldown;
    state.clickMultBonus*=pu.clickMult;state.passiveMultBonus*=pu.passiveMult;
    notify(pu.name+" activated!");
    setTimeout(()=>{
      ps.active=false;state.clickMultBonus=1;state.passiveMultBonus=1;
      state.powerups.forEach((s,j)=>{if(s.active){state.clickMultBonus*=POWERUPS[j].clickMult;state.passiveMultBonus*=POWERUPS[j].passiveMult;}});
      if(currentView==="boosts")renderBoosts();
    },pu.duration*1000);
  }
  updateHUD();
  if(currentView==="boosts")renderBoosts();
}
function renderBoosts(){
  const c=document.getElementById("boost-items");
  c.innerHTML="";
  POWERUPS.forEach((pu,i)=>{
    const ps=state.powerups[i],now=Date.now()/1000,cost=getPowerupCost(i);
    const can=state.cash>=cost,onCd=now<ps.cooldownUntil&&!ps.active,active=ps.active;
    const d=document.createElement("div");
    d.className="boost-card"+(active?" active-boost":onCd?" cooldown":can?"":" cant-afford");
    let detail=fmt(cost);
    if(active)detail="Active "+Math.ceil(ps.activeUntil-now)+"s";
    else if(onCd)detail="Cooldown "+Math.ceil(ps.cooldownUntil-now)+"s";
    d.innerHTML=`<div class="boost-icon" style="background:${BOOST_COLORS[i]}">${ICONS[BOOST_ICONS[i]]}</div><div class="boost-name">${pu.name}</div><div class="boost-desc">${pu.desc}</div><div class="boost-cost">${detail}</div>`;
    if(active){
      const pct=((ps.activeUntil-now)/pu.duration)*100;
      d.innerHTML+=`<div class="boost-timer"><div class="boost-timer-fill" style="width:${pct}%"></div></div>`;
    }
    if(can&&!active&&!onCd)d.onclick=()=>activatePowerup(i);
    c.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════════════════
// GOLDEN BRIEFCASE
// ═══════════════════════════════════════════════════════════════
function spawnGoldenBriefcase(){
  if(state.goldenActive)return;
  state.goldenActive=true;
  const bc=document.createElement("div");
  bc.className="golden-briefcase";
  bc.innerHTML=ICONS.briefcase;
  bc.style.left=(60+Math.random()*(canvasW-160))+"px";
  bc.style.top=(80+Math.random()*(canvasH-200))+"px";
  document.body.appendChild(bc);
  bc.onclick=(e)=>{
    e.stopPropagation();
    const bonus=Math.max(getClickValue()*50,getIncome()*30,100);
    state.cash+=bonus;state.totalCash+=bonus;state.goldenCaught++;
    addXP(250);
    notify("Golden Briefcase! +"+fmt(bonus));
    spawnParticles(e.clientX,e.clientY,20,"#f0c040");
    bc.remove();state.goldenActive=false;
    checkAchievements();updateHUD();
  };
  setTimeout(()=>{if(bc.parentNode){bc.remove();state.goldenActive=false;}},15000);
}
function scheduleGoldenBriefcase(){
  let delay=60000+Math.random()*120000;
  if(state.randomEvent.active&&state.randomEvent.effect==='goldenHour')delay=delay/3;
  // Lucky Tycoon perk: 10%/lvl faster spawns
  delay*=Math.max(0.3,1-getPerkEffect('goldenSpeed'));
  goldenTimer=setTimeout(()=>{spawnGoldenBriefcase();scheduleGoldenBriefcase();},delay);
}

// ═══════════════════════════════════════════════════════════════
// HUD UPDATE
// ═══════════════════════════════════════════════════════════════
function updateHUD(){
  document.getElementById("s-cash").textContent=fmt(state.cash);
  document.getElementById("s-click").textContent=fmt(getClickValue());
  const acs=getAutoClicksPerSec();
  const totalIncome=getIncome()+getClickValue()*acs;
  document.getElementById("s-income").textContent=fmt(totalIncome)+"/s";
  document.getElementById("hud-mult").textContent=getEffectiveMultiplier().toFixed(1)+"x";
  const gain=getPrestigeGain();
  const chip=document.getElementById("prestige-chip");
  if(gain>0){chip.style.display="inline-block";chip.textContent="Prestige +"+gain;}
  else if(state.prestigePoints>0){chip.style.display="inline-block";chip.textContent="★"+state.prestigePoints;}
  else{chip.style.display="none";}
  updateRankDisplay();
  updateXPBar();
  updatePerkBadge();
  updateStaminaBar();
}

// ═══════════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════════
function switchView(view){
  currentView=view;
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.toggle("active",b.dataset.view===view));
  // Close all panels
  ["shop-panel","boosts-panel","stats-panel","settings-panel"].forEach(id=>document.getElementById(id).classList.remove("open"));
  document.getElementById("click-zone").style.pointerEvents=view==="game"?"auto":"none";
  if(view==="shop"){renderShop();document.getElementById("shop-panel").classList.add("open");}
  else if(view==="boosts"){renderBoosts();document.getElementById("boosts-panel").classList.add("open");}
  else if(view==="stats"){renderStats();document.getElementById("stats-panel").classList.add("open");}
  else if(view==="settings"){document.getElementById("settings-panel").classList.add("open");}
}

// Settings actions
function exportSave(){
  saveGame();
  try{
    const data=localStorage.getItem("mogul_runner_save");
    if(data){navigator.clipboard.writeText(data);notify("Save copied to clipboard!");}
  }catch(e){notify("Export failed");}
}
function importSave(){
  const raw=prompt("Paste save data:");
  if(!raw)return;
  try{JSON.parse(raw);localStorage.setItem("mogul_runner_save",raw);location.reload();}
  catch(e){notify("Invalid save data");}
}
function resetSave(){
  if(!confirm("Delete ALL progress? This cannot be undone!"))return;
  try{localStorage.removeItem("mogul_runner_save");}catch(e){}
  location.reload();
}

// Onboarding
const ONBOARD_STEPS=[
  {title:"Welcome, Mogul!",text:"Tap anywhere on the city to earn cash. The faster you tap, the faster your Monopoly man runs!"},
  {title:"Build Your Empire",text:"Open the Shop to buy vehicles (more cash per tap), properties (passive income), and licenses (multipliers). Hire managers to auto-click for you!"},
  {title:"Rise to the Top",text:"Unlock power-ups for temporary boosts. Catch golden briefcases for big rewards. When you're rich enough, Prestige to permanently multiply all earnings!"},
];
function showOnboarding(){
  onboardingStep=0;
  updateOnboarding();
  document.getElementById("onboarding").classList.add("show");
}
function updateOnboarding(){
  const s=ONBOARD_STEPS[onboardingStep];
  document.getElementById("ob-step").textContent=(onboardingStep+1)+" / "+ONBOARD_STEPS.length;
  document.getElementById("ob-title").textContent=s.title;
  document.getElementById("ob-text").textContent=s.text;
}
function nextOnboarding(){
  onboardingStep++;
  if(onboardingStep>=ONBOARD_STEPS.length){
    document.getElementById("onboarding").classList.remove("show");
    try{localStorage.setItem("mogul_onboarded","1");}catch(e){}
    return;
  }
  updateOnboarding();
}
function renderStats(){
  const c=document.getElementById("stats-content");
  c.innerHTML="";
  if(currentStatsTab==="achievements")renderAchievements(c);
  else if(currentStatsTab==="perks")renderPerkTree(c);
  else if(currentStatsTab==="prestige-shop")renderPrestigeShop(c);
  else renderStatistics(c);
}
function renderPerkTree(container){
  // Header with level + points
  const hdr=document.createElement('div');
  hdr.style.cssText='text-align:center;padding:12px;font-size:14px;font-weight:700;color:var(--purple)';
  hdr.textContent='Level '+state.xpLevel+' — '+state.perkPoints+' Perk Point'+(state.perkPoints!==1?'s':'');
  container.appendChild(hdr);
  const branches=[
    {key:'click',name:'Click Branch',color:'#ef4444',icon:'⚡'},
    {key:'passive',name:'Passive Branch',color:'#22c55e',icon:'💰'},
    {key:'strategy',name:'Strategy Branch',color:'#60a5fa',icon:'🎯'},
    {key:'special',name:'Special Perks',color:'#a78bfa',icon:'✨'},
  ];
  for(const branch of branches){
    const perks=XP_PERKS.filter(p=>p.branch===branch.key);
    if(perks.length===0)continue;
    const bh=document.createElement('div');bh.className='perk-branch-header';
    bh.innerHTML=`<div class="branch-dot" style="background:${branch.color}"></div><span class="branch-label" style="color:${branch.color}">${branch.name}</span>`;
    container.appendChild(bh);
    // Group by tier
    const tiers=[...new Set(perks.map(p=>p.tier))].sort((a,b)=>a-b);
    for(const tier of tiers){
      const tl=document.createElement('div');tl.className='perk-tier-label';
      tl.textContent='Tier '+tier+(tier===4?' (Ultimate)':'')+' — Lv.'+PERK_TIER_LEVEL_REQ[tier]+'+';
      container.appendChild(tl);
      perks.filter(p=>p.tier===tier).forEach(perk=>{
        const curLvl=state.unlockedPerks[perk.id]||0;
        const maxed=curLvl>=perk.maxLvl;
        const canDo=canUnlockPerk(perk.id);
        const isLocked=state.xpLevel<PERK_TIER_LEVEL_REQ[perk.tier]||(perk.prereq&&(state.unlockedPerks[perk.prereq]||0)<1);
        const card=document.createElement('div');
        card.className='perk-card'+(maxed?' maxed':curLvl>0?' unlocked':isLocked?' locked':'');
        const pipBg=curLvl>0?perk.color+'33':'rgba(255,255,255,.06)';
        const pipEmoji=perk.branch==='click'?'⚡':perk.branch==='passive'?'💰':perk.branch==='strategy'?'🎯':'✨';
        card.innerHTML=`
          <div class="perk-pip" style="background:${pipBg};color:${perk.color}">${pipEmoji}</div>
          <div class="perk-info">
            <div class="perk-name" style="${curLvl>0?'color:'+perk.color:''}">${perk.name}</div>
            <div class="perk-desc">${perk.desc}</div>
          </div>
          <div class="perk-right">
            <div class="perk-lvl">${curLvl}/${perk.maxLvl}</div>
            ${maxed?'<div class="perk-req" style="color:var(--gold)">MAX</div>':canDo?'<div class="perk-req" style="color:var(--green)">1 pt</div>':'<div class="perk-req">Lv.'+PERK_TIER_LEVEL_REQ[perk.tier]+(perk.prereq?' + '+XP_PERKS.find(p2=>p2.id===perk.prereq).name:'')+'</div>'}
          </div>`;
        if(canDo)card.onclick=()=>unlockPerk(perk.id);
        container.appendChild(card);
      });
    }
  }
  // Time Warp button
  if((state.unlockedPerks['timeWarp']||0)>=1){
    const twBtn=document.createElement('button');
    const twReady=Date.now()-state.timeWarpLastUse>86400000;
    twBtn.style.cssText='width:calc(100% - 28px);margin:12px 14px;padding:12px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#60a5fa,#a78bfa);color:#fff';
    if(!twReady){twBtn.style.opacity='.4';twBtn.style.cursor='default';}
    twBtn.textContent=twReady?'Activate Time Warp (5x income, 10x XP for 30s)':'Time Warp used today';
    if(twReady)twBtn.onclick=()=>{
      state.timeWarpLastUse=Date.now();
      state.passiveMultBonus*=5;
      notify('TIME WARP ACTIVE! 5x income for 30s');
      floatTexts.push({x:state.mogul.x,y:state.mogul.y-30,text:'TIME WARP!',color:'#60a5fa',size:24,life:2});
      setTimeout(()=>{state.passiveMultBonus/=5;notify('Time Warp ended');},30000);
      renderStats();
    };
    container.appendChild(twBtn);
  }
}
function renderPrestigeShop(c){
  // Header
  const h=document.createElement("div");
  h.style.cssText="text-align:center;padding:12px;font-size:14px;font-weight:700;color:var(--purple)";
  h.textContent="Prestige Points: "+state.prestigePoints;
  c.appendChild(h);
  if(state.prestigeCount===0){
    const p=document.createElement("div");
    p.style.cssText="text-align:center;padding:20px;font-size:12px;color:var(--text-muted)";
    p.textContent="Prestige at least once to earn points and unlock perks!";
    c.appendChild(p);
    return;
  }
  // Fixed perks section
  const sh1=document.createElement("div");sh1.className="pshop-section";sh1.textContent="Permanent Perks";c.appendChild(sh1);
  PRESTIGE_PERKS.forEach(perk=>{
    const bought=!!state.prestigePerks[perk.id];
    const canBuy=state.prestigePoints>=perk.cost&&!bought;
    const d=document.createElement("div");
    d.className="pshop-item"+(bought?" bought":canBuy?"":" cant-buy");
    d.innerHTML=`<div class="ach-icon">${ICONS.star}</div><div class="item-info"><div class="item-name">${perk.name}</div><div class="item-desc">${perk.desc}</div></div><div class="item-right">${bought?'<span class="item-status owned-s">Owned</span>':'<span class="pshop-cost">'+perk.cost+' pts</span>'}</div>`;
    if(canBuy)d.onclick=()=>buyPrestigePerk(perk.id);
    c.appendChild(d);
  });
  // Infinite scaling perks section
  const sh2=document.createElement("div");sh2.className="pshop-section";sh2.textContent="Infinite Upgrades";c.appendChild(sh2);
  INFINITE_PERKS.forEach((perk,idx)=>{
    const level=state.infinitePerkLevels[idx];
    const cost=getInfPerkCost(idx,level);
    const canBuy=state.prestigePoints>=cost;
    const d=document.createElement("div");
    d.className="pshop-item"+(canBuy?"":" cant-buy");
    const bonusTotal=perk.id==="infClick"?"+"+Math.floor(level*perk.bonusPer):"+"+(level*perk.bonusPer*100).toFixed(0)+"%";
    d.innerHTML=`<div class="ach-icon">${ICONS.trophy}</div><div class="item-info"><div class="item-name">${perk.name} <span class="mgr-badge">Lv.${level}</span></div><div class="item-desc">${perk.desc}</div><div class="inf-level">Current bonus: ${bonusTotal}</div></div><div class="item-right"><span class="pshop-cost">${cost} pts</span></div>`;
    if(canBuy)d.onclick=()=>buyInfinitePerk(idx);
    c.appendChild(d);
  });
}
function buyPrestigePerk(id){
  const perk=PRESTIGE_PERKS.find(p=>p.id===id);
  if(!perk||state.prestigePerks[id]||state.prestigePoints<perk.cost)return;
  state.prestigePoints-=perk.cost;
  state.prestigePerks[id]=true;
  // Apply permanent effects
  if(perk.effect==='prestigeMult')state.prestigeMultiplier+=perk.value;
  playSound('achieve');haptic(20);
  notify("Perk unlocked: "+perk.name);
  saveGame();updateHUD();renderStats();
}

// ═══════════════════════════════════════════════════════════════
// FIRST PRESTIGE CELEBRATION
// ═══════════════════════════════════════════════════════════════
function celebrateFirstPrestige(gain){
  playSound('fanfare'); haptic(80);
  // Gold flash
  const flash=document.getElementById("prestige-flash");
  flash.classList.add("show");
  // Celebration text
  const celeb=document.getElementById("celebration-text");
  celeb.classList.add("show");
  // Monocle sparkle particles at mogul position
  for(let i=0;i<30;i++){
    particles.push({x:state.mogul.x,y:state.mogul.y-15,vx:(Math.random()-.5)*12,vy:(Math.random()-.5)*12-4,life:.6+Math.random()*1,color:Math.random()>.5?"#f0c040":"#a78bfa",size:2+Math.random()*3});
  }
  // Dismiss after 3 seconds
  setTimeout(()=>{
    flash.classList.remove("show");
    celeb.classList.remove("show");
    notify("First Prestige! +"+gain+" points — You earned your monocle!");
  },3000);
}
function celebratePrestigeMilestone(gain){
  playSound('fanfare'); haptic(60);
  const count=state.prestigeCount;
  const rank=getMogulRank();
  // Scaled particles — more for higher milestones
  const pCount=15+count;
  const colors=count>=25?["#f0c040","#ff6b6b","#a78bfa"]:["#f0c040","#a78bfa"];
  for(let i=0;i<pCount;i++){
    particles.push({x:state.mogul.x,y:state.mogul.y-10,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10-3,life:.5+Math.random()*.8,color:colors[Math.floor(Math.random()*colors.length)],size:1.5+Math.random()*2.5});
  }
  // Show milestone banner with rank
  const b=document.getElementById("milestone-banner");
  document.getElementById("ms-title").textContent="Prestige #"+count+"!";
  document.getElementById("ms-desc").textContent="Rank: "+rank.title+" — +"+gain+" pts";
  b.classList.add("show");
  setTimeout(()=>b.classList.remove("show"),2500);
}

// ═══════════════════════════════════════════════════════════════
// DAILY LOGIN SYSTEM
// ═══════════════════════════════════════════════════════════════
function getDayNumber(){ return Math.floor(Date.now()/86400000); }
function checkDailyLogin(){
  const today=getDayNumber();
  if(state.lastDailyLogin===today){state.dailyClaimedToday=true;return;} // Already claimed
  // Check if streak continues (yesterday) or softly resets (-2 days per missed day)
  if(state.lastDailyLogin===today-1){
    state.dailyStreak=Math.min((state.dailyStreak%7)+1,7); // 1-7 cycling
  }else{
    const daysMissed=today-state.lastDailyLogin-1;
    const penalty=Math.min(daysMissed*2,state.dailyStreak);
    state.dailyStreak=Math.max(state.dailyStreak-penalty,1); // Soft reset: lose 2 days per miss, minimum day 1
  }
  state.dailyClaimedToday=false;
  // Show daily modal
  showDailyModal();
}
function showDailyModal(){
  const grid=document.getElementById("daily-grid");
  grid.innerHTML="";
  const dayIcons=["$","☕","$$","⚡","$$$","★","♦"];
  for(let i=0;i<7;i++){
    const cell=document.createElement("div");
    cell.className="daily-cell";
    if(i<state.dailyStreak-1)cell.classList.add("claimed");
    if(i===state.dailyStreak-1)cell.classList.add("today");
    cell.innerHTML=`<span class="day-num">Day ${i+1}</span><span class="day-icon">${dayIcons[i]}</span>`;
    grid.appendChild(cell);
  }
  document.getElementById("daily-streak").textContent="Day "+state.dailyStreak+" Streak";
  const reward=DAILY_REWARDS[state.dailyStreak-1];
  let rewardText="";
  if(reward.type==="cash")rewardText=fmt(getClickValue()*reward.mult)+" Cash!";
  else if(reward.type==="boost")rewardText=reward.desc+"!";
  else rewardText="+1 Prestige Point!";
  document.getElementById("daily-reward-text").textContent=rewardText;
  document.getElementById("daily-modal").classList.add("show");
}
function claimDailyReward(){
  const reward=DAILY_REWARDS[state.dailyStreak-1];
  if(reward.type==="cash"){
    const amount=getClickValue()*reward.mult;
    state.cash+=amount;state.totalCash+=amount;
    notify("Daily bonus: "+fmt(amount));
  }else if(reward.type==="boost"){
    // Activate a free power-up
    const boostIdx=state.dailyStreak===2?0:state.dailyStreak===4?1:2; // Coffee, Energy, Golden
    const pu=POWERUPS[boostIdx],ps=state.powerups[boostIdx];
    if(!ps.active){
      ps.active=true;ps.activeUntil=Date.now()/1000+pu.duration;ps.cooldownUntil=Date.now()/1000+pu.duration+pu.cooldown;
      state.clickMultBonus*=pu.clickMult;state.passiveMultBonus*=pu.passiveMult;
      setTimeout(()=>{
        ps.active=false;state.clickMultBonus=1;state.passiveMultBonus=1;
        state.powerups.forEach((s,j)=>{if(s.active){state.clickMultBonus*=POWERUPS[j].clickMult;state.passiveMultBonus*=POWERUPS[j].passiveMult;}});
      },pu.duration*1000);
    }
    notify("Daily bonus: "+reward.desc);
  }else if(reward.type==="prestige"){
    state.prestigePoints+=1;
    state.prestigeMultiplier=1+state.prestigePoints*0.1;
    notify("Daily bonus: +1 Prestige Point!");
  }
  state.lastDailyLogin=getDayNumber();
  state.dailyClaimedToday=true;
  playSound('daily');haptic(20);
  document.getElementById("daily-modal").classList.remove("show");
  saveGame();updateHUD();
}

// ═══════════════════════════════════════════════════════════════
// INFINITE PERK PURCHASE
// ═══════════════════════════════════════════════════════════════
function buyInfinitePerk(idx){
  const level=state.infinitePerkLevels[idx];
  const cost=getInfPerkCost(idx,level);
  if(state.prestigePoints<cost)return;
  state.prestigePoints-=cost;
  state.infinitePerkLevels[idx]++;
  playSound('buy');haptic(15);
  notify(INFINITE_PERKS[idx].name+" → Lv."+state.infinitePerkLevels[idx]);
  saveGame();updateHUD();renderStats();
}

// ═══════════════════════════════════════════════════════════════
// ECONOMY TICK
// ═══════════════════════════════════════════════════════════════
function economyTick(){
  if(document.hidden)return; // Don't tick when tab is hidden
  const income=getIncome();
  state.cash+=income;state.totalCash+=income;
  // Income pulse visual + $ particles
  if(income>0){
    const incEl=document.getElementById('s-income');
    incEl.style.textShadow='0 0 8px rgba(52,211,153,.6)';
    setTimeout(()=>{incEl.style.textShadow='none';},200);
    spawnIncomeParticles();
  }

  // Auto-clicks from managers
  const acs=getAutoClicksPerSec();
  if(acs>0){
    autoClickAccum+=acs;
    const wholeClicks=Math.floor(autoClickAccum);
    autoClickAccum-=wholeClicks;
    const autoValue=getClickValue()*wholeClicks;
    state.cash+=autoValue;state.totalCash+=autoValue;state.totalClicks+=wholeClicks;
  }

  // Passive XP per second
  if(income>0)addXP(Math.max(1,Math.floor(income/1000)));
  state.clicksThisSecond=0;
  checkAchievements();updateHUD();
  if(currentView==="boosts")renderBoosts();
  // Only re-render shop if panel isn't being scrolled
  if(currentView==="shop"){
    const scrollEl=document.getElementById("shop-items");
    if(!scrollEl._isScrolling)renderShop();
  }
  if(currentView==="stats"&&currentStatsTab==="statistics")renderStats();
  // Update spin wheel timer
  const spinBtn=document.getElementById('spin-btn');
  const spinTimer=document.getElementById('spin-timer');
  if(spinBtn&&spinTimer){
    const ready=canSpin();
    spinBtn.classList.toggle('ready',ready);
    spinTimer.textContent=getSpinCooldownText();
  }
}

// ═══════════════════════════════════════════════════════════════
// SAVE / LOAD
// ═══════════════════════════════════════════════════════════════
function saveGame(){
  try{
    const data={
      cash:state.cash,totalCash:state.totalCash,totalClicks:state.totalClicks,
      vehicles:state.vehicles,properties:state.properties,licenses:state.licenses,
      managers:state.managers,
      currentMilestone:state.currentMilestone,
      prestigePoints:state.prestigePoints,prestigeCount:state.prestigeCount,
      prestigeMultiplier:state.prestigeMultiplier,
      achievements:state.achievements,
      achievementClickBonus:state.achievementClickBonus,
      achievementIncomeBonus:state.achievementIncomeBonus,
      achievementMultiplierBonus:state.achievementMultiplierBonus,
      goldenCaught:state.goldenCaught,
      prestigePerks:state.prestigePerks,
      infinitePerkLevels:state.infinitePerkLevels,
      cosmetics:state.cosmetics,
      lastDailyLogin:state.lastDailyLogin,dailyStreak:state.dailyStreak,
      powerupUses:state.powerups.map(p=>p.uses),
      taxOutclicks:state.taxOutclicks||0,
      eventsExperienced:state.eventsExperienced||0,
      nextDiscount:state.nextDiscount||false,
      landCells:state.landCells||1,
      cityGrid:state.cityGrid,
      nextBuildingId:state.nextBuildingId||1,
      camera:state.camera,
      wheelLastSpin:state.wheelLastSpin||0,
      // XP system
      xp:state.xp, totalXP:state.totalXP, xpLevel:state.xpLevel,
      perkPoints:state.perkPoints, unlockedPerks:state.unlockedPerks,
      timeWarpLastUse:state.timeWarpLastUse||0,
      version:14,
      savedAt:Date.now(),
    };
    localStorage.setItem("mogul_runner_save",JSON.stringify(data));
  }catch(e){}
}
function loadGame(){
  const raw=localStorage.getItem("mogul_runner_save");
  if(!raw)return false;
  try{
    const d=JSON.parse(raw);
    state.cash=d.cash||0;state.totalCash=d.totalCash||0;state.totalClicks=d.totalClicks||0;
    state.vehicles=d.vehicles||VEHICLES.map(()=>0);
    state.properties=d.properties||PROPERTIES.map(()=>0);
    state.licenses=d.licenses||LICENSES.map(()=>false);
    state.managers=d.managers||MANAGERS.map(()=>false);
    state.currentMilestone=d.currentMilestone||0;
    state.prestigePoints=d.prestigePoints||0;state.prestigeCount=d.prestigeCount||0;
    state.prestigeMultiplier=d.prestigeMultiplier||1;
    state.achievements=d.achievements||{};
    state.achievementClickBonus=d.achievementClickBonus||0;
    state.achievementIncomeBonus=d.achievementIncomeBonus||0;
    state.achievementMultiplierBonus=d.achievementMultiplierBonus||0;
    state.goldenCaught=d.goldenCaught||0;
    state.prestigePerks=d.prestigePerks||{};
    state.infinitePerkLevels=d.infinitePerkLevels||INFINITE_PERKS.map(()=>0);
    if(d.cosmetics){state.cosmetics={buildingDecor:d.cosmetics.buildingDecor||{},characterOutfit:d.cosmetics.characterOutfit||{},cityDecor:d.cosmetics.cityDecor||{}};}
    state.lastDailyLogin=d.lastDailyLogin||0;state.dailyStreak=d.dailyStreak||0;
    if(d.powerupUses)d.powerupUses.forEach((u,i)=>{if(state.powerups[i])state.powerups[i].uses=u;});
    state.taxOutclicks=d.taxOutclicks||0;
    state.eventsExperienced=d.eventsExperienced||0;
    state.nextDiscount=d.nextDiscount||false;
    state.wheelLastSpin=d.wheelLastSpin||0;
    // XP system
    state.xp=d.xp||0;state.totalXP=d.totalXP||0;state.xpLevel=d.xpLevel||1;
    state.perkPoints=d.perkPoints||0;state.unlockedPerks=d.unlockedPerks||{};
    state.timeWarpLastUse=d.timeWarpLastUse||0;
    // Restore land cells (v14+ feature, migrate old saves)
    if(d.landCells){
      state.landCells=d.landCells;
    }else{
      // Migrate old saves: calculate land cells from existing grid
      const totalProps=state.properties.reduce((a,b)=>a+b,0);
      const neededCells=Math.max(1,Math.ceil(totalProps/9));
      state.landCells=Math.min(MAX_LAND_CELLS,Math.max(neededCells,d.cityGrid?d.cityGrid.length*d.cityGrid.length:1));
    }
    // Restore cityGrid or rebuild
    if(d.cityGrid){state.cityGrid=d.cityGrid;}else{state.cityGrid=null;}
    // Restore camera
    state.camera=d.camera||{x:0,y:0,zoom:1.0,targetZoom:1.0};
    if(!state.camera.targetZoom)state.camera.targetZoom=state.camera.zoom||1.0;
    // v13 migration: add level/id to old buildings (also applies to v14 migration from pre-13)
    if(!d.version||d.version<13){
      let nid=1;
      if(state.cityGrid){
        state.cityGrid.forEach(row=>row.forEach(cell=>{
          if(Array.isArray(cell))cell.forEach(b=>{
            if(!b.id)b.id=nid++;
            if(!b.level)b.level=1;
          });
        }));
      }
      state.nextBuildingId=nid;
    }else{
      state.nextBuildingId=d.nextBuildingId||1;
    }
    // Pad arrays for new tiers
    while(state.vehicles.length<VEHICLES.length)state.vehicles.push(0);
    while(state.properties.length<PROPERTIES.length)state.properties.push(0);
    while(state.licenses.length<LICENSES.length)state.licenses.push(false);
    while(state.managers.length<MANAGERS.length)state.managers.push(false);
    recalcMultiplier();
    // Apply prestige perk multipliers
    PRESTIGE_PERKS.forEach(p=>{
      if(state.prestigePerks[p.id]&&p.effect==='prestigeMult'){
        state.prestigeMultiplier+=p.value;
      }
    });
    if(d.savedAt){
      const offSec=Math.floor((Date.now()-d.savedAt)/1000);
      if(offSec>5){
        let offlineRate=state.prestigePerks.offlineRate?0.75:0.5;
        offlineRate+=state.infinitePerkLevels[2]*INFINITE_PERKS[2].bonusPer;
        offlineRate+=getPerkEffect('offlineBonus');
        offlineRate=Math.min(offlineRate,1);
        const offInc=getIncome()*Math.min(offSec,28800)*offlineRate;
        if(offInc>0){
          state.cash+=offInc;state.totalCash+=offInc;
          state._pendingWelcomeBack={offSec,offInc};
        }
      }
    }
    return true;
  }catch(e){return false;}
}

// ═══════════════════════════════════════════════════════════════
// MODAL SEQUENCE (Promise-based, replaces MutationObserver)
// ═══════════════════════════════════════════════════════════════
function showModalSequence(){
  let chain=Promise.resolve();
  // Step 1: Welcome-back modal (only if away > 5 min and has earnings)
  if(state._pendingWelcomeBack){
    const {offSec,offInc}=state._pendingWelcomeBack;
    delete state._pendingWelcomeBack;
    if(offSec>=300){ // Only show if away 5+ minutes
      chain=chain.then(()=>new Promise(resolve=>{
        setTimeout(()=>{
          document.getElementById("wb-time").textContent="You were away for "+formatTime(offSec);
          document.getElementById("wb-earnings").textContent=fmt(offInc);
          const wm=document.getElementById("welcome-modal");
          wm.classList.add("show");
          // Override the collect button to resolve the promise
          const btn=wm.querySelector(".btn-primary");
          const orig=btn.onclick;
          btn.onclick=()=>{wm.classList.remove("show");resolve();};
        },300);
      }));
    }
  }
  // Step 2: Daily login (after welcome-back dismissed, or immediately if no welcome-back)
  chain=chain.then(()=>{
    return new Promise(resolve=>{
      setTimeout(()=>{checkDailyLogin();resolve();},400);
    });
  });
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
function init(){
  canvas=document.getElementById("game-canvas");
  ctx=canvas.getContext("2d");
  if(!ctx){console.error("No canvas context");return;}
  clickZone=document.getElementById("click-zone");

  resizeCanvas();
  window.addEventListener("resize",resizeCanvas);

  const wps=getWaypoints(getGridSize());
  if(wps.length){state.mogul.x=wps[0].x;state.mogul.y=wps[0].y;}

  loadGame();
  // Initialize city grid if not loaded from save
  if(!state.cityGrid||state.cityGrid.length===0){
    const gs=getGridSize();
    initCityGrid(gs);
    // Rebuild from existing properties
    if(state.properties.reduce((a,b)=>a+b,0)>0)rebuildCityGrid();
  }
  // Initialize manager NPCs
  initManagerNPCs();

  // Click/touch + unlock audio on first interaction (iOS)
  const unlockAudio=()=>{initAudio();if(audioCtx&&audioCtx.state==='suspended')audioCtx.resume();document.removeEventListener('touchstart',unlockAudio);document.removeEventListener('click',unlockAudio);};
  document.addEventListener('touchstart',unlockAudio,{passive:true});
  document.addEventListener('click',unlockAudio);
  clickZone.addEventListener("click",handleClick);
  clickZone.addEventListener("touchstart",handleTouch,{passive:false});

  // Nav
  document.querySelectorAll(".nav-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      if(currentView===btn.dataset.view&&btn.dataset.view!=='game'){switchView('game');}
      else{switchView(btn.dataset.view);}
    });
  });

  // Shop tabs
  document.querySelectorAll("#shop-tabs .tab-btn").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("#shop-tabs .tab-btn").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      currentShopTab=tab.dataset.tab;
      document.getElementById("bulk-bar").style.display=(currentShopTab==="vehicles"||currentShopTab==="properties")?"flex":"none";
      renderShop();
    });
  });

  // Stats tabs
  document.querySelectorAll("#stats-tabs .tab-btn").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("#stats-tabs .tab-btn").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      currentStatsTab=tab.dataset.stab;
      renderStats();
    });
  });

  // Bulk buy
  document.querySelectorAll(".bulk-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".bulk-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const v=btn.dataset.qty;
      bulkQty=v==="max"?-1:parseInt(v);
      renderShop();
    });
  });

  // Swipe down to close panels
  let touchStartY=0;
  document.querySelectorAll(".panel-handle").forEach(handle=>{
    handle.addEventListener("touchstart",(e)=>{touchStartY=e.touches[0].clientY;},{passive:true});
    handle.addEventListener("touchend",(e)=>{
      const dy=e.changedTouches[0].clientY-touchStartY;
      if(dy>40)switchView("game");
    },{passive:true});
  });

  // Track shop scroll state to prevent re-render during scroll
  const shopScroll=document.getElementById("shop-items");
  let scrollTimeout;
  shopScroll.addEventListener("scroll",()=>{
    shopScroll._isScrolling=true;
    clearTimeout(scrollTimeout);
    scrollTimeout=setTimeout(()=>{shopScroll._isScrolling=false;},200);
  },{passive:true});

  // ── Wheel zoom ──
  canvas.addEventListener('wheel',(e)=>{
    e.preventDefault();
    const delta=e.deltaY>0?-ZOOM_STEP:ZOOM_STEP;
    zoomAtPoint(delta,e.clientX,e.clientY);
  },{passive:false});

  // ── Pinch zoom + pan ──
  let pinchDist=0,pinchActive=false,panActive=false,panStartX=0,panStartY=0,camStartX=0,camStartY=0;
  canvas.addEventListener('touchstart',(e)=>{
    if(e.touches.length===2){
      pinchActive=true;panActive=false;
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      pinchDist=Math.sqrt(dx*dx+dy*dy);
    }else if(e.touches.length===1&&!wheelState.active){
      panActive=true;pinchActive=false;
      panStartX=e.touches[0].clientX;panStartY=e.touches[0].clientY;
      camStartX=state.camera.x;camStartY=state.camera.y;
    }
  },{passive:true});
  canvas.addEventListener('touchmove',(e)=>{
    if(pinchActive&&e.touches.length===2){
      e.preventDefault();
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      const newDist=Math.sqrt(dx*dx+dy*dy);
      const scale=newDist/pinchDist;
      const midX=(e.touches[0].clientX+e.touches[1].clientX)/2;
      const midY=(e.touches[0].clientY+e.touches[1].clientY)/2;
      const delta=(scale-1)*0.5;
      zoomAtPoint(delta,midX,midY);
      pinchDist=newDist;
    }else if(panActive&&e.touches.length===1){
      const dx=e.touches[0].clientX-panStartX;
      const dy=e.touches[0].clientY-panStartY;
      state.camera.x=camStartX-dx/state.camera.zoom;
      state.camera.y=camStartY-dy/state.camera.zoom;
    }
  },{passive:false});
  canvas.addEventListener('touchend',(e)=>{
    if(e.touches.length<2)pinchActive=false;
    if(e.touches.length<1)panActive=false;
  },{passive:true});

  // ── Mouse drag to pan ──
  let mousePan=false,mousePanX=0,mousePanY=0,mouseCamX=0,mouseCamY=0;
  canvas.addEventListener('mousedown',(e)=>{
    if(e.button===1||e.button===2||(e.button===0&&e.shiftKey)){
      mousePan=true;mousePanX=e.clientX;mousePanY=e.clientY;
      mouseCamX=state.camera.x;mouseCamY=state.camera.y;
      e.preventDefault();
    }
  });
  canvas.addEventListener('mousemove',(e)=>{
    if(!mousePan)return;
    state.camera.x=mouseCamX-(e.clientX-mousePanX)/state.camera.zoom;
    state.camera.y=mouseCamY-(e.clientY-mousePanY)/state.camera.zoom;
  });
  canvas.addEventListener('mouseup',()=>{mousePan=false;});
  canvas.addEventListener('mouseleave',()=>{mousePan=false;});
  canvas.addEventListener('contextmenu',(e)=>e.preventDefault());

  loadSettings();
  updateRankDisplay();
  updateHUD();
  requestAnimationFrame(render);

  // Splash screen — dismiss on first tap, then start the game
  const splash=document.getElementById("splash");
  const dismissSplash=()=>{
    splash.classList.add("hide");
    setTimeout(()=>splash.remove(),600);
    splash.removeEventListener("click",dismissSplash);
    splash.removeEventListener("touchstart",dismissSplash);
    // After splash: onboarding OR modal chain
    try{
      if(!localStorage.getItem("mogul_onboarded"))showOnboarding();
    }catch(e){showOnboarding();}
    showModalSequence();
    setInterval(economyTick,1000);
    setInterval(saveGame,30000);
    scheduleGoldenBriefcase();
  };
  splash.addEventListener("click",dismissSplash);
  splash.addEventListener("touchstart",dismissSplash,{passive:true});
}

document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
